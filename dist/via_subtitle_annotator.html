<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <!--
        VGG Image Annotator (VIA)
        http://www.robots.ox.ac.uk/~vgg/software/via/

        Copyright (c) 2016-2019, Abhishek Dutta, Visual Geometry Group, Oxford University.
        All rights reserved.

        Redistribution and use in source and binary forms, with or without
        modification, are permitted provided that the following conditions are met:

        Redistributions of source code must retain the above copyright notice, this
        list of conditions and the following disclaimer.
        Redistributions in binary form must reproduce the above copyright notice,
        this list of conditions and the following disclaimer in the documentation
        and/or other materials provided with the distribution.
        THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
        AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
        IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
        ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
        LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
        CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
        SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
        INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
        CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
        ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
        POSSIBILITY OF SUCH DAMAGE.
      -->
    <title>VIA Subtitle Annotator</title>
    <meta name="author" content="Abhishek Dutta">
    <meta name="description" content="VGG Image Annotator (VIA) is a standalone manual annotator software for image, audio and video. The full application is packaged as an offline html page of size < 400KB and runs solely from a web browser. More details are available at: http://www.robots.ox.ac.uk/~vgg/software/via/">

    <!--
    Development of VIA is supported by the EPSRC programme grant
    Seebibyte: Visual Search for the Era of Big Data (EP/M013774/1).
    Using Google Analytics, we record the usage of this application.
    A summary of this data is used in reporting of this programme grant
    and research publications related to the VIA software.

    If you do not wish to share this data, you can safely remove the
    javascript code below.
      -->
    <script type="text/javascript">
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                               m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-20555581-2', 'auto');
      ga('set', 'page', '/via/3.0.0/via_subtitle_annotator.html');
      ga('send', 'pageview');
    </script>

<!-- START: Contents of file: via_subtitle_annotator.css-->
<style>
/*

CSS style definitions for VIA Subtitle Annotator

Author: Abhishek Dutta <adutta@robots.ox.ac.uk>
Date: 9 Oct. 2020
*/

html, body { margin:0; padding:0; box-sizing:border-box; font-family:Sans; font-size:1em; }

*, *:before, *:after { box-sizing:inherit; outline:none; }

.via_container { position:relative; display:grid; grid-template-rows:auto 1fr; grid-row-gap:0.5em; padding:0.3em; background-color:#ffffff; height:100vh; max-height:100vh; width:100vw; }

/* top control panel */
#via_control_panel_container { display:block; border:1px solid #707070; padding:0.4em 0.5em; }
/*#via_control_panel_container { display:block; border:1px solid #707070; padding:0.4em 0.5em; height:2.2em; overflow-y:hidden; }*/
#via_control_panel_container * { display:inline-block; margin:0 0.2em; outline:none; vertical-align:middle; }
#via_control_panel_container .spacer { padding:0 0.5em; }
#via_control_panel_container #region_info_panel { font-size:0.8em; }
#via_control_panel_container .logo { position:relative; display:inline-block; font-size:large; top:0px; }
#via_control_panel_container .logo a { text-decoration:none; }
#via_control_panel_container select { background-color:inherit; border:1px solid #cfcfcf; width:17.5em; }
#via_control_panel_container input { background-color:inherit; border:1px solid #cfcfcf; width:4em;}
#via_control_panel_container #via_project_name_input { display:inline-block; font-size:small; width:11.5em; border:none; border-bottom:1px solid #cfcfcf; }
#via_control_panel_container #via_project_name_input:hover { border-bottom:1px solid #cfcfcf; background-color:#f2f2f2; }
#via_control_panel_container #via_project_name_input:focus { background-color:#f2f2f2; border-bottom:1px solid #cfcfcf; }

/* View Container : video + temporal segmenter */
#view_container { display:grid; grid-row-gap:0.5em; } /* grid-template-rows is set dynamically */

/* view content: image, video, audio, image pair, etc. */
#view_container > .view_content_container { display:grid;  border:1px solid #cfcfcf;} /* grid-template-rows value set by _view_annotate_single_video(), video_annotate_single_image(), etc methods in _via_view_annotator.js */

#view_container > .view_content_container > #subtitle_editor { display:inline-block; position:relative; margin:0; padding:0; overflow-y:scroll; padding-left:10px; }
#view_container > .view_content_container > #subtitle_editor table { width:100%; border-collapse:collapse; }
#view_container > .view_content_container > #subtitle_editor table tr { cursor:pointer; color:#666666; }
#view_container > .view_content_container > #subtitle_editor table .sel_row { background-color:#cccccc; color:#000000; cursor:default; }
#view_container > .view_content_container > #subtitle_editor table td { padding:0.4em 0.3em; color:#666666; }
#view_container > .view_content_container > #subtitle_editor table td:nth-child(1) { width:3em; }
#view_container > .view_content_container > #subtitle_editor table td:nth-child(2) { width:10em; }
#view_container > .view_content_container > #subtitle_editor table td:nth-child(3) { width:10em; }
#view_container > .view_content_container > #subtitle_editor table td .hhmmss {font-size:x-large;}
#view_container > .view_content_container > #subtitle_editor table td .ms {margin-left:2px; font-size:medium;}
#view_container > .view_content_container > #subtitle_editor table td input[type="text"] { border:none; width:98%; padding:0; margin:0; font-size:medium; color:#666666; background:inherit; border-bottom:1px solid #424242;}
#view_container > .view_content_container > #subtitle_editor table td input[type="text"]:focus { color:black; border-bottom:1px solid black; }

#view_container > .view_content_container > .file_container { display:flex; position:relative; margin:0; padding:0; }
#view_container > .view_content_container > .file_container * { position:absolute; top:0; }
#view_container > .view_content_container > .file_container audio { height:3ch; width:90%; }
#view_container > .view_content_container > .file_container .rinput_enabled { }
#view_container > .view_content_container > .file_container > .metadata_container { display:inline-block; font-size:small; background-color:white; z-index:1001; }
#view_container > .view_content_container > .file_container > .metadata_container * { position:relative; vertical-align:middle; }
#view_container > .view_content_container > .file_container > .metadata_container table { position:relative; border-collapse:collapse; border:none; margin:0.2em; }
#view_container > .view_content_container > .file_container > .metadata_container td { vertical-align:middle; border:1px solid #cccccc; padding:0.4em 0.2em; }
#view_container > .view_content_container > .file_container > .metadata_container th { vertical-align:middle; border:1px solid #cccccc; padding:0.4em 0.2em; }
#view_container > .view_content_container > .file_container > .metadata_container input { font-size:small; }
#view_container > .view_content_container > .file_container > .metadata_container select { font-size:small; }

#view_container > .view_content_container > .file_container > .error_page { margin-left:1em; width:50em; }
#view_container > .view_content_container > .file_container > .error_page * { position:relative; }
#view_container > .view_content_container > .file_container > .error_page input { font-size:small; width:100%; }
#view_container > .view_content_container > .file_container > .error_page select { font-size:small; }
#view_container > .view_content_container > .file_container > .error_page textarea { font-size:small; }
#view_container > .view_content_container > .file_container > .error_page table { border-collapse:collapse; border:1px solid #cccccc;  width:40em;}
#view_container > .view_content_container > .file_container > .error_page td { padding:0.4em 1em; border:1px solid #cccccc; }


/* metadata associated with a view */
#view_container > .view_metadata_container {}

/* @todo: to annotate metadata for an image pair */
.img_pair_annotator_container { display:block; max-height:100%; font-size:x-large; }
.img_pair_annotator_container input[type="radio"] { margin-left:2em; }
.img_pair_annotator_container table { margin:1em auto; }
/*
to annotate temporal segments of a video: contains 4 rows
 - row1: vtimeline_mark (video timeline current time marker)
 - row2: vtimeline (video timeline with time gradations)
 - row3: tmetadata_container (temporal segmentation metadata container)
 - row4: toolbar for temporal segmentation
*/
.temporal_segmenter_container { display:grid; grid-template-rows:auto auto 1fr auto; margin:0; padding:0; position:relative; height:100%; max-height:100%; }
.temporal_segmenter_container > .tmetadata_container { display:grid; grid-template-rows:auto 1fr; height:100%; max-height:100%; }

.temporal_segmenter_container > .tmetadata_container .gtimeline_container { height:100%; margin:0; padding:0; }
.temporal_segmenter_container > .tmetadata_container .gtimeline_container canvas { display:block; }
/*@todo: height of gmetadata_container must be fixed (and not expandable) */
.temporal_segmenter_container > .tmetadata_container > .gmetadata_container { overflow-y:auto; }
.temporal_segmenter_container > .tmetadata_container .onecolgrid { display:grid; width:100%; grid-template-columns:1fr; }

.temporal_segmenter_container > .toolbar_container { font-size:small; vertical-align:middle; margin-top:0.2em;}
.temporal_segmenter_container > .toolbar_container * { vertical-align:middle; }
.temporal_segmenter_container > .toolbar_container div { display:inline; }
.temporal_segmenter_container > .toolbar_container div:nth-child(n+2) { margin:0 2em;}
.temporal_segmenter_container > .toolbar_container .newgid { width:10em; }
.temporal_segmenter_container > .toolbar_container input[type="text"] { vertical-align:middle; font-size:small; }
.temporal_segmenter_container > .toolbar_container button { font-size:small; padding:0 2px; margin:0 0.1em;}
.temporal_segmenter_container > .toolbar_container select { font-size:small; margin-right:0.4em; }

/* Editor panel for add/update/view metadata and attributes */
#editor_container { display:block; position:absolute; bottom:0; left:0; right:0; height:40vh; overflow:auto; background-color:#f2f2f2; border-top: 0.2em solid #e6e6e6; }
#editor_container svg { font-size:large; margin:0 0.4em; }
#editor_container > .editor_content_selector { display:block; margin:0; padding:0.4em 1em;  }
#editor_container > .toolbar { position:absolute; right:1em; top:0.5em; }
#editor_container > .content_container {display:inline-block; padding:0 1em; }
#editor_container > .content_container table { border-collapse:collapse; border:1px solid #cccccc; }
#editor_container > .content_container th { border:1px solid #cccccc; padding:0.3em 0.4em; }
#editor_container > .content_container td { border:1px solid #cccccc; padding:0.3em 0.4em; }
#editor_container > .content_container .attribute_entry { display:block; margin-bottom:0.4em; }
#editor_container > .content_container input[type="text"] { width:10em; }

/* Misc */
.svg_button { position:relative; width:24px; height:24px; top:2px; stroke:none; fill:#333333; stroke-width:2px; }
.svg_button_selected { fill:#000000; stroke:none; background-color:#e6e6e6;}
.svg_button:hover { opacity:0.6; cursor:pointer; }
.svg_button:active { cursor:pointer; }
.svg_icon { position:relative; width:24px; height:24px; top:2px; }
.disabled_button { fill:#cfcfcf !important; cursor:auto !important; }
.disabled_button:hover { fill:#cfcfcf !important; cursor:auto !important; }
.disabled_button:active { fill:#cfcfcf !important; cursor:auto !important; }
.text_button { border:none; color:blue; background-color:inherit; cursor:pointer; display:inline-block; }
.text_button:hover { color:black; }

/* info pages */
#via_page_container { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.7); z-index:9999; text-align:center; }
#via_page_container > .via_page { position:relative; display:inline-block; color:black; background-color:white; padding:1em 2em; overflow-y:auto; text-align:left; content:"close"; width:80ch; max-height:80vh; }
#via_page_container > .via_page > .toolbar { display:block; text-align:right; }
#via_page_container > .via_page > .controls { position:relative; display:block; text-align:center; margin-top:2em; padding-top:1em; border-top:1px solid #cccccc; }
#via_page_container > .via_page > .controls button { margin:0 1em; }
#via_page_container > .via_page table { border-collapse:collapse; border:1px solid #cccccc; }
#via_page_container > .via_page th { border:1px solid #cccccc; padding:0.3em 0.4em; }
#via_page_container > .via_page td { border:1px solid #cccccc; padding:0.3em 0.4em; }
#via_page_container > .via_page li { margin:1em 0; }

/* Message Panel */
#_via_message_container { display:none; width:100vw; position:fixed; bottom:0px; z-index:9999; text-align:center; }
#_via_message_container .message_panel_close_button { position:absolute; top:-0.4em; right:0.3em; color:white; cursor:pointer; font-size:small; }
#_via_message_container #_via_message { position:relative; display:inline; margin:auto; background-color:#000000; color:#ffff00; font-size:medium; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:2rem; padding: 0.5rem 2rem;}
.key { font-family:monospace; padding:1px 6px; background:linear-gradient(to bottom,#f0f0f0,#fcfcfc);; border:1px solid #e0e0e0; white-space:nowrap; color:#303030; border-bottom-width:2px; border-radius:3px; font-size:1.2em; }

/* View manager container in the top control panel */
#view_manager_container {  }
#view_manager_container .pname { border:none; border-bottom:1px solid white; width:10em; }
#view_manager_container .pname:hover { border:none; background-color: #f2f2f2; }
#view_manager_container .pname:focus { border-bottom:1px solid #cfcfcf; }
#view_manager_container .view_selector { margin:0 0.5em; width:18em; }
#view_manager_container .view_filter_regex { width:4em; }

/* VIA info pages */
#via_start_info { display:inline-block; width:80ch; margin-left:1em; }
#via_start_info li { margin:0.5em 0; }
#via_start_info input { font-size:small; width:26em; margin:0 1em; }
#via_start_info button { font-size:small; }

.hide { display:none !important; }
</style>
<!-- END: Contents of file: via_subtitle_annotator.css-->
<!-- START: Contents of file: mainstyles.css-->
<style>
/* * {margin:0;padding:0;} */
/* button{font-size:150%;text-align:center;display:block;} */
#change button{width:70px;border:none;background:#fff;}</style>
<!-- END: Contents of file: mainstyles.css-->
  </head>

  <body onresize="via._hook_on_browser_resize()">

    <!-- Definition of VIA Assets (e.g. about page, info page, shorcut keys, etc.) -->

    <!--
        SVG icons
        Icons prefixed with "micon_" are downloaded from https://material.io/icons
      -->
    <svg style="display:none;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>
        <symbol id="micon_subtitle">
          <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 12h4v2H4v-2zm10 6H4v-2h10v2zm6 0h-4v-2h4v2zm0-4H10v-2h10v2z"/>
        </symbol>
        <symbol id="micon_classes">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
        </symbol>

        <symbol id="micon_settings">
          <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path>
        </symbol>
        <symbol id="micon_save">
          <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"></path>
        </symbol>
        <symbol id="micon_open">
          <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"></path>
        </symbol>
        <symbol id="micon_upload">
          <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
        </symbol>
        <symbol id="micon_download">
          <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/>
        </symbol>
        <symbol id="micon_delete">
          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </symbol>
        <symbol id="micon_copy">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path>
        </symbol>
        <symbol id="micon_paste">
          <path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"></path>
        </symbol>
        <symbol id="micon_insertcomment">
          <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"></path>
        </symbol>
        <symbol id="micon_edit">
          <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
        </symbol>

        <!-- File Manager -->
        <symbol id="micon_lib_add">
          <path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9h-4v4h-2v-4H9V9h4V5h2v4h4v2z"/>
        </symbol>
        <symbol id="micon_add_circle">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
        </symbol>
        <symbol id="micon_remove_circle">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z"/>
        </symbol>
        <symbol id="micon_navigate_next">
          <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
        </symbol>
        <symbol id="micon_navigate_prev">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </symbol>
        <symbol id="micon_search">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </symbol>
        <!-- Import/Export -->
        <symbol id="micon_import">
          <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"></path>
        </symbol>
        <symbol id="micon_export">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path>
        </symbol>
        <symbol id="micon_import_export">
          <path d="M9 3L5 6.99h3V14h2V6.99h3L9 3zm7 14.01V10h-2v7.01h-3L15 21l4-3.99h-3z"/>
        </symbol>

        <!-- composed by Abhishek Dutta from existing materian icons, 31 Jan. 2019 -->
        <symbol id="micon_add_image">
          <path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3z"/>
          <path transform="translate(-9,-12) scale(1.8 1.8)" d="M5 19l3-4 2 3 3-4 4 5H5z"/>
        </symbol>
        <!-- composed by Abhishek Dutta from existing materian icons, 31 Jan. 2019 -->
        <symbol id="micon_add_media">
          <path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3z"/>
          <path transform="translate(-10,-7) scale(1.6 1.6)" d="M10 16.5l6-4.5-6-4.5v9z"/>
        </symbol>
        <!-- composed by Abhishek Dutta from existing materian icons, 31 Jan. 2019 -->
        <symbol id="micon_add_audio">
          <path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3z"/>
          <path transform="translate(-11,-4) scale(1.4 1.4)" d="M8 15c0-1.66 1.34-3 3-3 .35 0 .69.07 1 .18V6h5v2h-3v7.03c-.02 1.64-1.35 2.97-3 2.97-1.66 0-3-1.34-3-3z"/>
        </symbol>
        <!-- composed by Abhishek Dutta from existing materian icons, 13 May. 2019 -->
        <symbol id="micon_add_remote">
          <path d="M4.5 11h-2V9H1v6h1.5v-2.5h2V15H6V9H4.5v2zm2.5-.5h1.5V15H10v-4.5h1.5V9H7v1.5zm5.5 0H14V15h1.5v-4.5H17V9h-4.5v1.5zm9-1.5H18v6h1.5v-2h2c.8 0 1.5-.7 1.5-1.5v-1c0-.8-.7-1.5-1.5-1.5zm0 2.5h-2v-1h2v1z"/>
        </symbol>

        <symbol id="micon_share">
          <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
        </symbol>
        <!-- Video player controls -->
        <symbol id="micon_play">
          <path d="M8 5v14l11-7z"/>
        </symbol>
        <symbol id="micon_pause">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </symbol>
        <symbol id="micon_mark_start">
          <path d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z"/>
        </symbol>
        <symbol id="micon_mark_end">
          <path d="M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z"/>
        </symbol>

        <!-- Temporal Segments -->
        <symbol id="micon_add">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </symbol>

        <!-- Help -->
        <symbol id="micon_help">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
        </symbol>

        <symbol id="micon_import_export">
          <path d="M9 3L5 6.99h3V14h2V6.99h3L9 3zm7 14.01V10h-2v7.01h-3L15 21l4-3.99h-3z"/>
        </symbol>

        <!-- Restore -->
        <symbol id="micon_restore_load">
          <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm-2 16c-2.05 0-3.81-1.24-4.58-3h1.71c.63.9 1.68 1.5 2.87 1.5 1.93 0 3.5-1.57 3.5-3.5S13.93 9.5 12 9.5c-1.35 0-2.52.78-3.1 1.9l1.6 1.6h-4V9l1.3 1.3C8.69 8.92 10.23 8 12 8c2.76 0 5 2.24 5 5s-2.24 5-5 5z"/>
        </symbol>
        <symbol id="micon_restore_save">
          <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
        </symbol>
        <symbol id="micon_keyboard">
          <path d="M20 5H4c-1.1 0-1.99.9-1.99 2L2 17c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/>
        </symbol>
      </defs>
    </svg>

    <!-- VIA Information Pages -->
    <div id="via_page_container">
      <div data-pageid="page_import_export" class="via_page">
        <div class="toolbar"><span onclick="_via_util_page_hide()" class="text_button">&times;</span></div>
        <h2>Export</h2>
        <ul>
          <li>Select Export Format:
            <select id="via_page_export_format">
              <option value="webvtt" selected="selected">WebVTT</option>
              <option value="via3_csv">VIA3 (CSV)</option>
              <option value="temporal_segments_csv">Only Temporal Segments as CSV</option>
            </select>
          </li>
        </ul>
        <h2>Import</h2>
        <ul>
          <li>VIA Shared Project: <input id="via_page_import_pid" type="text" placeholder="e.g. 71578187-3cd3-45d0-8198-7c441fbc06af" style="width:25em;">
          </li>
          <li>VIA2 project created (json file):
            <input id="via_page_import_via2_project_json" type="file">
          </li>
        </ul>

        <div class="controls">
          <button id="via_page_button_import" onclick="_via_util_page_process_action(event)">Import</button>
          <button id="via_page_button_export" onclick="_via_util_page_process_action(event)">Export</button>
          <button onclick="_via_util_page_hide()">Cancel</button>
        </div>
      </div>

      <div data-pageid="page_fileuri_bulk_add" class="via_page">
        <div class="toolbar"><span onclick="_via_util_page_hide()" class="text_button">&times;</span></div>
        <p>File Type:&nbsp;<select id="via_page_fileuri_filetype">
          <option value="2">Image</option>
          <option value="4" selected>Video</option>
          <option value="8">Audio</option>
          <option value="0">Detect Automatically</option>
          </select>
        </p>
        <h2>Paste File URI (one URI per line)</h2>
        <textarea id="via_page_fileuri_urilist" placeholder="For example, (1) http://www.robots.ox.ac.uk/~vgg/software/via/images/via_logo.png ; (2) file:///data/images/img001.jpg ; (3) file:///C:/Documents%20and%20Settings/tlm/video001.mp4" rows="10" cols="80"></textarea>
        <h2>Import URI from a File</h2>
        <input id="via_page_fileuri_importfile" type="file">

        <div class="controls">
          <button id="via_page_fileuri_button_bulk_add" onclick="_via_util_page_process_action(event)">Add</button>
          <button onclick="_via_util_page_hide()">Cancel</button>
        </div>
      </div>

      <div data-pageid="page_share_not_shared_yet" class="via_page">
        <div class="toolbar"><span onclick="_via_util_page_hide()" class="text_button">&times;</span></div>
        <h2>Sharing this Project</h2>
        <p>This project has not been shared yet. If you want to share this project with others and allow them to contribute to this VIA project, click <svg class="svg_icon" viewbox="0 0 24 24"><use xlink:href="#micon_upload"></use></svg> button in the toolbar.</p>
        <h2>Loading a Shared Project</h2>
        <p>A unique project-id is assigned to every shared VIA project. You must have received such a unique project-id when someone asked you to contribute to a VIA project. Click <svg class="svg_icon" viewbox="0 0 24 24"><use xlink:href="#micon_download"></use></svg> button in the toolbar to open a shared project.</p>
        <p>If you do not have access to a shared project-id and you can explore the following publicly shared demonstration projects:
          <ul>
            <li>Video Annotation: e302eadf-aa53-4a5a-b958-11175692c928</li>
            <li>Audio Annotation: d4a9bc87-9652-42c3-a336-f41e18d638e6</li>
          </ul>
        </p>

        <div class="controls">
          <button onclick="_via_util_page_hide()">Close</button>
        </div>
      </div>

      <div data-pageid="page_share_already_shared" class="via_page">
        <div class="toolbar"><span onclick="_via_util_page_hide()" class="text_button">&times;</span></div>
        <h3>Information about this shared project</h3>
        <p id="via_page_share_project_info"></p>
        <h3>How can others contribute to this project?</h3>
        <p>This project has already been shared and therefore anyone can contribute to this project. To contribute to this project, other users should to follow these steps:
          <ol>
            <li>Open the VIA application (version 3.0.3 or higher) in a web browser.</li>
            <li>Click <svg class="svg_icon" onclick="" viewbox="0 0 24 24"><use xlink:href="#micon_download"></use><title>Share this project and your updates with others</title></svg> button in the top toolbar.</li>
            <li>Enter the following project-id: <span id="via_page_share_project_id"></span></li>
            <li>Make changes to the project and click <svg class="svg_icon" viewbox="0 0 24 24"><use xlink:href="#micon_upload"></use></svg> to share your updates with others.</li>
          </ol>
        </p>
        <h3>Important Notes</h3>
        <ul>
          <li>Do not store private or confidential information in a shared VIA project. Furthermore, be careful when you share your project-id with others as it allows them to make any changes to your project.</li>
          <li>The VIA servers do not maintain backup copy of the shared VIA projects. In the event of disk failure, all data will be lost. So, we strongly advise you to always keep a local copy of your project data.</li>
          <li>We <strong>cannot guarantee</strong> 24/7 availability of VIA project share servers. In the event of hardware or disk failure, the VIA project share servers will be offline for an extended period of time.</li>
          <li>This VIA share feature should <strong>not</strong> be used for large scale collaborative annotation projects. For such use cases, we advise you to <a href="https://gitlab.com/vgg/vps">setup a dedicated server</a> with sufficient backup and secutiry.</li>
          <li>The shared VIA project should not exceed 1MB in size.</li>
        </ul>
        <div class="controls">
          <button onclick="_via_util_page_hide()">Close</button>
        </div>
      </div>

      <div data-pageid="page_share_open_shared" class="via_page">
        <div class="toolbar"><span onclick="_via_util_page_hide()" class="text_button">&times;</span></div>
        <h2>Open a Shared VIA Project</h2>
        <p>A unique project-id is assigned to every shared VIA project. For example, the following two project-id have been publicly shared for demonstration purposes:
          <ul>
            <li>Video Annotation: e302eadf-aa53-4a5a-b958-11175692c928</li>
            <li>Audio Annotation: d4a9bc87-9652-42c3-a336-f41e18d638e6</li>
          </ul>
        </p>
        <p>To open a shared project, enter the project-id below:</p>
        <table>
          <tr>
            <td><label for="via_page_input_pid">VIA Project Id</label></td>
            <td>
              <input style="width:25em;" type="text" placeholder="e.g. e302eadf-aa53-4a5a-b958-11175692c928" id="via_page_input_pid">
            </td>
          </tr>
        </table>

        <div class="controls">
          <button id="via_page_button_open_shared" onclick="_via_util_page_process_action(event)">Open Shared Project</button>
          <button onclick="_via_util_page_hide()">Cancel</button>
        </div>
      </div>

      <div data-pageid="page_demo_instructions" class="via_page">
        <div class="toolbar"><span onclick="_via_util_page_hide()" class="text_button">&times;</span></div>
        <h1>Some Quick Tips</h1>
        <ul>
          <li>Press <span class="key">Space</span> key at any time to play or pause the video.</li>
          <li>Use your mouse wheel to move the timeline towards right or left.</li>
          <li>Click on temporal segments to select it and then drag around to move it. To resize, click on the edges and drag.</li>
          <li>When you resize or move a segment, the edges snap to nearest temporal segments or the last paused video time (shown as gray vertical line).</li>
        </ul>
      </div>

      <div data-pageid="page_keyboard_shortcut" class="via_page">
        <div class="toolbar"><span onclick="_via_util_page_hide()" class="text_button">&times;</span></div>
        <h1>Keyboard Shortcuts</h1>
        <h3>General</h3>
        <table>
          <thead>
            <tr>
              <th>Command</th>
              <th>Shortcut</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Play/Pause Media</td><td><span class="key">Space</span></td></tr>
            <tr><td>Toggle Media Mute</td><td><span class="key">m</span></td></tr>
            <tr><td>Increase / Decrease Media Playback Speed</td><td><span class="key">+</span> / <span class="key">-</span></td></tr>
            <tr><td>Move Media Time Backward by 1, ..., 9 sec. (Ctrl to move forward)</td><td><span class="key">Ctrl</span> + <span class="key">1</span>, <span class="key">2</span>, ..., <span class="key">9</span</td></tr>
            <tr><td>Move Media Time Forward or Backward by 1 frame (Shift to move by 5 frames)</td><td><span class="key">Shift</span> + <span class="key">n</span> / <span class="key">p</span></td></tr>                                      <tr><td>Add Temporal Segment at Current Time</td><td><span class="key">a</span></td></tr>
            <tr><td>Update the edge (left or right) of last added segment to current time</td><td><span class="key">Shift</span> + <span class="key">a</span></td></tr>

            <tr><td>Select Previous / Next Temporal Segment Timeline</td><td><span class="key">&uarr;</span> / <span class="key">&darr;</span></td></tr>

            <tr><td>Select [Previous] Next Temporal Segment (e.g. 3sec to 5sec)</td><td><span class="key">Shift</span> + <span class="key">Tab</span></td></tr>
            <tr><td>Select Temporal Segment at Current Time (if any)</td><td><span class="key">Enter</span></td></tr>

            <tr><td>Move to Previous / Next Video Frame</td><td><span class="key">l</span> / <span class="key">r</span></td></tr>
            <tr><td>Jump to Start/End of Video</td><td><span class="key">Shift</span> + <span class="key">s</span> / <span class="key">e</span></td></tr>
            <tr><td>Shift Visible Timeline by 1 sec.</td><td><span class="key">&larr;</span> / <span class="key">&rarr;</span></td></tr>
            <tr><td>Shift Visible Timeline by 60 sec.</td><td><span class="key">Shift</span> + <span class="key">&larr;</span> / <span class="key">&rarr;</span></td></tr>
            <tr><td>Pan the Temporal Segment Timeline Horizontally</td><td>Mouse Wheel<br/></td></tr>
            <tr><td>Zoom In/Out the Temporal Segment Timeline</td><td><span class="key">Shift</span> + Mouse Wheel</td></tr>
          </tbody>
        </table>
        <h3>When a Temporal Segment is Selected</h3>
        <table>
          <thead>
            <tr>
              <th>Command</th>
              <th>Shortcut</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Play/Pause Video Locked to Segment Boundary</td><td><span class="key">Spc</span></td></tr>
            <tr><td>Delete Selected Temporal Segment</td><td><span class="key">Backspace</span></td></tr>
            <tr><td>Select [Previous] Next Temporal Segment</td><td>[<span class="key">Shift</span>] + <span class="key">Tab</span></td></tr>
            <tr><td>Unselect Temporal Segment</td><td><span class="key">Esc</span></td></tr>
            <tr><td>Increase/Decrease the Extent of Left Edge (Ctrl updates by 1 sec.)</td><td>[<span class="key">Ctrl</span>] + <span class="key">l</span> / <span class="key">L</span></td></tr>
            <tr><td>Increase/Decrease the Extent of Right edge (Ctrl updates by 1 sec.)</td><td>[<span class="key">Ctrl</span>] + <span class="key">r</span> / <span class="key">R</span></td></tr>

            <tr><td>Jump to Start/End of Temporal Segment</td><td><span class="key">s</span> / <span class="key">e</span></td></tr>
            <tr><td>Move Selected Temporal Segment (Ctrl updates by 1 sec.)</td><td>[<span class="key">Ctrl</span>] + <span class="key">&larr;</span> / <span class="key">&rarr;</span></td></tr>
            <tr><td>Merge Selected Temporal Segment with the Segment on Left/Right</td><td><span class="key">Shift</span> + <span class="key">&larr;</span> / <span class="key">&rarr;</span></td></tr>
            <tr><td>Split temporal segment at current playback position</td><td><span class="key">x</span></td></tr>
          </tbody>
        </table>

        <h3>Spatial Regions in an Image or a Video Frame</h3>
        <table>
          <thead>
            <tr>
              <th>Command</th>
              <th>Shortcut</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Select All Regions</td><td><span class="key">Ctrl</span> + a</td></tr>
            <tr><td>Delete Selected Regions</td><td><span class="key">Backspace</span> or <span class="key">Delete</span></td></tr>
          </tbody>
        </table>

        <p>&nbsp;</p>
      </div>

      <div data-pageid="page_about" class="via_page">
        <div class="toolbar"><span onclick="_via_util_page_hide()" class="text_button">&times;</span></div>
        <h2>VGG Image Annotator (VIA)</h2>
        <p>Version: <a href="https://gitlab.com/vgg/via/blob/master/CHANGELOG">__VIA_VERSION__</a></p>
        <p>VGG Image Annotator (VIA) is a simple and standalone manual annotation tool
          for image, audio and video. The VIA software is a light weight, standalone
          and offline software package that does not require any installation or setup
          and runs solely in a web browser. The complete VIA software fits in a single
          self-contained HTML page of size less than 500 kilobyte that runs as an
          offline application in most modern web browsers. VIA software is an open
          source project created solely using HTML, Javascript and CSS. More details
          about VIA is available from <a href="http://www.robots.ox.ac.uk/~vgg/software/via">http://www.robots.ox.ac.uk/~vgg/software/via</a>.</p>
        <h4>Open Source Ecosystem</h4>
        <p>We have nurtured a large and thriving open source community which not only
          provides feedback but also contributes code to add new features and improve
          existing features in the VIA software. The open source ecosystem of VIA
          thrives around its <a href="https://gitlab.com/vgg/via">source code repository</a>
          hosted by the Gitlab platform. Most of our users report issues and request
          new features for future releases using the
          <a href="https://gitlab.com/vgg/via/issues">issue portal</a>. Many of our
          users not only submit bug reports but also suggest a potential fix for
          these software issues. Some of our users also contribute code to add new
          features to the VIA software using the
          <a href="https://gitlab.com/vgg/via/merge_requests">merge request</a> portal.
          A list of our contributors is available
          <a href="https://gitlab.com/vgg/via/blob/master/Contributors.md">here</a>.</p>

        <p>Thanks to the flexibility provided by our BSD open source software
          <a href="https://gitlab.com/vgg/via/blob/master/LICENSE">license</a>, many
          industrial projects have adapted the VIA software for internal or commercial use.</p>

        <h4>License</h4>
        <pre>
Copyright (c) 2019, Abhishek Dutta, Visual Geometry Group, Oxford University and VIA Contributors.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.
Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.
        </pre>
        <p>Copyright &copy; 2019, <a href="mailto:adutta-removeme@robots.ox.ac.uk">Abhishek Dutta</a>, Visual Geometry Group, Oxford University and VIA Contributors.</p>
      </div>
    </div> <!-- end of page container -->

    <!-- used by _via_view_annotator._show_start_info() -->
    <div id="via_start_info_content" class="hide">
      <ul>
        <li>To load a shared project, click <svg class="svg_icon" viewbox="0 0 24 24"><use xlink:href="#micon_download"></use></svg> in the toolbar.</li>
      </ul>
    </div>

    <!-- VIA dynamically populates this container with control panel, media (image, video, etc), etc. -->
    <div class="via_container" id="via_container"></div>

<!-- START: Contents of file: ../../src/js/_via_util.js-->
<script>
/**
 * Utilities used by VIA default user interface
 *
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 31 Dec. 2018
 *
 */

'use strict'

var _via_msg_clear_timer; // holds a reference to current message timoout
var _via_page_current;    // holds a reference to current info page
var _via_page_action_map; // holds a reference to action map for current info page

function _via_util_get_svg_button(icon_id, title, id) {
  var el = document.createElementNS(_VIA_SVG_NS, 'svg');
  el.setAttributeNS(null, 'viewBox', '0 0 24 24');
  el.innerHTML = '<use xlink:href="#' + icon_id + '"></use><title>' + title + '</title>';
  el.setAttributeNS(null, 'class', 'svg_button');
  if ( typeof(id) !== 'undefined' ) {
    el.setAttributeNS(null, 'id', id);
  }
  return el;
}

function _via_util_get_html_input_element_value(el) {
  switch(el.tagName) {
  case 'TEXTAREA':
    return el.value;

  case 'SELECT':
    return el.options[el.selectedIndex].value;

  case 'INPUT':
    return el.value;
  }
}

function _via_util_get_filename_from_uri(uri) {
  if ( uri.includes('/') ) {
    var tokens = uri.split('/');
    return tokens[ tokens.length - 1 ];
  } else {
    return uri;
  }
}

function _via_util_file_type_to_str(type) {
  switch(type) {
    case _VIA_FILE_TYPE.IMAGE:
      return 'image';
      break;
    case _VIA_FILE_TYPE.VIDEO:
      return 'video';
      break;
    case _VIA_FILE_TYPE.AUDIO:
      return 'audio';
      break;
    default:
      return 'unknown ' + type;
  }
}

function _via_util_file_type_str_to_id(type) {
  switch(type) {
    case 'image':
      return _VIA_FILE_TYPE.IMAGE;
      break;
    case 'video':
      return _VIA_FILE_TYPE.VIDEO;
      break;
    case 'audio':
      return _VIA_FILE_TYPE.AUDIO;
      break;
    default:
      return -1;
  }
}

function _via_util_file_loc_to_str(loc) {
  switch(loc) {
    case _VIA_FILE_TYPE.LOCAL:
      return 'local';
      break;
    case _VIA_FILE_TYPE.URIHTTP:
      return 'http://';
      break;
    case _VIA_FILE_TYPE.URIFILE:
      return 'file://';
      break;
    case _VIA_FILE_TYPE.URIFILE:
      return 'inline';
      break;
    default:
      return 'unknown-type-id=' + type.toString();
  }
}

function _via_util_file_loc_str_to_id(loc) {
  switch(loc) {
    case 'local':
      return _VIA_FILE_TYPE.LOCAL;
      break;
    case 'http://':
      return _VIA_FILE_TYPE.URIHTTP;
      break;
    case 'file://':
      return _VIA_FILE_TYPE.URIFILE;
      break;
    case 'inline':
      return _VIA_FILE_TYPE.URIFILE;
      break;
    default:
      return -1;
  }
}


function _via_util_metadata_shape_str(shape_id) {
  switch(shape_id) {
    case _VIA_WHERE_SHAPE.TIME:
      return 'time';
      break;
    case _VIA_WHERE_SHAPE.RECTANGLE:
      return 'rectangle';
      break;
    case _VIA_WHERE_SHAPE.EXTREME_RECTANGLE:
      return 'extreme_rectangle';
      break;
    case _VIA_WHERE_SHAPE.CIRCLE:
      return 'circle';
      break;
    case _VIA_WHERE_SHAPE.EXTREME_CIRCLE:
      return 'extreme_circle';
      break;
    case _VIA_WHERE_SHAPE.ELLIPSE:
      return 'ellipse';
      break;
    case _VIA_WHERE_SHAPE.POINT:
      return 'point';
      break;
    case _VIA_WHERE_SHAPE.POLYLINE:
      return 'polyline';
      break;
    case _VIA_WHERE_SHAPE.POLYGON:
      return 'polygon';
      break;
    default:
      return 'unknown';
  }
}

function _via_util_escape_quote_for_csv(s) {
  return s.replace(/["]/g, '""');
}

function _via_util_load_text_file(text_file, callback_function) {
  if (text_file) {
    var text_reader = new FileReader();

    text_reader.addEventListener( 'error', function() {
      console.log('Error loading data text file :  ' + text_file.name + ' !');
      callback_function('');
    }, false);

    text_reader.addEventListener( 'load', function() {
      callback_function(text_reader.result);
    }, false);
    text_reader.readAsText(text_file, 'utf-8');
  }
}

function _via_util_file_ext(filename) {
  return filename.substr( filename.lastIndexOf('.') + 1 );
}

function _via_util_infer_file_loc_from_filename(filename) {
  if ( filename.startsWith('http://') || filename.startsWith('https://') ) {
    return _VIA_FILE_LOC.URIHTTP;
  } else {
    if ( filename.startsWith('file://') || filename.includes('/') ) {
      return _VIA_FILE_LOC.URIFILE;
    } else {
      return _VIA_FILE_LOC.LOCAL;
    }
  }
}

function _via_util_infer_file_type_from_filename(filename) {
  var ext = _via_util_file_ext(filename);
  switch( ext.toLowerCase() ) {
  case 'ogv':
  case 'mp4':
  case 'avi':
  case 'webm':
    return _VIA_FILE_TYPE.VIDEO;
    break;
  case 'jpg':
  case 'jpeg':
  case 'png':
  case 'bmp':
    return _VIA_FILE_TYPE.IMAGE;
    break;
  case 'mp3':
  case 'wav':
  case 'oga':
  case 'ogg':
    return _VIA_FILE_TYPE.AUDIO;
  }
}


function _via_util_download_as_file(data, filename) {
  var a      = document.createElement('a');
  a.href     = URL.createObjectURL(data);
  a.download = filename;

  // simulate a mouse click event
  var event = new MouseEvent('click', {
    view: window,
    bubbles: true,
    cancelable: true
  });
  a.dispatchEvent(event);
}

function _via_util_file_select_local(type, handler, multiple) {
  var fsel = document.createElement('input');
  fsel.setAttribute('type', 'file');
  fsel.setAttribute('name', 'files[]');
  if ( typeof(multiple) === 'undefined' ||
       multiple === true ) {
    fsel.setAttribute('multiple', 'multiple')
  }

  switch(type) {
  case _VIA_FILE_SELECT_TYPE.IMAGE:
    fsel.accept = 'image/*';
    break;
  case _VIA_FILE_SELECT_TYPE.VIDEO:
    fsel.accept = 'video/*';
    break;
  case _VIA_FILE_SELECT_TYPE.AUDIO:
    fsel.accept = 'audio/*';
    break;
  case _VIA_FILE_SELECT_TYPE.TEXT:
    fsel.accept = '.csv,.txt';
    break;
  case _VIA_FILE_SELECT_TYPE.JSON:
    fsel.accept = '.json';
    break;
  case _VIA_FILE_SELECT_TYPE.VIDEO | _VIA_FILE_SELECT_TYPE.AUDIO:
    fsel.accept = 'video/*,audio/*';
    break;
  case _VIA_FILE_SELECT_TYPE.VIDEO | _VIA_FILE_SELECT_TYPE.AUDIO | _VIA_FILE_SELECT_TYPE.IMAGE:
    fsel.accept = 'video/*,audio/*,image/*';
    break;
  case _VIA_FILE_SELECT_TYPE.WEBVTT:
    fsel.accept = '.vtt';
    break;
  }

  fsel.onchange = handler;
  fsel.click();
}

// see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/random
function _via_util_rand_int(min_inclusive, max_exclusive) {
  return Math.floor(Math.random() * (max_exclusive - min_inclusive)) + min_inclusive;
}

function _via_util_page_show(page_id, action_map) {
  _via_page_action_map = action_map;
  var el = document.getElementById('via_page_container');

  var pages = el.getElementsByClassName('via_page');
  var n = pages.length;
  for ( var i = 0; i < n; ++i ) {
    if ( pages[i].dataset.pageid === page_id ) {
      pages[i].style.display = 'inline-block';
      el.style.display = 'block';
      _via_page_current = pages[i];
    } else {
      pages[i].style.display = 'none';
    }
  }
}

function _via_util_page_process_action(e) {
  for ( var action_id in _via_page_action_map ) {
    if ( e.target.id === action_id ) {
      var page_data = _via_util_page_gather_user_input();
      page_data['_action_id'] = e.target.id;
      _via_page_action_map[action_id].call(this, page_data);
      _via_util_page_hide();
    }
  }
}

function _via_util_page_gather_user_input() {
  var user_input = {};

  // dropdown
  var select_list = _via_page_current.getElementsByTagName('select');
  for ( var i = 0; i < select_list.length; ++i ) {
    user_input[select_list[i].id] = select_list[i].options[ select_list[i].selectedIndex ].value;
  }

  // input
  var input_list = _via_page_current.getElementsByTagName('input');
  for ( var i = 0; i < input_list.length; ++i ) {
    switch(input_list[i].type) {
      case 'file':
        user_input[input_list[i].id] = input_list[i].files;
        break;
      case 'select':
        if ( input_list[i].selectedIndex === -1 ) {
          user_input[input_list[i].id] = '';
        } else {
          user_input[input_list[i].id] = input_list[i].options[input_list[i].selectedIndex];
        }
        break;
      case 'text':
      case 'password':
        user_input[input_list[i].id] = input_list[i].value;
        break;
      default:
        console.warn('Input type=' + input_list[i].type + ' not yet implemented!');
    }
  }

  // textarea
  var textarea_list = _via_page_current.getElementsByTagName('textarea');
  for ( var i = 0; i < textarea_list.length; ++i ) {
    user_input[textarea_list[i].id] = textarea_list[i].value;
  }

  return user_input;
}

function _via_util_page_hide() {
  var el = document.getElementById('via_page_container');
  if ( el.style.display === 'block' ) {
    el.style.display = 'none';
  }
  _via_page_current = null;
}

function _via_util_msg_show(msg, sticky) {
  var container = document.getElementById('_via_message_container');
  var content = document.getElementById('_via_message');
  if ( container && content ) {
    if ( _via_msg_clear_timer ) {
      clearTimeout(_via_msg_clear_timer);
    }
    if ( typeof(sticky) === 'undefined' ||
         sticky === false
       ) {
      _via_msg_clear_timer = setTimeout( function() {
        document.getElementById('_via_message_container').style.display = 'none';
      }, _VIA_CONFIG.MSG_TIMEOUT);
    }

    content.innerHTML = msg + '<span class="message_panel_close_button">&times;</span>';
    container.style.display = 'block';
  }
}

function _via_util_msg_hide() {
  document.getElementById('_via_message_container').style.display = 'none';
  if ( _via_msg_clear_timer ) {
    clearTimeout(_via_msg_clear_timer);
  }
}

function _via_util_pad10(x) {
  if ( x < 10 ) {
    return '0' + x.toString();
  } else {
    return x;
  }
}

function _via_util_date_to_filename_str(date_str) {
  var t = new Date(date_str);
  var month_list = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return _via_util_pad10(t.getDate()) + month_list[t.getMonth()] + t.getFullYear() + '_' + _via_util_pad10(t.getHours()) + 'h' + _via_util_pad10(t.getMinutes()) + 'm' + _via_util_pad10(t.getSeconds())+'s';
}

function _via_util_remote_get(uri) {
  return new Promise( function(ok_callback, err_callback) {
    var xhr = new XMLHttpRequest();
    xhr.addEventListener('load', function() {
      ok_callback(xhr.responseText);
    });
    xhr.addEventListener('timeout', function(e) {
      err_callback(e);
    });
    xhr.addEventListener('error', function(e) {
      err_callback(e)
    });
    xhr.open('GET', uri);
    xhr.send();
  });
}

function _via_util_remote_head(uri) {
  return new Promise( function(ok_callback, err_callback) {
    var xhr = new XMLHttpRequest();
    xhr.addEventListener('load', function() {
      switch(xhr.statusText) {
        case 'OK':
          ok_callback(xhr.responseText);
          break;
        default:
          err_callback(xhr.statusText);
      }
    });
    xhr.addEventListener('timeout', function(e) {
      err_callback(e);
    });
    xhr.addEventListener('error', function(e) {
      err_callback(e)
    });
    xhr.open('HEAD', uri);
    xhr.send();
  });
}

function _via_util_float_arr_to_fixed(arr, fixed) {
  var farr = [];
  for ( var i in arr ) {
    farr[i] = parseFloat( arr[i].toFixed(fixed) );
  }
  return farr;
}

function _via_util_float_to_fixed(value, fixed) {
  return parseFloat( value.toFixed(fixed) );
}


//
// Unique Id
//

// URL.createObjectURL() produces a unique id every time it is invoked.
// We use this functionality to generate unique id required by VIA
// @todo: Replace with a true UUID generator if it can be efficiently generated
// using pure JS (no dependencies)
function _via_util_uuid() {
  var temp_url = URL.createObjectURL(new Blob())
  var uuid = temp_url.toString();
  URL.revokeObjectURL(temp_url);
  var slash_index = uuid.lastIndexOf('/');
  if ( uuid !== -1 ) {
    // remove any prefix (e.g. blob:null/, blob:www.test.com/, ...)
    uuid = uuid.substr(slash_index + 1);
    uuid = uuid.replace(/-/g, '');
  }
  return uuid;
}

function _via_util_gen_project_id() {
  return 'via' + _via_util_uuid();
}

function _via_util_uid6() {
  var temp_url = URL.createObjectURL(new Blob());
  var uuid = temp_url.toString();
  URL.revokeObjectURL(temp_url);
  var n = uuid.length;
  // remove any prefix (e.g. blob:null/, blob:www.test.com/, ...)
  var uuid_suffix_str = '';
  for ( var i = n - 12; i < n; i = i + 2 ) {
    uuid_suffix_str += String.fromCharCode( parseInt(uuid.substr(i, 2), 16) );
  }
  return btoa(uuid_suffix_str).replace(/[-+/_]/gi, 'X');
}

function _via_util_array_eq(a, b) {
  if ( a == null || b == null ) {
    return false;
  }
  if ( a.length != b.length ) {
    return false;
  }
  var n = a.length;
  for ( var i = 0; i < n; ++i ) {
    if ( a[i] !== b[i] ) {
      return false;
    }
  }
  return true;
}

function _via_util_obj_to_csv(obj, default_key) {
  var csv = [];
  for ( var oid in obj ) {
    if ( oid === default_key ) {
      csv.push( '*' + obj[oid] );
    } else {
      csv.push( obj[oid] );
    }
  }
  return csv.join(',');
}

function _via_util_attribute_to_html_element(attr) {
  var el;
  switch(attr.type) {
  case _VIA_ATTRIBUTE_TYPE.TEXT:
    el = document.createElement('textarea');
    break;

  case _VIA_ATTRIBUTE_TYPE.SELECT:
    el = document.createElement('select');
    var oid;
    for ( oid in attr.options ) {
      var oi = document.createElement('option');
      oi.setAttribute('value', oid);
      oi.innerHTML = attr.options[oid];
      if ( oid == attr.default_option_id ) {
        oi.setAttribute('selected', '');
      }
      el.appendChild(oi);
    }
    break;

  case _VIA_ATTRIBUTE_TYPE.RADIO:
    el = document.createElement('table');
    for ( var oid in attr.options ) {
      var oi = document.createElement('input');
      oi.setAttribute('name', attr.aname);
      oi.setAttribute('type', 'radio');
      var label = document.createElement('label');
      label.innerHTML = attr.options[oid];
      var tr = document.createElement('tr');
      var td = document.createElement('td');
      td.appendChild(oi);
      td.appendChild(label);
      tr.appendChild(td);
      el.appendChild(tr);
    }
    break;

  default:
    el = document.createElement('span');
    el.innerHTML = 'UNKNOWN';
  }
  return el;
}

// ensure the exported json string conforms to RFC 4180
// see: https://en.wikipedia.org/wiki/Comma-separated_values
function _via_util_obj2csv(d) {
  return '"' + JSON.stringify(d).replace(/["]/g, '""') + '"';
}

function _via_util_merge_object(obj1, obj2) {
  var merged_obj = {};
  Object.assign(merged_obj, obj1);
  Object.assign(merged_obj, obj2);
  return merged_obj;
}

function _via_util_collect_object_by_keys(object, keys) {
  var merged_obj = {};
  for ( var kindex in keys ) {
    Object.assign(merged_obj, obj1);
  }
  Object.assign(merged_obj, obj1);
  Object.assign(merged_obj, obj2);
  return merged_obj;
}

function _via_util_clamp(x, lower_bound, upper_bound) {
  return Math.min( Math.max(x, lower_bound), upper_bound );
}

function _via_util_merge_three_way_str(ancestor, version1, version2) {
  if ( version1 === version2 ) {
    return version1;
  } else {
    if ( ancestor === version1 ) {
      return version2;
    } else {
      return version1;
    }
  }
}


function _via_seconds_to_hh_mm_ss_ms(s) {
  // result = [hh, mm, ss, ms]
  var result = [0, 0, 0, 0];
  var sec = parseFloat(s);
  var ms = parseInt((sec - parseInt(s)) * 1000);
  if(ms < 99) {
    if(ms < 9) {
      result[3] = '00' + ms.toString();
    } else {
      result[3] = '0' + ms.toString();
    }
  } else {
    result[3] = ms.toString();
  }

  if(sec > 60*60) {
    var hh = parseInt(sec / (60*60));
    if(hh>9) {
      result[0] = hh.toString();
    } else {
      result[0] = '0' + hh;
    }
    sec = sec - result[0] * 60 * 60;
  } else {
    result[0] = '00';
  }

  if(sec > 60) {
    var mm = parseInt(sec / 60);
    if(mm>9) {
      result[1] = mm.toString();
    } else {
      result[1] = '0' + mm;
    }
    sec = sec - result[1] * 60;
  } else {
    result[1] = '00';
  }

  var ss = parseInt(sec);
  if(ss>9) {
    result[2] = ss.toString();
  } else {
    result[2] = '0' + ss;
  }

  return result;
}

function _via_hh_mm_ss_ms_to_seconds(hh_mm_ss_ms) {
  // hh_mm_ss_ms = HH:MM:SS.MS
  var split1 = hh_mm_ss_ms.split('.');
  if(split1.length !== 2) {
    split1 = hh_mm_ss_ms.split(',');
    if(split1.length !== 2) {
      return -1;
    }
  }
  var split2 = split1[0].split(':');
  if(split2.length !== 3) {
    return -1;
  }
  var sec = 0;
  switch(split2.length) {
  case 3:
    sec = parseInt(split2[0]) * 60 * 60 + parseInt(split2[1]) * 60 + parseInt(split2[2]);
    break;
  case 2:
    sec = parseInt(split2[1]) * 60 + parseInt(split2[2]);
    break;
  case 1:
    sec = parseInt(split2[2]);
    break;
  }
  if(split1.length === 2) {
    sec = sec + parseInt(split1[1])/1000;
  }
  return sec;
}
</script>
<!-- END: Contents of file: ../../src/js/_via_util.js-->
<!-- START: Contents of file: ../../src/js/_via_const.js-->
<script>
'use strict'

// definition of contants that are used by all modules
const _VIA_USER_ROLE = { 'ADMIN':1, 'ANNOTATOR':2, 'REVIEWER':3 };
const _VIA_STORE_TYPE = { 'LOCALSTORAGE':1, 'COUCHDB':2 };

var _VIA_SVG_NS = "http://www.w3.org/2000/svg";

var _VIA_PROJECT_ID_MARKER = '__VIA_PROJECT_ID__';
var _VIA_PROJECT_REV_ID_MARKER = '__VIA_PROJECT_REV_ID__';
var _VIA_PROJECT_REV_TIMESTAMP_MARKER = '__VIA_PROJECT_REV_TIMESTAMP__';

var _VIA_FILE_SELECT_TYPE = { 'JSON':2, 'CSV':4, 'TEXT':8, 'IMAGE':16, 'VIDEO':32, 'AUDIO':64, 'WEBVTT':128 };
var _VIA_MERGE_STRATEGY = { 'THREE_WAY':1 }
</script>
<!-- END: Contents of file: ../../src/js/_via_const.js-->
<!-- START: Contents of file: ../../src/js/_via_config.js-->
<script>
'use strict'

const _VIA_NAME = 'VGG Image Annotator';
const _VIA_NAME_SHORT = 'VIA';
const _VIA_VERSION = '3.0.9';
const _VIA_URL_CODE_REPO = 'https://gitlab.com/vgg/via';
const _VIA_URL_PROJECT_PAGE = 'http://www.robots.ox.ac.uk/~vgg/software/via/';

const _VIA_CONFIG = { MSG_TIMEOUT:3000 };
const _VIA_REMOTE_STORE = 'http://zeus.robots.ox.ac.uk/via/store/3.x.y/'; // to host your own server, see https://gitlab.com/vgg/vps
const _VIA_REMOTE_TIMEOUT = 6000; // in milliseconds
//const _VIA_REMOTE_STORE = 'http://localhost:9669/'; // for debug

const _VIA_DEFAULT_ATTRIBUTE_ANCHOR_ID = '';

var _VIA_FLOAT_FIXED_POINT = 3; // floats are stored as 3 decimal places
var _VIA_SPATIAL_REGION_MOVE_DELTA = 10; // in pixels
var _VIA_SPATIAL_REGION_LABEL_MAXLENGTH = 12; // in characters
var _VIA_SPATIAL_REGION_LABEL_FONT = '12px Sans';
</script>
<!-- END: Contents of file: ../../src/js/_via_config.js-->

<!-- START: Contents of file: ../../src/js/_via_event.js-->
<script>
/**
 * @class
 * @classdesc Implements a basic event emitter and event listener
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 15 Jan. 2019
 */

'use strict';

function _via_event() {
  this.on_event       = _via_event.prototype.on_event;
  this.emit_event     = _via_event.prototype.emit_event;
  this.disable_events = _via_event.prototype.disable;
  this.enable_events  = _via_event.prototype.enable;
  this.clear_events   = _via_event.prototype.clear;

  this._event = { 'enabled':true, 'targets':{} };
}

_via_event.prototype.on_event = function(event_id, listener_name, listener_method, listener_param) {
  // initialise event handlers data structure (if not exist)
  if ( typeof(this._event.targets[event_id]) === 'undefined' ) {
    this._event.targets[event_id] = { 'listener_name_list':[],
                                      'listener_method_list':[],
                                      'listener_param_list':[] };
  }

  this._event.targets[event_id].listener_name_list.push( listener_name );
  this._event.targets[event_id].listener_method_list.push( listener_method );
  if ( typeof(listener_param) === 'undefined' ) {
    this._event.targets[event_id].listener_param_list.push( {} );
  } else {
    this._event.targets[event_id].listener_param_list.push( listener_param );
  }
}

_via_event.prototype.emit_event = function(event_id, event_payload) {
  if ( this._event.enabled ) {
    if ( typeof(this._event.targets[event_id]) !== 'undefined' ) {
      for ( var i = 0; i < this._event.targets[event_id].listener_name_list.length; ++i ) {
        this._event.targets[event_id].listener_method_list[i].call(this, this._event.targets[event_id].listener_param_list[i], event_payload);
      }
    }
  }
}

_via_event.prototype.disable = function() {
  this._event.enabled = false;
}

_via_event.prototype.enable = function() {
  this._event.enabled = true;
}

_via_event.prototype.clear = function(listener_name, event_id) {
  if ( typeof(listener_name) === 'undefined' ) {
    if ( typeof(event_id) === 'undefined' ) {
      this._event.targets = {}; // clear all listeners
    } else {
      // clear based on event_id
      this._event.targets[event_id] = { 'listener_name_list':[],
                                        'listener_method_list':[],
                                        'listener_param_list':[] };
    }
  } else {
    if ( typeof(event_id_suffix) === 'undefined' ) {
      // clear based on listener_name
      for ( var event_id in this._event.targets ) {
        var delete_index_list = [];
        for ( var i = 0; i < this._event.targets[event_id].listener_name_list.length; ++i ) {
          if ( this._event.targets[event_id].listener_name_list[i] === listener_name ) {
            delete_index_list.push(i);
          }
        }
        if ( delete_index_list.length ) {
          for ( var i = 0; i < delete_index_list.length; ++i ) {
            this.delete_listener(event_id, delete_index_list[i]);
          }
        }
      }
    } else {
      // clear based on both listener_name and event_id
      var delete_index = -1
      for ( var i = 0; i < this._event.targets[event_id].listener_name_list.length; ++i ) {
        if ( this._event.targets[event_id].listener_name_list[i] === listener_name ) {
          delete_index = i;
          break;
        }
      }
      this.delete_listener(event_id, delete_index);
    }
  }
}

_via_event.prototype.delete_listener = function(event_id, listener_index) {
  this._event.targets[event_id].listener_name_list.splice(listener_index, 1);
  this._event.targets[event_id].listener_method_list.splice(listener_index, 1);
  this._event.targets[event_id].listener_param_list.splice(listener_index, 1);
}
</script>
<!-- END: Contents of file: ../../src/js/_via_event.js-->
<!-- START: Contents of file: _via_control_panel.js-->
<script>
/**
 *
 * @class
 * @classdesc VIA Control Panel customized for subtitle annotator
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 9 Oct. 2020
 *
 */

function _via_control_panel(control_panel_container, via) {
  this._ID = '_via_control_panel_';
  this.c   = control_panel_container;
  this.via = via;

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  _via_event.call( this );

  this._init();
}

_via_control_panel.prototype._init = function(type) {
  this.c.innerHTML = '';

  var logo_panel = document.createElement('div');
  logo_panel.setAttribute('class', 'logo');
  logo_panel.innerHTML = '<a href="http://www.robots.ox.ac.uk/~vgg/software/via/" title="VGG Image Annotator (VIA)" target="_blank">VIA</a>'
  this.c.appendChild(logo_panel);

  this.c.appendChild(this.via.vm.c);
  this._add_view_manager_tools();

  this._add_spacer();
  var subtitle = _via_util_get_svg_button('micon_subtitle', 'Import Subtitle from a WebVTT file');
  subtitle.addEventListener('click', function() {
    if(this.via.va.view_mode === _VIA_VIEW_MODE.AV_SUBTITLE) {
      _via_util_file_select_local(_VIA_FILE_SELECT_TYPE.WEBVTT, this._subtitle_import_on_local_file_select.bind(this), false);
    } else {
      _via_util_msg_show('Load a video or audio file before importing subtitle from WebVTT file.');
    }
  }.bind(this));
  this.c.appendChild(subtitle);

  var classes = _via_util_get_svg_button('micon_classes', 'Import txt file with possible classes');
  classes.addEventListener('click', function() {
    _via_util_file_select_local(_VIA_FILE_SELECT_TYPE.TEXT, this._classes_import_on_local_file_select.bind(this), false)
  }.bind(this));
  this.c.appendChild(classes);

  this._add_spacer();
  this._add_project_tools();

  this._add_spacer();

  this._add_project_share_tools();

  this._add_spacer();

  var keyboard = _via_util_get_svg_button('micon_keyboard', 'Keyboard Shortcuts');
  keyboard.addEventListener('click', function() {
    _via_util_page_show('page_keyboard_shortcut');
  }.bind(this));
  this.c.appendChild(keyboard);

  var help = _via_util_get_svg_button('micon_help', 'About VIA');
  help.addEventListener('click', function() {
    _via_util_page_show('page_about');
  }.bind(this));
  this.c.appendChild(help);
}

_via_control_panel.prototype._add_spacer = function() {
  var spacer = document.createElement('div');
  spacer.setAttribute('class', 'spacer');
  this.c.appendChild(spacer);
}

_via_control_panel.prototype._add_view_manager_tools = function() {
  var prev_view = _via_util_get_svg_button('micon_navigate_prev', 'Show Previous File', 'show_prev');
  prev_view.addEventListener('click', this.via.vm._on_prev_view.bind(this.via.vm));
  this.c.appendChild(prev_view);

  var next_view = _via_util_get_svg_button('micon_navigate_next', 'Show Next File', 'show_next');
  next_view.addEventListener('click', this.via.vm._on_next_view.bind(this.via.vm));
  this.c.appendChild(next_view);

  var add_media_local = _via_util_get_svg_button('micon_add_circle', 'Add Audio or Video File in Local Computer', 'add_media_local');
  add_media_local.addEventListener('click', this.via.vm._on_add_media_local.bind(this.via.vm));
  this.c.appendChild(add_media_local);

  var add_media_bulk = _via_util_get_svg_button('micon_lib_add', 'Bulk add file URI ( e.g. file:///... or http://... ) contained in a local CSV file where each row is a remote or local filename.', 'add_media_bulk');
  //add_media_bulk.addEventListener('click', this.via.vm._on_add_media_bulk.bind(this.via.vm));
  add_media_bulk.addEventListener('click', function() {
    var action_map = {
      'via_page_fileuri_button_bulk_add':this._page_on_action_fileuri_bulk_add.bind(this),
    }
    _via_util_page_show('page_fileuri_bulk_add', action_map);
  }.bind(this));
  this.c.appendChild(add_media_bulk);

  var del_view = _via_util_get_svg_button('micon_remove_circle', 'Remove the Current File', 'remove_media');
  del_view.addEventListener('click', this.via.vm._on_del_view.bind(this.via.vm));
  this.c.appendChild(del_view);
}

_via_control_panel.prototype._add_region_shape_selector = function() {
  if ( document.getElementById('shape_point') === null ) {
    return;
  }

  var rect = _via_util_get_svg_button('shape_rectangle', 'Rectangle', 'RECTANGLE');
  rect.addEventListener('click', function() {
    this._set_region_shape('RECTANGLE');
  }.bind(this));
  this.c.appendChild(rect);

  var extreme_rect = _via_util_get_svg_button('shape_extreme_rectangle', 'Extreme rectangle is defined using four points along the boundary of a rectangular object.', 'EXTREME_RECTANGLE');
  extreme_rect.classList.add('shape_selector');
  extreme_rect.addEventListener('click', function() {
    this._set_region_shape('EXTREME_RECTANGLE');
  }.bind(this));
  this.c.appendChild(extreme_rect);

  var circle = _via_util_get_svg_button('shape_circle', 'Circle', 'CIRCLE');
  circle.addEventListener('click', function() {
    this._set_region_shape('CIRCLE');
  }.bind(this));
  this.c.appendChild(circle);

  var extreme_circle = _via_util_get_svg_button('shape_extreme_circle', 'Extreme circle is defined using any three points along the circumference of a circular object.', 'EXTREME_CIRCLE');
  extreme_circle.addEventListener('click', function() {
    this._set_region_shape('EXTREME_CIRCLE');
  }.bind(this));
  this.c.appendChild(extreme_circle);

  var ellipse = _via_util_get_svg_button('shape_ellipse', 'Ellipse', 'ELLIPSE');
  ellipse.addEventListener('click', function() {
    this._set_region_shape('ELLIPSE');
  }.bind(this));
  this.c.appendChild(ellipse);

  var line = _via_util_get_svg_button('shape_line', 'Line', 'LINE');
  line.addEventListener('click', function() {
    this._set_region_shape('LINE');
  }.bind(this));
  this.c.appendChild(line);

  var polygon = _via_util_get_svg_button('shape_polygon', 'Polygon', 'POLYGON');
  polygon.addEventListener('click', function() {
    this._set_region_shape('POLYGON');
  }.bind(this));
  this.c.appendChild(polygon);

  var polyline = _via_util_get_svg_button('shape_polyline', 'Polyline', 'POLYLINE');
  polyline.addEventListener('click', function() {
    this._set_region_shape('POLYLINE');
  }.bind(this));
  this.c.appendChild(polyline);

  var point = _via_util_get_svg_button('shape_point', 'Point', 'POINT');
  point.addEventListener('click', function() {
    this._set_region_shape('POINT');
  }.bind(this));
  this.c.appendChild(point);

  this.shape_selector_list = { 'POINT':point, 'RECTANGLE':rect, 'EXTREME_RECTANGLE':extreme_rect, 'CIRCLE':circle, 'EXTREME_CIRCLE':extreme_circle, 'ELLIPSE':ellipse, 'LINE':line, 'POLYGON':polygon, 'POLYLINE':polyline };
}

_via_control_panel.prototype._set_region_shape = function(shape) {
  this.emit_event( 'region_shape', {'shape':shape});
  for ( var si in this.shape_selector_list ) {
    if ( si === shape ) {
      this.shape_selector_list[si].classList.add('svg_button_selected');
    } else {
      this.shape_selector_list[si].classList.remove('svg_button_selected');
    }
  }
}

_via_control_panel.prototype._add_project_tools = function() {
  var load = _via_util_get_svg_button('micon_open', 'Open a VIA Project');
  load.addEventListener('click', function() {
    _via_util_file_select_local(_VIA_FILE_SELECT_TYPE.JSON, this._project_load_on_local_file_select.bind(this), false);
  }.bind(this));
  this.c.appendChild(load);

  var save = _via_util_get_svg_button('micon_save', 'Save current VIA Project');
  save.addEventListener('click', function() {
    this.via.d.project_save();
  }.bind(this));
  this.c.appendChild(save);

  var import_export_annotation = _via_util_get_svg_button('micon_import_export', 'Import or Export Annotations');
  import_export_annotation.addEventListener('click', this._page_show_import_export.bind(this));
  this.c.appendChild(import_export_annotation);
}

_via_control_panel.prototype._page_show_import_export = function(d) {
  var action_map = {
    'via_page_button_import':this._page_on_action_import.bind(this),
    'via_page_button_export':this._page_on_action_export.bind(this),
  }
  _via_util_page_show('page_import_export', action_map);
}

_via_control_panel.prototype._page_on_action_import = function(d) {
  if ( d._action_id === 'via_page_button_import' ) {
    if ( d.via_page_import_pid !== '' ) {
      this.via.s._project_pull(d.via_page_import_pid).then( function(remote_rev) {
        try {
          var project = JSON.parse(remote_rev);
          // clear remote project identifiers
          project.project.pid = _VIA_PROJECT_ID_MARKER;
          project.project.rev = _VIA_PROJECT_REV_ID_MARKER;
          project.project.rev_timestamp = _VIA_PROJECT_REV_TIMESTAMP_MARKER;
          this.via.d.project_load_json(project);
        }
        catch(e) {
          _via_util_msg_show('Malformed response from server: ' + e);
        }
      }.bind(this), function(err) {
        _via_util_msg_show(err + ': ' + d.via_page_import_pid);
      }.bind(this));
      return;
    }

    if ( d.via_page_import_via2_project_json.length === 1 ) {
      _via_util_load_text_file(d.via_page_import_via2_project_json[0],
                               this._project_import_via2_on_local_file_read.bind(this)
                              );
      return;
    }
    _via_util_msg_show('To import an existing shared project, you must enter its project-id.');
  }
}

_via_control_panel.prototype._page_on_action_export = function(d) {
  if ( d._action_id === 'via_page_button_export' ) {
    this.via.ie.export_to_file(d.via_page_export_format);
  }
}

_via_control_panel.prototype._project_load_on_local_file_select = function(e) {
  if ( e.target.files.length === 1 ) {
    _via_util_load_text_file(e.target.files[0], this._project_load_on_local_file_read.bind(this));
  }
}

_via_control_panel.prototype._project_load_on_local_file_read = function(project_data_str) {
  this.via.d.project_load(project_data_str);
}

_via_control_panel.prototype._project_import_via2_on_local_file_read = function(project_data_str) {
  this.via.d.project_import_via2_json(project_data_str);
}

_via_control_panel.prototype._add_project_share_tools = function() {
  if ( this.via.s ) {
    var share = _via_util_get_svg_button('micon_share', 'Information about sharing this VIA project with others for collaborative annotation');
    share.addEventListener('click', function() {
      this._share_show_info();
    }.bind(this));
    var push = _via_util_get_svg_button('micon_upload', 'Push (i.e. share this project or share your updates made to this project)');
    push.addEventListener('click', function() {
      this.via.s.push();
    }.bind(this));

    var pull = _via_util_get_svg_button('micon_download', 'Pull (i.e. open a shared project or fetch updates for the current project)');
    pull.addEventListener('click', function() {
      this._share_show_pull();
    }.bind(this));

    this.c.appendChild(share);
    this.c.appendChild(push);
    this.c.appendChild(pull);
  }
}

_via_control_panel.prototype._share_show_info = function() {
  if ( this.via.d.project_is_remote() ) {
    this.via.s.exists(this.via.d.store.project.pid).then( function() {
      this.via.s._project_pull(this.via.d.store.project.pid).then( function(ok) {
        try {
          var d = JSON.parse(ok);
          var remote_rev_timestamp = new Date( parseInt(d.project.rev_timestamp) );
          var local_rev_timestamp = new Date( parseInt(this.via.d.store.project.rev_timestamp) );

          var pinfo = '<table>';
          pinfo += '<tr><td>Project Id</td><td>' + d.project.pid + '</td></tr>';
          pinfo += '<tr><td>Remote Revision</td><td>' + d.project.rev + ' (' + remote_rev_timestamp.toUTCString() + ')</td></tr>';
          pinfo += '<tr><td>Local Revision</td><td>' + this.via.d.store.project.rev + ' (' + local_rev_timestamp.toUTCString() + ')</td></tr>';
          pinfo += '</table>';
          if ( d.project.rev !== this.via.d.store.project.rev ) {
            pinfo += '<p>Your version of this project is <span style="color:red;">old</span>. Press <svg class="svg_icon" onclick="" viewbox="0 0 24 24"><use xlink:href="#micon_download"></use></svg> to fetch the most recent version of this project.</p>';
          } else {
            pinfo += '<p>You already have the <span style="color:blue;">latest</span> revision of this project.</p>';
          }

          document.getElementById('via_page_share_project_info').innerHTML = pinfo;
          document.getElementById('via_page_share_project_id').innerHTML = d.project.pid;
          _via_util_page_show('page_share_already_shared');
        }
        catch(e) {
          console.log(e)
          _via_util_msg_show('Malformed server response.' + e);
        }
      }.bind(this), function(pull_err) {
        _via_util_msg_show('Failed to pull project.');
        console.warn(pull_err);
      }.bind(this));
    }.bind(this), function(exists_err) {
      _via_util_page_show('page_share_not_shared_yet');
      console.warn(exists_err);
    }.bind(this));
  } else {
    _via_util_page_show('page_share_not_shared_yet');
  }
}

_via_control_panel.prototype._share_show_pull = function() {
  if ( this.via.d.project_is_remote() ) {
    // check if remote project has newer version
    this.via.s._project_pull(this.via.d.store.project.pid).then( function(ok) {
      try {
        var d = JSON.parse(ok);
        if ( d.project.rev === this.via.d.store.project.rev ) {
          _via_util_msg_show('You already have the latest revision of this project');
          return;
        } else {
          this.via.d.project_merge_rev(d);
        }
      }
      catch(e) {
        _via_util_msg_show('Malformed response from server.');
        console.warn(e);
      }
    }.bind(this), function(err) {
      _via_util_msg_show('Failed to pull project.');
      console.warn(err);
    }.bind(this));
  } else {
    var action_map = {
      'via_page_button_open_shared':this._page_on_action_open_shared.bind(this),
    }
    _via_util_page_show('page_share_open_shared', action_map);
  }
}

_via_control_panel.prototype._page_on_action_open_shared = function(d) {
  if ( d._action_id === 'via_page_button_open_shared' ) {
    this.via.s.pull(d.via_page_input_pid);
  }
}

_via_control_panel.prototype._page_on_action_fileuri_bulk_add = function(d) {
  if ( d.via_page_fileuri_urilist.length ) {
    this.fileuri_bulk_add_from_url_list(d.via_page_fileuri_urilist);
  }

  if ( d.via_page_fileuri_importfile.length === 1 ) {
    switch( parseInt(d.via_page_fileuri_filetype) ) {
    case _VIA_FILE_TYPE.IMAGE:
      _via_util_load_text_file(d.via_page_fileuri_importfile[0], this.fileuri_bulk_add_image_from_file.bind(this));
      break;
    case _VIA_FILE_TYPE.AUDIO:
      _via_util_load_text_file(d.via_page_fileuri_importfile[0], this.fileuri_bulk_add_audio_from_file.bind(this));
      break;
    case _VIA_FILE_TYPE.VIDEO:
      _via_util_load_text_file(d.via_page_fileuri_importfile[0], this.fileuri_bulk_add_video_from_file.bind(this));
      break;
    default:
      _via_util_load_text_file(d.via_page_fileuri_importfile[0], this.fileuri_bulk_add_auto_from_file.bind(this));
    }

  }
}

_via_control_panel.prototype.fileuri_bulk_add_image_from_file = function(uri_list_str) {
  this.fileuri_bulk_add_from_url_list(uri_list_str, _VIA_FILE_TYPE.IMAGE);
}

_via_control_panel.prototype.fileuri_bulk_add_audio_from_file = function(uri_list_str) {
  this.fileuri_bulk_add_from_url_list(uri_list_str, _VIA_FILE_TYPE.AUDIO);
}

_via_control_panel.prototype.fileuri_bulk_add_video_from_file = function(uri_list_str) {
  this.fileuri_bulk_add_from_url_list(uri_list_str, _VIA_FILE_TYPE.VIDEO);
}

_via_control_panel.prototype.fileuri_bulk_add_auto_from_file = function(uri_list_str) {
  this.fileuri_bulk_add_from_url_list(uri_list_str, 0);
}

_via_control_panel.prototype.fileuri_bulk_add_from_url_list = function(uri_list_str, type) {
  var uri_list = uri_list_str.split('\n');
  if ( uri_list.length ) {
    var filelist = [];
    for ( var i = 0; i < uri_list.length; ++i ) {
      if ( uri_list[i] === '' ||
           uri_list[i] === ' ' ||
           uri_list[i] === '\n'
         ) {
        continue; // skip
      }
      var filetype;
      if ( type === 0 || typeof(type) === 'undefined' ) {
        filetype = _via_util_infer_file_type_from_filename(uri_list[i]);
      } else {
        filetype = type;
      }

      filelist.push({ 'fname':uri_list[i],
                      'type':filetype,
                      'loc':_via_util_infer_file_loc_from_filename(uri_list[i]),
                      'src':uri_list[i],
                    });
    }
    this.via.vm._file_add_from_filelist(filelist);
  }
}

//
// subtitle import
//
_via_control_panel.prototype._subtitle_import_on_local_file_select = function(e) {
  if ( e.target.files.length === 1 ) {
    _via_util_load_text_file(e.target.files[0], this._subtitle_import_on_local_file_read.bind(this));
  }
}

_via_control_panel.prototype._subtitle_import_on_local_file_read = function(webvtt_str) {
  this.via.ie.import_from_webvtt(webvtt_str, this.via.va.vid, this.via.SUBTITLE_AID).then( function(ok) {
  }.bind(this), function(err) {
  }.bind(this));
}


//
// classes import
//
_via_control_panel.prototype._classes_import_on_local_file_select = function(e) {
  if ( e.target.files.length === 1 ) {
    _via_util_load_text_file(e.target.files[0], this._classes_import_on_local_file_read.bind(this));
  }
}

_via_control_panel.prototype._classes_import_on_local_file_read = function(txt_str) {
  this.via.ie.import_from_txt(txt_str).then( function(ok) {
  }.bind(this), function(err) {
  }.bind(this));
}
</script>
<!-- END: Contents of file: _via_control_panel.js-->
<!-- START: Contents of file: ../../src/js/_via_metadata.js-->
<script>
/**
 *
 * @class
 * @classdesc Metadata
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 31 Dec. 2018
 *
 * @param {Array} z an array of temporal locations (e.g. time, frame index, etc.)
 * @param {Array} xy an array consisting of type and extent of spatial region (e.g. [1, 10, 10, 50, 50] denotes a 50x50 rectangle at (10,10) )
 * @param {Object} an associative array mapping attribute-id to its value
 */

'use strict';

const _VIA_RSHAPE  = { 'POINT':1, 'RECTANGLE':2, 'CIRCLE':3, 'ELLIPSE':4, 'LINE':5, 'POLYLINE':6, 'POLYGON':7, 'EXTREME_RECTANGLE': 8, 'EXTREME_CIRCLE':9 };
const _VIA_METADATA_FLAG = { 'RESERVED_FOR_FUTURE':1 };

function _via_metadata(vid, z, xy, av) {
  this.vid = vid;   // view id
  this.flg = 0;     // flags reserved for future
  this.z   = z;     // [t0, ..., tn] (temporal coordinate e.g. time or frame index)
  this.xy  = xy;    // [shape_id, shape_coordinates, ...] (i.e. spatial coordinate)
  this.av  = av;    // attribute-value pair e.g. {attribute_id : attribute_value, ...}
}
</script>
<!-- END: Contents of file: ../../src/js/_via_metadata.js-->
<!-- START: Contents of file: ../../src/js/_via_file.js-->
<script>
/**
 *
 * @class
 * @classdesc Implementation of manual annotator for image, video and audio
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 23 Dec. 2018
 *
 * @param {number} fid a globally unique identifier
 * @param {string} fname filename
 * @param {number} type the file type as defined by _VIA_FILE_TYPE
 * @param {string} loc location of file as defined by _VIA_FILE_LOC
 * @param {string} src URI of the file or base64 data
 */

'use strict'

const _VIA_FILE_TYPE = { IMAGE:2, VIDEO:4, AUDIO:8 };
const _VIA_FILE_LOC  = { LOCAL:1, URIHTTP:2, URIFILE:3, INLINE:4 };

function _via_file(fid, fname, type, loc, src) {
  this.fid      = fid;
  this.fname    = fname;
  this.type     = type;
  this.loc      = loc;
  this.src      = src;
}

</script>
<!-- END: Contents of file: ../../src/js/_via_file.js-->
<!-- START: Contents of file: ../../src/js/_via_attribute.js-->
<script>
/**
 *
 * @class
 * @classdesc Attribute
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 31 Dec. 2018
 *
 */

'use strict'

const _VIA_ATTRIBUTE_TYPE = { 'TEXT':1, 'CHECKBOX':2, 'RADIO':3, 'SELECT':4, 'IMAGE':5 };

const _VIA_ATTRIBUTE_ANCHOR = {
  'FILE1_Z0_XY0':'Attribute of a File (e.g. image caption)',
  'FILE1_Z0_XY1':'Spatial Region in an Image (e.g. bounding box of an object)',
  'FILE1_Z0_XYN':'__FUTURE__',   // File region composed of multiple disconnected regions
  'FILE1_Z1_XY0':'__FUTURE__',   // Time marker in video or audio (e.g tongue clicks, speaker diarisation)
  'FILE1_Z1_XY1':'Spatial Region in a Video Frame (e.g. bounding box of an object)',
  'FILE1_Z1_XYN':'__FUTURE__',   // A video frame region composed of multiple disconnected regions
  'FILE1_Z2_XY0':'Temporal Segment in Video or Audio (e.g. video segment containing an actor)',
  'FILE1_Z2_XY1':'__FUTURE__',   // A region defined over a temporal segment
  'FILE1_Z2_XYN':'__FUTURE__',   // A temporal segment with regions defined for start and end frames
  'FILE1_ZN_XY0':'__FUTURE__',   // ? (a possible future use case)
  'FILE1_ZN_XY1':'__FUTURE__',   // ? (a possible future use case)
  'FILE1_ZN_XYN':'__FUTURE__',   // ? (a possible future use case)
  'FILEN_Z0_XY0':'Attribute of a Group of Files (e.g. given two images, which is more sharp?)',
  'FILEN_Z0_XY1':'__FUTURE__',   // ? (a possible future use case)
  'FILEN_Z0_XYN':'__FUTURE__',   // one region defined for each file (e.g. an object in multiple views)
  'FILEN_Z1_XY0':'__FUTURE__',   // ? (a possible future use case)
  'FILEN_Z1_XY1':'__FUTURE__',   // ? (a possible future use case)
  'FILEN_Z1_XYN':'__FUTURE__',   // ? (a possible future use case)
  'FILEN_Z2_XY0':'__FUTURE__',   // ? (a possible future use case)
  'FILEN_Z2_XY1':'__FUTURE__',   // ? (a possible future use case)
  'FILEN_Z2_XYN':'__FUTURE__',   // ? (a possible future use case)
  'FILEN_ZN_XY0':'__FUTURE__',   // one timestamp for each video or audio file (e.g. for alignment)
  'FILEN_ZN_XY1':'__FUTURE__',   // ? (a possible future use case)
  'FILEN_ZN_XYN':'__FUTURE__',   // a region defined in a video frame of each video
};

function _via_attribute(name, anchor_id, type, desc, options, default_option_id) {
  this.aname     = name;
  this.anchor_id = anchor_id;
  this.type      = type;
  this.desc      = desc;
  this.options   = options;
  this.default_option_id = default_option_id;
}

</script>
<!-- END: Contents of file: ../../src/js/_via_attribute.js-->
<!-- START: Contents of file: ../../src/js/_via_view.js-->
<script>
/**
 *
 * @class
 * @classdesc A view groups together a set of files and its associated metadata
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 5 Apr. 2019
 *
 */

'use strict'

function _via_view(fid_list) {
  this.fid_list = fid_list; // [ [fid00, fid01, ...], [fid10, fid11, ...] ]
}

</script>
<!-- END: Contents of file: ../../src/js/_via_view.js-->
<!-- START: Contents of file: ../../src/js/_via_data.js-->
<script>
/**
 *
 * @class
 * @classdesc Manages the storage and update of all data (annotations, files, etc. )
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 31 Dec. 2018
 *
 */

'use strict';

function _via_data() {
  this._ID = '_via_data_';
  this.store = this._init_default_project();
  this.file_ref = {};        // ref. to files selected using browser's file selector
  this.file_object_uri = {}; // WARNING: cleanup using file_object_url[fid]._destroy_file_object_url()
  this.log = [];

  this.DATA_FORMAT_VERSION = '3.1.1';

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  _via_event.call(this);
}

_via_data.prototype._init_default_project = function() {
  var p = {};
  p['project'] = {
    'pid': '__VIA_PROJECT_ID__',
    'rev': '__VIA_PROJECT_REV_ID__',
    'rev_timestamp': '__VIA_PROJECT_REV_TIMESTAMP__',
    'pname': 'Unnamed VIA Project',
    'data_format_version': this.DATA_FORMAT_VERSION,
    'creator': 'VGG Image Annotator (http://www.robots.ox.ac.uk/~vgg/software/via)',
    'created': Date.now(),
    'vid_list': [],
  }
  p['config'] = {
    'file': {
      'loc_prefix': { '1':'', '2':'', '3':'', '4':'' }, // constants defined in _via_file._VIA_FILE_LOC
    },
    'ui': {
      'file_content_align':'center',
      'file_metadata_editor_visible':true,
      'spatial_metadata_editor_visible':true,
      'spatial_region_label_attribute_id':'',
      'gtimeline_visible_row_count':'4',
    },
  };
  p['attribute'] = {};
  p['file'] = {};
  p['metadata'] = {};
  p['view'] = {};

  this.cache = {};
  this.cache['mid_list'] = {};
  this.cache['attribute_group'] = {};

  return p;
}

//
// attribute
//
_via_data.prototype._attribute_get_new_id = function() {
  var aid_list = Object.keys(this.store.attribute).map(Number).sort();
  var n = aid_list.length;
  var aid;
  if ( n ) {
    aid = aid_list[n-1] + 1;
  } else {
    aid = 1;
  }
  return aid;
}

_via_data.prototype._attribute_exist = function(aname) {
  var aid;
  for ( aid in this.store['attribute'] ) {
    if ( this.store['attribute'][aid].aname === aname ) {
      return true;
    }
  }
  return false;
}

_via_data.prototype.attribute_add = function(name, anchor_id, type, desc, options, default_option_id) {
  return new Promise( function(ok_callback, err_callback) {
    if ( this._attribute_exist(name) ) {
      err_callback('attribute already exists');
      return;
    }

    var aid = this._attribute_get_new_id();
    var desc = desc || '';
    var options = options || {};
    var default_option_id = default_option_id || '';
    this.store['attribute'][aid] = new _via_attribute(name,
                                                      anchor_id,
                                                      type,
                                                      desc,
                                                      options,
                                                      default_option_id);
    this._cache_update_attribute_group();
    this.emit_event( 'attribute_add', { 'aid':aid } );
    ok_callback(aid);
  }.bind(this));
}

_via_data.prototype.attribute_del = function(aid) {
  return new Promise( function(ok_callback, err_callback) {
    if ( this._attribute_exist(name) ) {
      err_callback('attribute already exists');
      return;
    }

    // delete all metadata entries for aid
    for ( var mid in this.store.metadata ) {
      if ( this.store.metadata[mid].av.hasOwnProperty(aid) ) {
        delete this.store.metadata[mid].av[aid];
      }
    }

    // delete aid
    delete this.store.attribute[aid];
    this._cache_update_attribute_group();
    this.emit_event( 'attribute_del', { 'aid':aid } );
    ok_callback(aid);
  }.bind(this));
}


_via_data.prototype.attribute_update_anchor_id = function(aid, anchor_id) {
  return new Promise( function(ok_callback, err_callback) {
    if ( ! this.store.attribute.hasOwnProperty(aid) ) {
      err_callback('aid does not exist');
      return;
    }
    this.store.attribute[aid].anchor_id = anchor_id;
    this._cache_update_attribute_group();
    this.emit_event( 'attribute_update', { 'aid':aid } );
    ok_callback(aid);
  }.bind(this));
}

_via_data.prototype.attribute_anchor_value_to_name = function(anchor_value) {
  for ( var anchor_name in _VIA_ATTRIBUTE_ANCHOR ) {
    if ( _via_util_array_eq(_VIA_ATTRIBUTE_ANCHOR[anchor_name], anchor_value) ) {
      return anchor_name;
    }
  }
  return '';
}

_via_data.prototype.attribute_update_aname = function(aid, new_aname) {
  return new Promise( function(ok_callback, err_callback) {
    if ( ! this.store.attribute.hasOwnProperty(aid) ) {
      err_callback('aid does not exist');
      return;
    }
    this.store['attribute'][aid]['aname'] = new_aname;
    this.emit_event( 'attribute_update', { 'aid':aid, 'aname':new_aname } );
    ok_callback(aid);
  }.bind(this));
}

_via_data.prototype.attribute_update_type = function(aid, new_type) {
  return new Promise( function(ok_callback, err_callback) {
    if ( ! this.store.attribute.hasOwnProperty(aid) ) {
      err_callback('aid does not exist');
      return;
    }
    this.store['attribute'][aid]['type'] = new_type;
    this.emit_event( 'attribute_update', { 'aid':aid, 'type':new_type } );
    ok_callback(aid);
  }.bind(this));
}

// option_csv = option1,*default_option,option2,...
_via_data.prototype.attribute_update_options_from_csv = function(aid, options_csv) {
  return new Promise( function(ok_callback, err_callback) {
    if ( ! this.store.attribute.hasOwnProperty(aid) ) {
      err_callback('aid does not exist');
      return;
    }
    options_csv = options_csv.trim();
    this.store['attribute'][aid]['options'] = {};
    this.store['attribute'][aid]['default_option_id'] = '';
    var options = options_csv.split(',');
    for ( var oid = 0; oid < options.length; ++oid ) {
      var oval = options[oid];
      oval = oval.trim();
      if ( oval.startsWith('*') ) {
        this.store['attribute'][aid]['default_option_id'] = oid.toString();
        oval = oval.substring(1); // remove *
      }
      this.store['attribute'][aid]['options'][oid] = oval;
    }
    this.emit_event( 'attribute_update', { 'aid':aid } );
    ok_callback(aid);
  }.bind(this));
}

//
// file
//
_via_data.prototype._file_get_new_id = function() {
  var max_fid = -Infinity;
  var fid;
  for ( var fid_str in this.store.file ) {
    fid = parseInt(fid_str);
    if ( fid > max_fid ) {
      max_fid = fid;
    }
  }
  if ( max_fid === -Infinity ) {
    return '1';
  } else {
    return (max_fid + 1).toString();
  }
}

_via_data.prototype.file_add = function(name, type, loc, src) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var fid = this._file_get_new_id();
      this.store.file[fid] = new _via_file(fid, name, type, loc, src);
      this.emit_event( 'file_add', { 'fid':fid } );
      ok_callback(fid);
    }
    catch(ex) {
      err_callback(ex);
    }
  }.bind(this));
}


_via_data.prototype.file_update = function(fid, name, value) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      if ( this.store.file.hasOwnProperty(fid) ) {
        if ( name === 'src' ) {
          if ( this.store.file[fid].loc === _VIA_FILE_LOC.LOCAL ) {
            this.file_ref[fid] = value;
            this.store.file[fid]['src'] = '';
          } else {
            this.store.file[fid]['src'] = value;
          }
        } else {
          if ( name === 'loc_prefix' ) {
            this.store.config.file.loc_prefix[this.store.file[fid].loc] = value;
          } else {
            this.store.file[fid][name] = value;
          }
        }
        this.emit_event( 'file_update', { 'fid':fid } );
        ok_callback(fid);
      } else {
        err_callback('fid=' + fid + ' does not exist!');
      }
    }
    catch(ex) {
      err_callback(ex);
    }
  }.bind(this));
}

_via_data.prototype.file_get_src = function(fid) {
  if ( this.store.file[fid].loc === _VIA_FILE_LOC.LOCAL ) {
    if(this.file_object_uri.hasOwnProperty(fid)) {
      return this.file_object_uri[fid];
    }

    if(this.file_ref.hasOwnProperty(fid)) {
      this.file_object_uri[fid] = URL.createObjectURL( this.file_ref[fid] );
      return this.file_object_uri[fid];
    } else {
      return '';
    }
  } else {
    return this.store.config.file.loc_prefix[ this.store.file[fid].loc ] + this.store.file[fid].src;
  }
}

_via_data.prototype.file_get_uri = function(fid) {
  if ( this.store.file[fid].loc === _VIA_FILE_LOC.LOCAL ) {
    return this.store.file[fid].fname;
  } else {
    return this.store.config.file.loc_prefix[ this.store.file[fid].loc ] + this.store.file[fid].src;
  }
}

_via_data.prototype.file_free_resources = function(fid) {
  // for files selected using browser's File Selector, we do not
  // need to revoke the ObjectURL because these are simply pointers
  // to the user selected files. If you use revokeObjectURL() to free
  // resources, it will invalidate the pointer to user selected file
  // see https://stackoverflow.com/a/49346614

  //URL.revokeObjectURL( this.file_object_uri[fid] );
  //delete this.file_object_uri[fid];
}

//
// Metadata
//
_via_data.prototype._metadata_get_new_id = function(vid) {
  return vid + '_' + _via_util_uid6();
}

_via_data.prototype.metadata_add = function(vid, z, xy, av) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      if ( ! this.store['view'].hasOwnProperty(vid) ) {
        err_callback({'vid':vid});
        return;
      }
      var mid = this._metadata_get_new_id(vid);
      var z_fp = _via_util_float_arr_to_fixed(z, _VIA_FLOAT_FIXED_POINT);
      var xy_fp = _via_util_float_arr_to_fixed(xy, _VIA_FLOAT_FIXED_POINT);
      this.store.metadata[mid] = new _via_metadata(vid, z_fp, xy_fp, av);
      if ( ! this.cache.mid_list.hasOwnProperty(vid) ) {
        this.cache.mid_list[vid] = [];
      }
      this.cache.mid_list[vid].push(mid);

      this.emit_event( 'metadata_add', { 'vid':vid, 'mid':mid } );
      ok_callback( {'vid':vid, 'mid':mid} );
    }
    catch(ex) {
      err_callback(ex);
    }
  }.bind(this));
}

_via_data.prototype.metadata_add_bulk = function(metadata_list, emit, existing_mids=null) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var added_mid_list = [];
      for ( var mindex in metadata_list ) {
        var vid = metadata_list[mindex].vid;
        if (existing_mids==null){
          var mid = this._metadata_get_new_id(vid);
        } else {
          var mid = existing_mids[mindex]
        }
        var z_fp = _via_util_float_arr_to_fixed(metadata_list[mindex].z, _VIA_FLOAT_FIXED_POINT);
        var xy_fp = _via_util_float_arr_to_fixed(metadata_list[mindex].xy, _VIA_FLOAT_FIXED_POINT);
        this.store.metadata[mid] = new _via_metadata(vid, z_fp, xy_fp, metadata_list[mindex].av);
        if ( ! this.cache.mid_list.hasOwnProperty(vid) ) {
          this.cache.mid_list[vid] = [];
        }
        this.cache.mid_list[vid].push(mid);
        added_mid_list.push(mid);
        if ('top5' in metadata_list[mindex]){
          this.store.metadata[mid].top5 = metadata_list[mindex]['top5']
        }
      }
      if ( typeof(emit) !== 'undefined' &&
           emit === true ) {
        this.emit_event( 'metadata_add_bulk', { 'mid_list':added_mid_list } );
      }
      ok_callback( { 'mid_list':added_mid_list } );
    }
    catch(ex) {
      err_callback(ex);
    }
  }.bind(this));
}

_via_data.prototype.metadata_update = function(vid, mid, z, xy, av) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      if ( ! this.store.view.hasOwnProperty(vid) ) {
        err_callback({'vid':vid});
        return;
      }

      if ( ! this.store.metadata.hasOwnProperty(mid) ) {
        err_callback({'mid':mid});
        return;
      }

      var z_fp = _via_util_float_arr_to_fixed(z, _VIA_FLOAT_FIXED_POINT);
      var xy_fp = _via_util_float_arr_to_fixed(xy, _VIA_FLOAT_FIXED_POINT);
      this.store.metadata[mid] = new _via_metadata(vid, z_fp, xy_fp, av);
      this.emit_event( 'metadata_update', { 'vid':vid, 'mid':mid } );
      ok_callback({'vid':vid, 'mid':mid});
    }
    catch(ex) {
      err_callback(ex);
    }
  }.bind(this));
}

_via_data.prototype.metadata_update_xy = function(vid, mid, xy) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      if ( ! this.store.view.hasOwnProperty(vid) ) {
        err_callback({'vid':vid});
        return;
      }
      if ( ! this.store.metadata.hasOwnProperty(mid) ) {
        err_callback({'mid':mid});
        return;
      }
      var xy_fp = _via_util_float_arr_to_fixed(xy, _VIA_FLOAT_FIXED_POINT);
      this.store.metadata[mid].xy = xy_fp;
      this.emit_event( 'metadata_update', { 'vid':vid, 'mid':mid } );
      ok_callback({'vid':vid, 'mid':mid});
    }
    catch(ex) {
      console.log(xy);
      err_callback(ex);
    }
  }.bind(this));
}

_via_data.prototype.metadata_update_av = function(vid, mid, aid, avalue) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      if ( ! this.store.view.hasOwnProperty(vid) ) {
        err_callback({'vid':vid});
        return;
      }
      if ( ! this.store.metadata.hasOwnProperty(mid) ) {
        err_callback({'mid':mid});
        return;
      }

      this.store.metadata[mid].av[aid] = avalue;
      this.emit_event( 'metadata_update', { 'vid':vid, 'mid':mid } );
      ok_callback({'vid':vid, 'mid':mid});
    }
    catch(ex) {
      console.log(ex);
      err_callback(ex);
    }
  }.bind(this));
}

_via_data.prototype.metadata_update_av_bulk = function(vid, av_list) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      if ( ! this.store.view.hasOwnProperty(vid) ) {
        err_callback({'vid':vid});
        return;
      }
      var updated_mid_list = [];
      var mid, aid, avalue;
      for ( var i in av_list ) {
        mid = av_list[i].mid;
        aid = av_list[i].aid;
        avalue = av_list[i].avalue;
        this.store.metadata[mid].av[aid] = avalue;
        updated_mid_list.push(mid);
      }
      var event_payload = { 'vid':vid, 'mid_list':updated_mid_list };
      this.emit_event('metadata_update_bulk', event_payload);
      ok_callback(event_payload);
    }
    catch(ex) {
      console.log(ex);
      err_callback(ex);
    }
  }.bind(this));
}

_via_data.prototype.metadata_update_z = function(vid, mid, z) {
  return new Promise( function(ok_callback, err_callback) {
    if ( ! this.store.view.hasOwnProperty(vid) ) {
      err_callback({'vid':vid});
      return;
    }
    if ( ! this.store.metadata.hasOwnProperty(mid) ) {
      err_callback({'mid':mid});
      return;
    }

    var z_fp = _via_util_float_arr_to_fixed(z, _VIA_FLOAT_FIXED_POINT);
    this.store.metadata[mid].z = z_fp;
    this.emit_event( 'metadata_update', { 'vid':vid, 'mid':mid } );
    ok_callback({'vid':vid, 'mid':mid});
  }.bind(this));
}

_via_data.prototype.metadata_update_zi = function(vid, mid, zindex, zvalue) {
  return new Promise( function(ok_callback, err_callback) {
    if ( ! this.store.view.hasOwnProperty(vid) ) {
      err_callback({'vid':vid});
      return;
    }
    if ( ! this.store.metadata.hasOwnProperty(mid) ) {
      err_callback({'mid':mid});
      return;
    }

    var zvalue_fp = _via_util_float_to_fixed(zvalue, _VIA_FLOAT_FIXED_POINT);
    this.store.metadata[mid].z[zindex] = zvalue_fp;
    this.emit_event( 'metadata_update', { 'vid':vid, 'mid':mid } );
    ok_callback({'vid':vid, 'mid':mid});
  }.bind(this));
}


_via_data.prototype.metadata_delete = function(vid, mid) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      if ( ! this.store.view.hasOwnProperty(vid) ) {
        err_callback({'vid':vid});
        return;
      }
      if ( ! this.store.metadata.hasOwnProperty(mid) ) {
        err_callback({'mid':mid});
        return;
      }

      this._cache_mid_list_del(vid, [mid]);
      delete this.store.metadata[mid];
      this.emit_event( 'metadata_delete', { 'vid':vid, 'mid':mid } );
      ok_callback({'vid':vid, 'mid':mid});
    }
    catch(ex) {
      err_callback(ex);
    }
  }.bind(this));
}

_via_data.prototype.metadata_delete_bulk = function(vid, mid_list, emit) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      if ( ! this.store.view.hasOwnProperty(vid) ) {
        err_callback({'vid':vid});
        return;
      }
      var deleted_mid_list = [];
      var mid, cindex;
      for ( var mindex in mid_list ) {
        mid = mid_list[mindex];
        delete this.store.metadata[mid];
        deleted_mid_list.push(mid);
      }
      this._cache_mid_list_del(vid, deleted_mid_list);
      if ( typeof(emit) !== 'undefined' &&
           emit === true ) {
        this.emit_event( 'metadata_delete_bulk', { 'vid':vid, 'mid_list':deleted_mid_list } );
      }
      ok_callback({'vid':vid, 'mid_list':deleted_mid_list});
    }
    catch(ex) {
      console.log(ex);
      err_callback(ex);
    }
  }.bind(this));
}

//
// View
//
_via_data.prototype._view_get_new_id = function() {
  var max_vid = -Infinity;
  var vid;
  for ( var vid_str in this.store.view ) {
    vid = parseInt(vid_str);
    if ( vid > max_vid ) {
      max_vid = vid;
    }
  }
  if ( max_vid === -Infinity ) {
    return '1';
  } else {
    return (max_vid + 1).toString();
  }
}

_via_data.prototype.view_add = function(fid_list) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var vid = this._view_get_new_id();
      this.store.view[vid] = new _via_view(fid_list);
      this.store.project.vid_list.push(vid);
      this.emit_event( 'view_add', { 'vid':vid } );
      ok_callback(vid);
    }
    catch(ex) {
      console.log(ex)
      err_callback(ex);
    }
  }.bind(this));
}

_via_data.prototype.view_get_file_vid = function(fid) {
  for ( var vid in this.store.view ) {
    if ( _via_util_array_eq(this.store.view[vid].fid_list, [fid]) ) {
      return vid;
    }
  }
  return -1;
}

// add view with single file
_via_data.prototype.view_bulk_add_from_filelist = function(filelist) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var added_fid_list = [];
      var added_vid_list = [];
      for ( var i = 0; i < filelist.length; ++i ) {
        var fid = this._file_get_new_id();
        if ( filelist[i].loc === _VIA_FILE_LOC.LOCAL ) {
          this.file_ref[fid] = filelist[i].src; // local file ref. stored separately
          filelist[i].src = '';                 // no need to store duplicate of file ref.
        }
        this.store.file[fid] = new _via_file(fid,
                                             filelist[i].fname,
                                             filelist[i].type,
                                             filelist[i].loc,
                                             filelist[i].src);

        var vid = this._view_get_new_id();
        this.store.view[vid] = new _via_view( [ fid ] ); // view with single file
        this.store.project.vid_list.push(vid);

        added_fid_list.push(fid);
        added_vid_list.push(vid);
      }
      var payload = { 'vid_list':added_vid_list, 'fid_list':added_fid_list };
      this.emit_event( 'view_bulk_add', payload );
      ok_callback(payload);
    }
    catch(err) {
      err_callback(err);
    }
  }.bind(this));
}

_via_data.prototype.view_del = function(vid) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      if ( ! this.store.view.hasOwnProperty(vid) ) {
        err_callback();
        return;
      }
      var vindex = this.store.project.vid_list.indexOf(vid);
      if ( vindex === -1 ) {
        err_callback();
        return;
      }

      // delete all metadata
      var mid;
      for ( var mindex in this.cache.mid_list[vid] ) {
        mid = this.cache.mid_list[vid][mindex];
        delete this.store.metadata[mid];
      }
      // delete all files
      var fid;
      for ( var findex in this.store.view[vid].fid_list ) {
        fid = this.store.view[vid].fid_list[findex];
        delete this.store.file[fid];
      }
      // delete view
      delete this.store.view[vid];
      this.store.project.vid_list.splice(vindex, 1);

      this._cache_update_mid_list();
      this.emit_event( 'view_del', {'vid':vid, 'vindex':vindex} );
      ok_callback({'vid':vid, 'vindex':vindex});
    }
    catch(err) {
      err_callback(err);
    }
  }.bind(this));
}

//
// cache
//
_via_data.prototype._cache_update = function() {
  this._cache_update_mid_list();
  this._cache_update_attribute_group();
}

_via_data.prototype._cache_mid_list_del = function(vid, del_mid_list) {
  var mid;
  for ( var mindex in del_mid_list ) {
    mid = del_mid_list[mindex];
    var cindex = this.cache.mid_list[vid].indexOf(mid);
    if ( cindex !== -1 ) {
      this.cache.mid_list[vid].splice(cindex, 1);
    }
  }
}

_via_data.prototype._cache_update_mid_list = function() {
  var vid;
  this.cache.mid_list = {};
  for ( var mid in this.store.metadata ) {
    vid = this.store.metadata[mid].vid;
    if ( ! this.cache.mid_list.hasOwnProperty(vid) ) {
      this.cache.mid_list[vid] = [];
    }
    this.cache.mid_list[vid].push(mid);
  }
}

_via_data.prototype._cache_update_attribute_group = function() {
  this.cache.attribute_group = {};
  var anchor_id;
  for ( var aid in this.store.attribute ) {
    anchor_id = this.store.attribute[aid].anchor_id;
    if ( ! this.cache.attribute_group.hasOwnProperty(anchor_id) ) {
      this.cache.attribute_group[anchor_id] = [];
    }
    this.cache.attribute_group[anchor_id].push(aid);
  }
}

_via_data.prototype._cache_get_attribute_group = function(anchor_id_list) {
  var aid_list = [];
  for ( var i in anchor_id_list ) {
    var anchor_id = anchor_id_list[i];
    if ( this.cache.attribute_group.hasOwnProperty(anchor_id) ) {
      aid_list = aid_list.concat( this.cache.attribute_group[anchor_id] );
    }
  }
  return aid_list;
}

//
// project
//
_via_data.prototype.project_save = function() {
  return new Promise( function(ok_callback, err_callback) {
    try {
      // @todo: decide on whether we want to include the base64 data
      // of inline files (i.e. this.store.file[fid].loc === _VIA_FILE_LOC.INLINE)
      var data_blob = new Blob( [JSON.stringify(this.store)],
                                {type: 'text/json;charset=utf-8'});
      var filename = [];
      if ( this.store.project.pid === _VIA_PROJECT_ID_MARKER ) {
        filename.push('via_project_');
      } else {
        filename.push(this.store.project.pid.substr(0,8) + '_');
      }
      filename.push(_via_util_date_to_filename_str(Date.now()));
      filename.push('.json');
      _via_util_download_as_file(data_blob, filename.join(''));
      ok_callback();
    }
    catch(err) {
      _via_util_msg_show('Failed to save project! [' + err + ']');
      err_callback();
    }
  }.bind(this));
}

_via_data.prototype.project_load = function(project_data_str) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var project_json_data = JSON.parse(project_data_str);
      this.project_load_json(project_json_data).then( function(ok) {
        ok_callback();
      }.bind(this), function(err) {
        err_callback();
      }.bind(this));
    }
    catch(err) {
      _via_util_msg_show('Failed to load project! [' + err + ']');
      this._init_default_project();
      console.log(err)
      err_callback();
    }
  }.bind(this));
}

_via_data.prototype.project_load_json = function(project_json_data) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var project_data = Object.assign({}, project_json_data);
      this.store = this.project_store_apply_version_fix(project_data);
      this.store0 = Object.assign({}, this.store); // used to detect project changes
      this._cache_update();
      this.emit_event( 'project_loaded', { 'pid':this.store.project.pid } );
      ok_callback();
    }
    catch(err) {
      _via_util_msg_show('Failed to load project! [' + err + ']');
      this._init_default_project();
      console.warn('failed to load project')
      console.log(err)
      err_callback();
    }
  }.bind(this));
}

_via_data.prototype.project_store_apply_version_fix = function(d) {
  switch(d['project']['data_format_version']) {
  case '3.1.0':
    var local_prefix = d['config']['file']['path'];
    delete d['config']['file']['path'];
    d['config']['file']['loc_prefix'] = { '1':'', '2':'', '3':'', '4':'' };
    d['config']['file']['loc_prefix'][_VIA_FILE_LOC.LOCAL] = local_prefix;
    d['project']['data_format_version'] = this.DATA_FORMAT_VERSION;
    d['project']['vid_list'] = d['vid_list'];
    delete d['vid_list'];
    return d;
    break;
  default:
    return d;
    break;
  }
}

_via_data.prototype.project_is_remote = function() {
  if ( this.store.project.pid === _VIA_PROJECT_ID_MARKER &&
       this.store.project.rev === _VIA_PROJECT_REV_ID_MARKER &&
       this.store.project.rev_timestamp === _VIA_PROJECT_REV_TIMESTAMP_MARKER
     ) {
    return false;
  } else {
    return true;
  }
}

//
// merge
//
_via_data.prototype.project_merge_rev = function(remote, merge_strategy) {
  if ( typeof(merge_strategy) === 'undefined' ) {
    merge_strategy = _VIA_MERGE_STRATEGY.THREE_WAY;
  }

  switch(merge_strategy) {
  case _VIA_MERGE_STRATEGY.THREE_WAY:
    this.project_merge_three_way(remote).then( function(ok) {
      console.log('Merge success');
    }.bind(this), function(err) {
      console.log('Merge failed');
    }.bind(this));
    break;
  default:
    console.log('Unknown merge strategy: ' + merge_strategy);
  }
}

_via_data.prototype.project_merge_three_way = function(remote) {
  return new Promise( function(ok_callback, err_callback) {
    // see https://en.wikipedia.org/wiki/Merge_(version_control)
    // merge using the three way merge algorithm, where
    // common ancestor = this.store0 (i.e. the last revision)
    // remote          = the latest revision pulled from server
    // local           = this.store (i.e. local version of project with some revisions)

    if ( this.store.project.pid !== remote.project.pid ) {
      err_callback('pid mismatch');
      return;
    }

    try {
      // merge project
      this.store.project['pname'] = this.merge_3way(this.store0.project['pname'],
                                                    remote.project['pname'],
                                                    this.store.project['pname']);
      this.store.project['vid_list'] = this.merge_3way(this.store0.project['vid_list'],
                                                       remote.project['vid_list'],
                                                       this.store.project['vid_list']);

      // merge remote attribute, file, view and metadata
      var property_list = [ 'config', 'attribute', 'file', 'view', 'metadata' ];
      for ( var pindex in property_list ) {
        var property = property_list[pindex]
        for ( var id in remote[property] ) {
          if ( this.store[property].hasOwnProperty(id) ) {
            for ( var afield in this.store[property][id] ) {
              this.store[property][id][afield] = this.merge_3way(this.store[property][id][afield],
                                                                 remote[property][id][afield],
                                                                 this.store0[property][id][afield]);
            }
          } else {
            // add new attribute
            this.store[property][id] = remote[property][id];
          }
        }
      }

      // check for data that was deleted in remote
      for ( var pindex in property_list ) {
        var property = property_list[pindex]
        for ( var id in this.store[property] ) {
          if ( ! remote[property].hasOwnProperty(id) ) {
            // something was deleted in remote, therefore we remove it from local version
            delete this.store[property][id];
          }
        }
      }

      this.store.project.rev = remote.project.rev;
      this.store.project.rev_timestamp = remote.project.rev_timestamp;
      this.project_merge_on_success();
    }
    catch (e) {
      _via_util_msg_show('Merge failed: ' + e, true);
      console.warn(e);
      err_callback(e);
    }
  }.bind(this));
}

_via_data.prototype.merge_3way = function(common_ancestor, remote, local) {
  if ( typeof(common_ancestor) === 'object' ) {
    if ( Array.isArray(common_ancestor) ) {
      // use array comparison
      if ( _via_util_array_eq(remote, local) ) {
        return local;
      } else {
        if ( _via_util_array_eq(common_ancestor, local) ) {
          return remote;
        } else {
          return local; // for conflicts, preserve my local updates
        }
      }
    } else {
      // use object comparison
      if ( JSON.stringify(remote) === JSON.stringify(local) ) {
        return local;
      } else {
        if ( JSON.stringify(common_ancestor) === JSON.stringify(local) ) {
          return remote;
        } else {
          return local; // for conflicts, preserve my local updates
        }
      }
    }
  } else {
    if ( remote === local ) {
      return local;
    } else {
      if ( common_ancestor === local ) {
        return remote;
      } else {
        return local; // for conflicts, preserve my local updates
      }
    }
  }
}

_via_data.prototype.project_merge_on_success = function() {
  this._cache_update();
  this.emit_event( 'project_updated', { 'pid':this.store.project.pid } );

  _via_util_msg_show('Successfully merged with revision ' + this.store.project.rev, true);
}

// is there any difference between local project and remote project?
_via_data.prototype.project_is_different = function(others_str) {
  return new Promise( function(ok_callback, err_callback) {
    var ours_str = JSON.stringify(this.store);
    if ( ours_str === others_str ) {
      err_callback();
    } else {
      ok_callback(others_str);
    }
  }.bind(this));
}

//
// Import
//
_via_data.prototype.project_import_via2_json = function(via2_project_json) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var via2 = JSON.parse(via2_project_json);
      this.store = this._init_default_project();

      // add project data
      if ( via2.hasOwnProperty('_via_settings') ) {
        this.store.project.pname = via2['_via_settings']['project']['name'];
        this.store.config.file.loc_prefix[_VIA_FILE_LOC.LOCAL] = via2['_via_settings']['core']['default_filepath'];
      }

      // add attributes
      var metadata_type_anchor_id_map = { 'region':'FILE1_Z0_XY1', 'file':'FILE1_Z0_XY0' };
      var via2_aid_to_via3_aid_map = {};
      for ( var metadata_type in metadata_type_anchor_id_map ) {
        var anchor_id = metadata_type_anchor_id_map[metadata_type];
        for ( var aid in via2['_via_attributes'][metadata_type] ) {
          var options = via2['_via_attributes'][metadata_type][aid]['options'];
          var default_option_id = [];
          for ( var default_oid in via2['_via_attributes'][metadata_type][aid]['default_options'] ) {
            default_option_id.push(default_oid);
          }
          var via3_aid = this._attribute_get_new_id();
          var atype_text = via2['_via_attributes'][metadata_type][aid]['type'].toUpperCase();
          if ( atype_text === 'DROPDOWN' ) {
            atype_text = 'SELECT';
          }
          var atype = _VIA_ATTRIBUTE_TYPE[atype_text];
          this.store['attribute'][via3_aid] = new _via_attribute(aid,
                                                                  anchor_id,
                                                                  atype,
                                                                  via2['_via_attributes'][metadata_type][aid]['description'],
                                                                  options,
                                                                 default_option_id.join(',')
                                                                 );
          via2_aid_to_via3_aid_map[aid] = via3_aid;
        }
      }

      // add file, view and metadata
      for ( var fid in via2['_via_img_metadata'] ) {
        var fname = via2['_via_img_metadata'][fid]['filename'];
        var floc = _via_util_infer_file_loc_from_filename(fname);
        var ftype = _via_util_infer_file_type_from_filename(fname);
        var via3_fid = this._file_get_new_id();
        this.store.file[via3_fid] = new _via_file(via3_fid, fname, ftype, floc, fname);

        var vid = this._view_get_new_id();
        this.store.view[vid] = new _via_view([via3_fid]);
        this.store.project.vid_list.push(vid);

        // import region metadata
        for ( var rid in via2['_via_img_metadata'][fid]['regions'] ) {
          var shape = via2['_via_img_metadata'][fid]['regions'][rid]['shape_attributes'];
          var z = [];
          var xy = [];
          var av = {};
          switch(shape['name']) {
          case 'rect':
            xy = [ _VIA_RSHAPE.RECTANGLE, shape['x'], shape['y'], shape['width'], shape['height'] ];
            break;
          case 'circle':
            xy = [ _VIA_RSHAPE.CIRCLE, shape['cx'], shape['cy'], shape['r'] ];
            break;
          case 'ellipse':
            xy = [ _VIA_RSHAPE.ELLIPSE, shape['cx'], shape['cy'], shape['rx'], shape['ry'] ];
            break;
          case 'point':
            xy = [ _VIA_RSHAPE.POINT, shape['cx'], shape['cy'] ];
            break;
          case 'polygon':
          case 'polyline':
            if ( shape['name'] === 'polygon' ) {
              xy[0] = _VIA_RSHAPE.POLYGON;
            } else {
              xy[0] = _VIA_RSHAPE.POLYLINE;
            }
            var n = shape['all_points_x'].length;
            for ( var i = 0; i < n; ++i ) {
              xy.push(shape['all_points_x'][i], shape['all_points_y'][i]);
            }
            break;
          default:
            console.log('Unknown shape ' + shape['name'] + ' in input file!');
          }

          var region = via2['_via_img_metadata'][fid]['regions'][rid]['region_attributes'];
          for ( var via2_aid in via2['_via_img_metadata'][fid]['regions'][rid]['region_attributes'] ) {
            var via3_aid = via2_aid_to_via3_aid_map[via2_aid];
            var avalue = via2['_via_img_metadata'][fid]['regions'][rid]['region_attributes'][via2_aid];

            if ( typeof(avalue) === 'object' ) {
              avalue = Object.keys(avalue).join(',');
            }

            av[via3_aid] = avalue;
          }

          var mid = this._metadata_get_new_id(vid);
          this.store.metadata[mid] = new _via_metadata(vid, z, xy, av);
        }

        // import file metadata
        var file_av = {};
        for ( var via2_aid in via2['_via_img_metadata'][fid]['file_attributes'] ) {
          var via3_aid = via2_aid_to_via3_aid_map[via2_aid];
          var avalue = via2['_via_img_metadata'][fid]['file_attributes'][via2_aid];

          if ( typeof(avalue) === 'object' ) {
            avalue = Object.keys(avalue).join(',');
          }

          file_av[via3_aid] = avalue;
        }
        var mid = this._metadata_get_new_id(vid);
        this.store.metadata[mid] = new _via_metadata(vid, [], [], file_av);
      }
      _via_util_msg_show('Project import successful');
      this._cache_update();
      this.emit_event( 'project_loaded', {} );
      ok_callback();
    }
    catch(ex) {
      console.log(ex)
      _via_util_msg_show('Failed to import project');
      err_callback(ex);
    }
  }.bind(this));
}
</script>
<!-- END: Contents of file: ../../src/js/_via_data.js-->
<!-- START: Contents of file: ../../src/js/_via_share.js-->
<script>
/**
 *
 * @class
 * @classdesc Manages communication with VIA project server to allow sharing of VIA projects.
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 24 June 2019
 *
 */

'use strict';

function _via_share(data, conf) {
  this._ID = '_via_share_';
  this.d = data;
  this.conf = conf;

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  _via_event.call(this);
}

_via_share.prototype._disable_share = function() {
  this.push   = this._disabled_info;
  this.pull   = this._disabled_info;
  this.exists = this._disabled_info;
}

_via_share.prototype._disabled_info = function() {
  _via_util_msg_show('Share feature has been disabled in demo applications!');
}

_via_share.prototype.push = function() {
  if ( this.d.store.project.pid === _VIA_PROJECT_ID_MARKER &&
       this.d.store.project.rev === _VIA_PROJECT_REV_ID_MARKER &&
       this.d.store.project.rev_timestamp === _VIA_PROJECT_REV_TIMESTAMP_MARKER
     ) {
    // avoid pushing empty projects
    if ( Object.keys(this.d.store.file).length === 0 ||
         Object.keys(this.d.store.view).length === 0
       ) {
      _via_util_msg_show('Cannot push empty project');
      return;
    }

    // create a new project
    _via_util_msg_show('Initializing new shared project ...', true);
    this._project_push().then( function(ok) {
      this._project_on_push_ok_response(ok);
    }.bind(this), function(err) {
      this._project_on_push_err_response(err);
    }.bind(this));
  } else {
    // update existing project
    _via_util_msg_show('Checking for updates to remote project ...', true);
    this._project_pull(this.d.store.project.pid).then( function(remote_rev) {
      this.d.project_is_different(remote_rev).then( function(yes) {
        _via_util_msg_show('Checking for updates to remote project ...', true);
        try {
          var d = JSON.parse(yes);
          if ( this.d.store.project.rev === d.project.rev ) {
            // push new revision
            var pid = this.d.store.project.pid;
            var rev = this.d.store.project.rev;
            _via_util_msg_show('Pushing project ...', true);
            this._project_push(pid, rev).then( function(ok) {
              this._project_on_push_ok_response(ok);
            }.bind(this), function(err) {
              this._project_on_push_err_response(err);
            }.bind(this));
          } else {
            // newer revision exists, pull first
            _via_util_msg_show('You must first pull remote revision first. (local revision=' + this.d.store.project.rev + ', remote rev=' + d['project']['rev'] + ')', true);
            return;
          }
        }
        catch(e) {
          _via_util_msg_show('Error parsing response from server: ' + e);
        }
      }.bind(this), function(no) {
        _via_util_msg_show('There are no new changes to push!');
      }.bind(this));
    }.bind(this), function(err) {
      _via_util_msg_show('Failed to retrive remote VIA project: ' + err);
    }.bind(this));
  }
}

_via_share.prototype.pull = function(pid) {
  this._project_pull(pid).then( function(remote_rev) {
    this.d.project_load(remote_rev).then( function() {
      _via_util_msg_show('Loaded shared project ' + pid);
    }.bind(this), function(err) {
      console.warn(err)
      _via_util_msg_show('Failed to load shared project: ' + err);
    }.bind(this));
  }.bind(this), function(err_msg) {
    _via_util_msg_show(err_msg + ' fetching remote shared project: ' + pid);
  }.bind(this));
}

_via_share.prototype.exists = function(pid) {
  return new Promise( function(ok_callback, err_callback) {
    var xhr = new XMLHttpRequest();
    xhr.addEventListener('load', function() {
      switch(xhr.statusText) {
      case 'OK':
        ok_callback(pid);
        break;
      default:
        err_callback(pid, xhr.statusText);
      }
    });
    xhr.addEventListener('timeout', function(e) {
      err_callback(pid, 'timeout');
    });
    xhr.addEventListener('error', function(e) {
      err_callback(pid, 'error')
    });
    xhr.open('HEAD', this.conf['ENDPOINT'] + pid);
    xhr.send();
  }.bind(this));
}

_via_share.prototype._project_on_push_ok_response = function(ok_response) {
  try {
    var d = JSON.parse(ok_response);
    if ( d.hasOwnProperty('pid') &&
         d.hasOwnProperty('rev') &&
         d.hasOwnProperty('rev_timestamp')
       ) {
      this.d.store.project.pid = d['pid'];
      this.d.store.project.rev = d['rev'];
      this.d.store.project.rev_timestamp = d['rev_timestamp'];
      _via_util_msg_show('Pushed revision ' + d['rev']);
    } else {
      _via_util_msg_show('Malformed response from server: ' + ok);
    }
  }
  catch(e) {
    _via_util_msg_show('Malformed response from server: ' + ok_response);
  }
}

_via_share.prototype._project_on_push_err_response = function(reason, err_msg) {
  _via_util_msg_show('Push failed: ' + reason + ' ' + err_msg);
  console.warn(err_response);
}

_via_share.prototype._project_pull = function(pid) {
  return new Promise( function(ok_callback, err_callback) {
    var xhr = new XMLHttpRequest();
    xhr.addEventListener('load', function() {
      switch(xhr.statusText) {
      case 'OK':
        ok_callback(xhr.responseText);
        break;
      default:
        err_callback(xhr.statusText);
      }
    });
    xhr.addEventListener('timeout', function(e) {
      err_callback('Timeout');
    });
    xhr.addEventListener('error', function(e) {
      err_callback('Error' )
    });
    xhr.open('GET', this.conf['ENDPOINT'] + pid);
    xhr.send();
  }.bind(this));
}

_via_share.prototype._project_push = function(pid, rev) {
  return new Promise( function(ok_callback, err_callback) {
    var xhr = new XMLHttpRequest();
    xhr.addEventListener('load', function() {
      switch(xhr.statusText) {
      case 'OK':
        ok_callback(xhr.responseText);
        break;
      default:
        err_callback(xhr.statusText);
      }
    });
    xhr.addEventListener('timeout', function(e) {
      console.log('timeout');
      err_callback(pid, 'timeout');
    });
    xhr.addEventListener('error', function(e) {
      console.log(e.target)
      err_callback(pid, 'error')
    });

    var payload = JSON.parse(JSON.stringify(this.d.store));
    payload.project.rev = _VIA_PROJECT_REV_ID_MARKER;
    payload.project.rev_timestamp = _VIA_PROJECT_REV_TIMESTAMP_MARKER;
    if ( typeof(pid) === 'undefined' &&
         typeof(rev) === 'undefined'
       ) {
      payload.project.pid = _VIA_PROJECT_ID_MARKER;
      xhr.open('POST', this.conf['ENDPOINT']);
      console.log('POST ' + this.conf['ENDPOINT'])
    } else {
      xhr.open('POST', this.conf['ENDPOINT'] + pid + '?rev=' + rev);
      console.log('POST ' + this.conf['ENDPOINT' + pid + '?rev=' + rev])
    }
    xhr.timeout = _VIA_REMOTE_TIMEOUT;
    xhr.send(JSON.stringify(payload));
  }.bind(this));
}
</script>
<!-- END: Contents of file: ../../src/js/_via_share.js-->
<!-- START: Contents of file: ../../src/js/_via_import_export.js-->
<script>
/**
 *
 * @class
 * @classdesc Manages import and export of annotations
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 26 May 2019
 *
 */

'use strict';

function _via_import_export(data, data_RH=null, data_LH=null) {
  this.d = data;
  this.d_RH = data_RH
  this.d_LH = data_LH

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  this._EVENT_ID_PREFIX = '_via_import_export_';
  _via_event.call(this);
}

_via_import_export.prototype.import_from_file = function(data_format, file) {
  switch(data_format) {
  case 'coco':
    _via_util_load_text_file(file[0], this.import_from_coco.bind(this));
    break;
  case 'webvtt':
    _via_util_load_text_file(file[0], this.import_subtitle_from_webvtt.bind(this));
  case 'txt':
    _via_util_load_text_file(file[0], this.import_from_txt.bind(this));
  default:
    console.warn('Unknown data format: ' + data_format);
  }
}

_via_import_export.prototype.import_from_txt = function(txt_str) {
  // debugger
  return new Promise( function(ok_callback, err_callback) {
    var class_list = txt_str.split(/\r?\n/)
    for ( var i in class_list) {
      class_list[i] = class_list[i].split(',')[0]
    }
    this.d.classes = class_list
    debugger
  }.bind(this));
}



_via_import_export.prototype.import_from_coco = function(json_str) {
  try {
    var d = JSON.parse(json_str);
    if ( ! ( d.hasOwnProperty('annotations') &&
             d.hasOwnProperty('categories') &&
             d.hasOwnProperty('images')
           )
       ) {
      _via_util_msg_show('Cannot import annotations from malformed JSON!');
      return;
    }
    var p = this.d._init_default_project();

    // add files
    for ( var i in d.images ) {
      var fid = d.images[i].id;
      var fname = d.images[i].file_name;
      var src = d.images[i].coco_url;
      var type = _VIA_FILE_TYPE.IMAGE;
      var loc = _VIA_FILE_LOC.URIHTTP;
      p.file[fid] = new _via_file(fid, fname, type, loc, src);

      // add a view for each file
      var vid = fid;
      p.view[vid] = new _via_view( [ fid ] ); // view with single file
      p.project.vid_list.push(vid);
    }

    // add attributes
    for ( var i in d.categories ) {
      var aid = d.categories[i].id;
      var aname = d.categories[i].name;
      p.attribute[aid] = new _via_attribute(aname, 'FILE1_Z0_XY1', _VIA_ATTRIBUTE_TYPE.TEXT, {}, {});
/*
      var aid = d.categories[i].supercategory;
      var option_id = d.categories[i].id;
      var option_value = d.categories[i].name;

      if ( p.attribute.hasOwnProperty(aid) ) {
        // add as an option
        p.attribute[aid].options[option_id] = option_value;
      } else {
        var options = {};
        options[option_id] = option_value;
        p.attribute[aid] = new _via_attribute(aid, 'FILE1_Z0_XY1', _VIA_ATTRIBUTE_TYPE.SELECT, options, {});
      }
*/
    }

    // add metadata
    for ( var i in d.annotations ) {
      var mid = d.annotations[i].id;
      var vid = d.annotations[i].image_id;
      if ( p.file.hasOwnProperty(vid) ) {
        var aid = d.annotations[i].category_id;
        var shape = [_VIA_RSHAPE.POLYGON];
        var av = {}
        av[aid] = p.attribute[aid].aname;

        for ( var j = 0; j < d.annotations[i].segmentation[0].length; ++j ) {
          shape.push(d.annotations[i].segmentation[0][j]);
        }

        p.metadata[mid] = new _via_metadata(vid, [], shape, av);
      }
    }

    this.d.project_load_json(p);
  }
  catch(e) {
    _via_util_msg_show('Failed to import annotations: ' + e);
    console.warn(e)
  }
}

_via_import_export.prototype.export_to_file = function(data_format) {
  console.log(data_format)
  switch(data_format) {
  case 'via3_csv':
    this.export_to_via3_csv();
    break;
  case 'temporal_segments_csv':
    this.export_to_temporal_segments_csv();
    break;
  case 'webvtt':
    this.export_to_webvtt();
    this.export_log()
    break;

  default:
    console.warn('Unknown data format: ' + data_format);
  }
}

_via_import_export.prototype.export_to_via3_csv = function() {
  return new Promise( function(ok_callback, err_callback) {
    var csv = [];

    var attribute = {}
    for ( var aid in this.d.store.attribute ) {
      attribute[aid] = this.d.store.attribute[aid].aname;
    }

    csv.push('# Exported using VGG Image Annotator (http://www.robots.ox.ac.uk/~vgg/software/via)');
    csv.push('# Notes:');
    csv.push('# - spatial_coordinates of [2,10,20,50,80] denotes a rectangle (shape_id=2) of size 50x80 placed at (10,20)');
    csv.push('# - temporal coordinate of [1.349,2.741] denotes a temporal segment from time 1.346 sec. to 2.741 sec.');
    csv.push('# - temporal coordinate of [4.633] denotes a still video frame at 4.633 sec.');
    csv.push('# - metadata of {""1"":""3""} indicates attribute with id "1" set to an attribute option with id "3"');

    csv.push('# SHAPE_ID = ' + JSON.stringify(_VIA_RSHAPE));
    csv.push('# FLAG_ID = ' + JSON.stringify(_VIA_METADATA_FLAG));
    csv.push('# ATTRIBUTE = ' + JSON.stringify(this.d.store.attribute));
    csv.push('# CSV_HEADER = metadata_id,file_list,flags,temporal_coordinates,spatial_coordinates,metadata');
    // build file_list for each view_id
    var vid_filesrc_str_list = {};
    var vid, fid;
    for ( var vindex in this.d.store.project.vid_list ) {
      vid = this.d.store.project.vid_list[vindex];
      var vid_filesrc_list = [];
      for ( var findex in this.d.store.view[vid].fid_list ) {
        fid = this.d.store.view[vid].fid_list[findex];
        switch(this.d.store.file[fid].loc) {
        case _VIA_FILE_LOC.LOCAL:
          if ( this.d.file_ref.hasOwnProperty(fid) ) {
            vid_filesrc_list.push( this.d.file_ref[fid].name );
          } else {
            vid_filesrc_list.push( this.d.store.file[fid].fname );
          }
          break;
        case _VIA_FILE_LOC.INLINE:
          vid_filesrc_list.push( this.d.store.file[fid].fname );
          break;
        default:
          vid_filesrc_list.push( this.d.store.file[fid].src );
        }
      }
      vid_filesrc_str_list[vid] = _via_util_obj2csv(vid_filesrc_list);
    }

    for ( var mid in this.d.store.metadata ) {
      var line = [];
      line.push( '"' + mid + '"');
      line.push( vid_filesrc_str_list[ this.d.store.metadata[mid].vid ] );
      line.push(this.d.store.metadata[mid].flg);
      line.push( _via_util_obj2csv(this.d.store.metadata[mid].z) );
      line.push( _via_util_obj2csv(this.d.store.metadata[mid].xy) );
      line.push( _via_util_obj2csv(this.d.store.metadata[mid].av) );
      csv.push(line.join(','));
    }

    var data_blob = new Blob( [csv.join('\n')],
                              {type: 'text/csv;charset=utf-8'});
    var filename = [];
    filename.push(this.d.store.project.pname.replace(' ', '-'));
    filename.push(_via_util_date_to_filename_str(Date.now()));
    filename.push('_export.csv');
    _via_util_download_as_file(data_blob, filename.join(''));
  }.bind(this));
}

_via_import_export.prototype.export_to_temporal_segments_csv = function() {
  return new Promise( function(ok_callback, err_callback) {
    var csv = [];

    var attribute = {}
    for ( var aid in this.d.store.attribute ) {
      attribute[aid] = this.d.store.attribute[aid].aname;
    }

    csv.push('# Exported using VGG Image Annotator (http://www.robots.ox.ac.uk/~vgg/software/via)');
    csv.push('# CSV_HEADER = metadata_id,file_list,temporal_segment_start,temporal_segment_end,metadata');
    // build file_list for each view_id
    var vid_filesrc_str_list = {};
    var vid, fid;
    for ( var vindex in this.d.store.project.vid_list ) {
      vid = this.d.store.project.vid_list[vindex];
      var vid_filesrc_list = [];
      for ( var findex in this.d.store.view[vid].fid_list ) {
        fid = this.d.store.view[vid].fid_list[findex];
        switch(this.d.store.file[fid].loc) {
        case _VIA_FILE_LOC.LOCAL:
          if ( this.d.file_ref.hasOwnProperty(fid) ) {
            vid_filesrc_list.push( this.d.file_ref[fid].name );
          } else {
            vid_filesrc_list.push( this.d.store.file[fid].fname );
          }
          break;
        case _VIA_FILE_LOC.INLINE:
          vid_filesrc_list.push( this.d.store.file[fid].fname );
          break;
        default:
          vid_filesrc_list.push( this.d.store.file[fid].src );
        }
      }
      vid_filesrc_str_list[vid] = _via_util_obj2csv(vid_filesrc_list);
    }

    for ( var mid in this.d.store.metadata ) {
      var line = [];
      line.push( '"' + mid + '"');
      line.push( vid_filesrc_str_list[ this.d.store.metadata[mid].vid ] );
      line.push(this.d.store.metadata[mid].z[0])
      line.push(this.d.store.metadata[mid].z[1])
      var descriptive_av = {};
      for ( var aid in this.d.store.metadata[mid].av ) {
        descriptive_av[ this.d.store.attribute[aid].aname ] = this.d.store.metadata[mid].av[aid];
      }
      line.push( _via_util_obj2csv(descriptive_av) );
      csv.push(line.join(','));
    }

    var data_blob = new Blob( [csv.join('\n')],
                              {type: 'text/csv;charset=utf-8'});
    var filename = [];
    filename.push(this.d.store.project.pname.replace(' ', '-'));
    filename.push(_via_util_date_to_filename_str(Date.now()));
    filename.push('_export.csv');
    _via_util_download_as_file(data_blob, filename.join(''));
  }.bind(this));
}

_via_import_export.prototype.export_to_webvtt = function() {

  return new Promise( function(ok_callback, err_callback) {
    var data_list = [this.d_RH, this.d_LH];
    var str_list = ['RH', 'LH'];
    for ( var ix in data_list){
      var csv = [];
  
      var attribute = {}
      for ( var aid in data_list[ix].store.attribute ) {
        attribute[aid] = data_list[ix].store.attribute[aid].aname;
      }
  
      csv.push('WEBVTT');
      csv.push('');
      // build file_list for each view_id
      var vid_filesrc_str_list = {};
      var vid, fid;
      for ( var vindex in data_list[ix].store.project.vid_list ) {
        vid = data_list[ix].store.project.vid_list[vindex];
        var vid_filesrc_list = [];
        for ( var findex in data_list[ix].store.view[vid].fid_list ) {
          fid = data_list[ix].store.view[vid].fid_list[findex];
          switch(data_list[ix].store.file[fid].loc) {
          case _VIA_FILE_LOC.LOCAL:
            if ( data_list[ix].file_ref.hasOwnProperty(fid) ) {
              vid_filesrc_list.push( data_list[ix].file_ref[fid].name );
            } else {
              vid_filesrc_list.push( data_list[ix].store.file[fid].fname );
            }
            break;
          case _VIA_FILE_LOC.INLINE:
            vid_filesrc_list.push( data_list[ix].store.file[fid].fname );
            break;
          default:
            vid_filesrc_list.push( data_list[ix].store.file[fid].src );
          }
        }
        vid_filesrc_str_list[vid] = _via_util_obj2csv(vid_filesrc_list);
      }
  
      for ( var mid in data_list[ix].store.metadata ) {
        var tstart = _via_seconds_to_hh_mm_ss_ms(data_list[ix].store.metadata[mid].z[0]);
        var tstart_str = tstart[0] + ':' + tstart[1] + ':' + tstart[2] + '.' + tstart[3];
        var tend = _via_seconds_to_hh_mm_ss_ms(data_list[ix].store.metadata[mid].z[1]);
        var tend_str = tend[0] + ':' + tend[1] + ':' + tend[2] + '.' + tend[3];
        var subtitle = [];
        for ( var aid in data_list[ix].store.metadata[mid].av ) {
          subtitle.push(data_list[ix].store.metadata[mid].av[aid]);
        }
        var subtitle_str = subtitle.join(' ');
        csv.push(tstart_str + ' --> ' + tend_str);
        csv.push(subtitle.join(' '))
        csv.push('');
      }
      var data_blob = new Blob( [csv.join('\n')],
                                {type: 'text/vtt;charset=utf-8'});
      var filename = [];
      filename.push(data_list[ix].store.project.pname);
      filename.push(str_list[ix]);
      filename.push('.vtt');
      _via_util_download_as_file(data_blob, filename.join(''));
    }
  }.bind(this));
}

_via_import_export.prototype.export_log = function() {
  return new Promise( function(ok_callback, err_callback) {
    var csv = [];

    var attribute = {}
    for ( var aid in this.d.store.attribute ) {
      attribute[aid] = this.d.store.attribute[aid].aname;
    }

    csv.push('TEXT');
    csv.push('');
    // build file_list for each view_id
    var vid_filesrc_str_list = {};
    var vid, fid;
    for ( var vindex in this.d.store.project.vid_list ) {
      vid = this.d.store.project.vid_list[vindex];
      var vid_filesrc_list = [];
      for ( var findex in this.d.store.view[vid].fid_list ) {
        fid = this.d.store.view[vid].fid_list[findex];
        switch(this.d.store.file[fid].loc) {
        case _VIA_FILE_LOC.LOCAL:
          if ( this.d.file_ref.hasOwnProperty(fid) ) {
            vid_filesrc_list.push( this.d.file_ref[fid].name );
          } else {
            vid_filesrc_list.push( this.d.store.file[fid].fname );
          }
          break;
        case _VIA_FILE_LOC.INLINE:
          vid_filesrc_list.push( this.d.store.file[fid].fname );
          break;
        default:
          vid_filesrc_list.push( this.d.store.file[fid].src );
        }
      }
      vid_filesrc_str_list[vid] = _via_util_obj2csv(vid_filesrc_list);
    }

    for ( var mid in this.d.log ) {
      debugger;
      var log_line = this.d.log[mid]
      csv.push(log_line);
      csv.push('');
    }
    var data_blob = new Blob( [csv.join('\n')],
                              {type: 'text/vtt;charset=utf-8'});
    var filename = [];
    filename.push(this.d.store.project.pname);
    filename.push('_log.txt');
    _via_util_download_as_file(data_blob, filename.join(''));
  }.bind(this));
}

_via_import_export.prototype.import_from_webvtt = function(webvtt_str, vid, subtitle_aid) {
  return new Promise( function(ok_callback, err_callback) {
    var line_split_regex = new RegExp('\n|\r|\r\n', 'g');
    var webvtt_lines = webvtt_str.split(line_split_regex);
    var metadata_list = [];
    for(var i=0; i<webvtt_lines.length; ) {
      if(webvtt_lines[i].includes(' --> ')) {
        var timestamp_tokens = webvtt_lines[i].split(' --> ');
        var starttime_sec = _via_hh_mm_ss_ms_to_seconds(timestamp_tokens[0]);
        var endtime_sec = _via_hh_mm_ss_ms_to_seconds(timestamp_tokens[1]);

        var subtitle_text = [];
        var end_of_subtitle_text = false;
        var offset = 1;
        while(!end_of_subtitle_text) {
          if ((i+offset) >= webvtt_lines.length) {
            break;
          }
          if(webvtt_lines[i + offset].includes[' --> '] ||
             webvtt_lines[i + offset] == '') {
            end_of_subtitle_text = true;
            if(webvtt_lines[i + offset].includes['']) {
              offset = offset + 1;
            }
            break;
          } else {
            subtitle_text.push(webvtt_lines[i + offset]);
            offset = offset + 1;
          }
        }
        if (subtitle_text["0"].indexOf(',') > -1){
          var top5 = subtitle_text
          var top1 = [subtitle_text["0"].split(',')[0]];
        }
        var av = {}
        av[subtitle_aid] = top1.join(' ');
        metadata_list.push({'vid': vid,
                            'z':[starttime_sec, endtime_sec],
                            'xy':[],
                            'av': av,
                            'top5': top5
                           });
        i = i + offset;
      } else {
        i = i + 1;
      }
    }
    this.d.metadata_add_bulk(metadata_list, true);
  }.bind(this));
}
</script>
<!-- END: Contents of file: ../../src/js/_via_import_export.js-->

<!-- START: Contents of file: _via_file_annotator.js-->
<script>
/**
 * @class
 * @classdesc Manages video and audio file for subtitle annotator
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 9 Oct. 2020
 */

'use strict';

function _via_file_annotator(view_annotator, data, vid, file_label, container) {
  this._ID = '_via_file_annotator_';
  this.va = view_annotator;
  this.d = data;
  this.vid = vid;
  this.file_label = file_label;
  this.c = container;

  this.last_paused_time = 0.0;

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  _via_event.call( this );

  this._init();
}

_via_file_annotator.prototype._init = function() {
  if ( this.d.store.view[this.vid].fid_list.length !== 1 ) {
    console.warn('_via_file_annotator() can only operate on a single file!');
    return;
  }

  if ( ! this.d.store.config.ui.hasOwnProperty('file_metadata_editor_visible') ) {
    this.d.store.config.ui['file_metadata_editor_visible'] = true;
  }
  if ( ! this.d.store.config.ui.hasOwnProperty('spatial_metadata_editor_visible') ) {
    this.d.store.config.ui['spatial_metadata_editor_visible'] = true;
  }

  this.fid = this.d.store.view[this.vid].fid_list[0];
}

_via_file_annotator.prototype._file_load_show_error_page = function() {
  this.c.innerHTML = '';
  var page = document.createElement('div');
  page.setAttribute('class', 'error_page');

  var title = document.createElement('h1');
  title.innerHTML = 'File Not Found!';
  page.appendChild(title);

  var msg = document.createElement('p');
  msg.innerHTML = 'File "<code>' + this.d.file_get_uri(this.fid) + '</code>" not found. ';
  msg.innerHTML += 'VIA application will automatically reload this file when you update one of the properties below.';
  page.appendChild(msg);

  var table = document.createElement('table');
  var filename_row = document.createElement('tr');
  var filename_label = document.createElement('td');
  filename_label.innerHTML = 'Filename';
  var filename_cell = document.createElement('td');
  var filename_input = document.createElement('input');
  filename_input.setAttribute('type', 'text');
  filename_input.setAttribute('value', this.d.store.file[this.fid].fname);
  filename_input.setAttribute('data-pname', 'fname');
  filename_input.addEventListener('change', this._file_on_attribute_update.bind(this));
  filename_cell.appendChild(filename_input);
  filename_row.appendChild(filename_label);
  filename_row.appendChild(filename_cell);
  page.appendChild(filename_row);

  var filetype_row = document.createElement('tr');
  var filetype_label = document.createElement('td');
  filetype_label.innerHTML = 'File Type';
  filetype_row.appendChild(filetype_label);
  var filetype_select = document.createElement('select');
  filetype_select.setAttribute('data-pname', 'type');
  filetype_select.addEventListener('change', this._file_on_attribute_update.bind(this));

  for ( var filetype in _VIA_FILE_TYPE ) {
    var oi = document.createElement('option');
    oi.setAttribute('value', _VIA_FILE_TYPE[filetype]);
    oi.innerHTML = filetype;
    if ( this.d.store.file[this.fid].type === _VIA_FILE_TYPE[filetype] ) {
      oi.setAttribute('selected', '');
    }
    filetype_select.appendChild(oi);
  }
  var filetype_select_cell = document.createElement('td');
  filetype_select_cell.appendChild(filetype_select);
  filetype_row.appendChild(filetype_select_cell);
  page.appendChild(filetype_row);

  var fileloc_row = document.createElement('tr');
  var fileloc_label = document.createElement('td');
  fileloc_label.innerHTML = 'File Location';
  fileloc_row.appendChild(fileloc_label);
  var fileloc_select = document.createElement('select');
  fileloc_select.setAttribute('data-pname', 'loc');
  fileloc_select.addEventListener('change', this._file_on_attribute_update.bind(this));
  for ( var fileloc in _VIA_FILE_LOC ) {
    var oi = document.createElement('option');
    oi.setAttribute('value', _VIA_FILE_LOC[fileloc]);
    oi.innerHTML = fileloc;
    if ( this.d.store.file[this.fid].loc === _VIA_FILE_LOC[fileloc] ) {
      oi.setAttribute('selected', '');
    }
    fileloc_select.appendChild(oi);
  }
  var fileloc_cell = document.createElement('td');
  fileloc_cell.appendChild(fileloc_select);
  if ( this.d.store.file[this.fid].loc !== _VIA_FILE_LOC.LOCAL ) {
    var fileloc = this.d.store.file[this.fid].loc;
    var locprefix_input = document.createElement('input');
    locprefix_input.setAttribute('type', 'text');
    locprefix_input.setAttribute('value', this.d.store.config.file.loc_prefix[fileloc]);
    locprefix_input.setAttribute('data-pname', 'loc_prefix');
    locprefix_input.setAttribute('title', 'Location prefix (or path) that will be automatically added to file locations. For example, if you add "http://www.mysite.com/data/images/" as the location prefix, all your images will be sourced from this site.');
    locprefix_input.addEventListener('change', this._file_on_attribute_update.bind(this));
    fileloc_cell.appendChild(locprefix_input);
  }
  fileloc_row.appendChild(fileloc_cell);
  page.appendChild(fileloc_row);

  var filesrc_row = document.createElement('tr');
  var filesrc_label = document.createElement('td');
  filesrc_label.innerHTML = 'File Source';
  filesrc_row.appendChild(filesrc_label);
  var filesrc_input;
  if ( this.d.store.file[this.fid].loc === _VIA_FILE_LOC.LOCAL ) {
    filesrc_input = document.createElement('input');
    filesrc_input.setAttribute('type', 'file');
    if ( this.d.file_ref[this.fid] ) {
      filesrc_input.setAttribute('files', [ this.d.file_ref[this.fid] ]);
    }
  } else {
    if ( this.d.store.file[this.fid].loc === _VIA_FILE_LOC.INLINE ) {
      filesrc_input = document.createElement('textarea');
      filesrc_input.setAttribute('rows', 5);
      filesrc_input.setAttribute('cols', 100);
      filesrc_input.innerHTML = this.d.store.file[this.fid].src;
    } else {
      filesrc_input = document.createElement('input');
      filesrc_input.setAttribute('type', 'text');
      filesrc_input.setAttribute('value', this.d.store.file[this.fid].src)
    }
  }
  filesrc_input.setAttribute('data-pname', 'src');
  filesrc_input.addEventListener('change', this._file_on_attribute_update.bind(this));
  var filesrc_cell = document.createElement('td');
  filesrc_cell.appendChild(filesrc_input);
  filesrc_row.appendChild(filesrc_cell);
  page.appendChild(filesrc_row);

  // control buttons
  var bpanel = document.createElement('p');
  var reload = document.createElement('button');
  reload.innerHTML = 'Reload File';
  reload.addEventListener('click', function() {
    this.va.view_show(this.vid);
  }.bind(this));
  bpanel.appendChild(reload);
  page.appendChild(bpanel);

  this.c.appendChild(page);
}

_via_file_annotator.prototype._file_on_attribute_update = function(e) {
  var pname = e.target.dataset.pname;
  var pvalue = '';
  switch(pname) {
  case 'loc_prefix':
  case 'fname':
    pvalue = e.target.value;
    break;
  case 'type':
  case 'loc':
    pvalue = parseInt(e.target.options[e.target.selectedIndex].value);
    break;
  case 'src':
    if ( this.d.store.file[this.fid].loc === _VIA_FILE_LOC.LOCAL ) {
      if ( e.target.files.length ) {
        pvalue = e.target.files[0];
      }
    } else {
      if ( this.d.store.file[this.fid].loc === _VIA_FILE_LOC.INLINE ) {
        pvalue = e.target.innerHTML;
      } else {
        pvalue = e.target.value;
      }
    }
    break;
  }

  this.d.file_update(this.fid, pname, pvalue).then( function(ok) {
    this.va.view_show(this.vid);
  }.bind(this), function(err) {
    _via_util_msg_show('Failed to update properties of file: ' + err );
  }.bind(this));
}

_via_file_annotator.prototype._file_load = function() {
  return new Promise( function(ok_callback, err_callback) {
    this.media_div = this._file_create_html_element();
    this.file_html_element = this.media_div.children['0']
    this.file_html_element.setAttribute('title', this.d.store.file[this.fid].fname);
    var file_src = this.d.file_get_src(this.d.store.file[this.fid].fid);
    if ( file_src === '' ) {
      this.d.file_free_resources(this.fid);
      this._file_load_show_error_page();
      err_callback();
      return;
    } else {
      this.file_html_element.setAttribute('src', file_src);
    }

    this.file_html_element.addEventListener('load', function() {
      //console.log('load:' + this.fid + ', now freeing resources')
      this._file_html_element_ready();
      ok_callback();
    }.bind(this));
    this.file_html_element.addEventListener('loadeddata', function() {
      //console.log('loaddata:' + this.fid + ', now freeing resources')
      this._file_html_element_ready();
      ok_callback();
    }.bind(this));
    this.file_html_element.addEventListener('abort', function(e) {
      //console.log('abort:' + this.fid + ', now freeing resources')
      _via_util_msg_show('Failed to load file [' + this.d.store.file[this.fid].fname + '] (' + e + ')' );
      this._file_load_show_error_page();
      err_callback();
    }.bind(this));
    this.file_html_element.addEventListener('stalled', function(e) {
      //console.log('stalled:' + this.fid + ', now freeing resources')
      _via_util_msg_show('Failed to load file [' + this.d.store.file[this.fid].fname + '] (' + e + ')' );
      this._file_load_show_error_page();
      err_callback();
    }.bind(this));
    this.file_html_element.addEventListener('error', function(e) {
      //console.log('error:' + this.fid + ', now freeing resources')
      _via_util_msg_show('Failed to load file [' + this.d.store.file[this.fid].fname + '] (' + e + ')' );
      this._file_load_show_error_page();
      err_callback();
    }.bind(this));
  }.bind(this));
}

_via_file_annotator.prototype._file_create_html_element = function() {
  var media;
  var media_div;
  switch( this.d.store.file[this.fid].type ) {
  case _VIA_FILE_TYPE.VIDEO:
    media = document.createElement('video');
    media.setAttribute('style', 'position:relative;width: calc(98% - 70px); height:unset');
    media.setAttribute('controls', 'true');
    media.setAttribute('playsinline', 'true');
    media.setAttribute('loop', 'false');
    //media.setAttribute('crossorigin', 'anonymous');
    // @todo : add subtitle track for video
    media.setAttribute('preload', 'auto');
    //media.addEventListener('suspend', this._file_html_element_error.bind(this));
    media.addEventListener('pause', function(e) {
      this.last_paused_time = media.currentTime;
    }.bind(this));
    media_div = document.createElement('div');
    media_div.setAttribute('id', 'stage');
    media_div.setAttribute('style', "background:#eee;overflow:hidden;position:relative;width: calc(98% - 70px)")
    media_div.appendChild(media)
    return media_div;

  case _VIA_FILE_TYPE.IMAGE:
    media = document.createElement('img');
    break;

  case _VIA_FILE_TYPE.AUDIO:
    media = document.createElement('audio');
    media.setAttribute('controls', '');
    // @todo : add subtitle track for video
    media.setAttribute('preload', 'auto');
    break;

  default:
    console.warn('unknown file type = ' + this.d.store.file[this.fid].type);
  }
  return media;
}

_via_file_annotator.prototype._file_html_element_compute_scale = function() {
  var maxh = this.c.clientHeight;
  var maxw = this.c.clientWidth;

  // original size of the content
  var cw0, ch0;
  switch( this.d.store.file[this.fid].type ) {
  case _VIA_FILE_TYPE.VIDEO:
    cw0 = this.file_html_element.videoWidth;
    ch0 = this.file_html_element.videoHeight;
    break;
  case _VIA_FILE_TYPE.IMAGE:
    cw0 = this.file_html_element.naturalWidth;
    ch0 = this.file_html_element.naturalHeight;
    break;

  case _VIA_FILE_TYPE.AUDIO:
    this.left_pad = 0;
    this.file_html_element_size_css = '';
    return;
    break;
  }

  var ar = cw0/ch0;
  var ch = maxh;
  var cw = Math.floor(ar * ch);
  if ( cw > maxw ) {
    cw = maxw;
    ch = Math.floor(cw/ar);
  }
  this.cwidth = cw;
  this.cheight = ch;
  this.cscale = ch0/ch; // x  = cscale * cx
  this.fscale = 1 / this.cscale; // cx = fscale * x
  this.original_width = cw0;
  this.original_height = ch0;
  this.file_html_element_size_css = 'width:' + cw + 'px;height:' + ch + 'px;';

  switch( this.d.store.config.ui.file_content_align ) {
  case 'center':
    this.left_pad = Math.floor( (maxw - this.cwidth) / 2 );
    this.file_html_element_size_css += 'left:' + this.left_pad + 'px;';
    break;
  case 'right':
    this.left_pad = maxw - this.cwidth;
    this.file_html_element_size_css += 'left:' + this.left_pad + 'px;';
    break;
  default:
    this.file_html_element_size_css += 'left:0px;';
  }
}

//
// event listeners
//
_via_file_annotator.prototype._file_html_element_ready = function() {
  //_via_util_msg_show('Loaded file [' + this.d.store.file[this.fid].fname + ']' );
  this._file_html_element_compute_scale();
  this.file_html_element.setAttribute('style', this.file_html_element_size_css);
  this.file_html_element.setAttribute('id', 'file_content');
  // this.c.appendChild(this.file_html_element);
  this.c.appendChild(this.media_div);
  var control = document.createElement('div');
  control.setAttribute('id','controls')
  control.setAttribute('style','width:70px; position:unset')
  this.c.appendChild(control)
  this.zoom_video();

}






/*
  Zooming and rotating HTML5 video player
  Homepage: http://github.com/codepo8/rotatezoomHTML5video
  Copyright (c) 2011 Christian Heilmann
  Code licensed under the BSD License:
  http://wait-till-i.com/license.txt
*/
_via_file_annotator.prototype.zoom_video = function(){

  /* predefine zoom and rotate */
    var zoom = 1,
        rotate = 0;
  
  /* Grab the necessary DOM elements */
    var stage = document.getElementById('stage'),
        v = document.getElementsByTagName('video')[0],
        controls = document.getElementById('controls');
    
  /* Array of possible browser specific settings for transformation */
    var properties = ['transform', 'WebkitTransform', 'MozTransform',
                      'msTransform', 'OTransform'],
        prop = properties[0];
  
  /* Iterators and stuff */    
    var i,j,t;
    
  /* Find out which CSS transform the browser supports */
    for(i=0,j=properties.length;i<j;i++){
      if(typeof stage.style[properties[i]] !== 'undefined'){
        prop = properties[i];
        break;
      }
    }
  
  /* Position video */
    v.style.left = 0;
    v.style.top = 0;
  
  /* If there is a controls element, add the player buttons */
  /* TODO: why does Opera not display the rotation buttons? */
    if(controls){
      controls.innerHTML =  '<div id="change" style="position:relative;width:70px;">' +
                              '<button class="zoomin" style="font-size:150%;text-align:center;display:block; position:unset; top:unset">+</button>' +
                              '<button class="zoomout" style="font-size:150%;text-align:center;display:block; position:unset; top:unset">-</button>' +
                              '<button class="left" style="font-size:150%;text-align:center;display:block; position:unset; top:unset"></button>' +
                              '<button class="right" style="font-size:150%;text-align:center;display:block; position:unset; top:unset"></button>' +
                              '<button class="up" style="font-size:150%;text-align:center;display:block; position:unset; top:unset"></button>' +
                              '<button class="down" style="font-size:150%;text-align:center;display:block; position:unset; top:unset"></button>' +
                              '<button class="rotateleft" style="font-size:150%;text-align:center;display:block; position:unset; top:unset">&#x21bb;</button>' +
                              '<button class="rotateright" style="font-size:150%;text-align:center;display:block; position:unset; top:unset">&#x21ba;</button>' +
                              '<button class="reset" style="font-size:150%;text-align:center;display:block; position:unset; top:unset">reset</button>' +
                            '</div>';
    }
  
  /* If a button was clicked (uses event delegation)...*/
    controls.addEventListener('click',function(e){
      t = e.target;
      if(t.nodeName.toLowerCase()==='button'){
  
  /* Check the class name of the button and act accordingly */    
        switch(t.className){
  
  /* Toggle play functionality and button label */    
          case 'play':
            if(v.paused){
              v.play();
              t.innerHTML = 'pause';
            } else {
              v.pause();
              t.innerHTML = 'play';
            }
          break;
  
  /* Increase zoom and set the transformation */
          case 'zoomin':
            zoom = zoom + 0.1;
            v.style[prop]='scale('+zoom+') rotate('+rotate+'deg)';
          break;
  
  /* Decrease zoom and set the transformation */
          case 'zoomout':
            zoom = zoom - 0.1;
            v.style[prop]='scale('+zoom+') rotate('+rotate+'deg)';
          break;
  
  /* Increase rotation and set the transformation */
          case 'rotateleft':
            rotate = rotate + 5;
            v.style[prop]='rotate('+rotate+'deg) scale('+zoom+')';
          break;
  /* Decrease rotation and set the transformation */
          case 'rotateright':
            rotate = rotate - 5;
            v.style[prop]='rotate('+rotate+'deg) scale('+zoom+')';
          break;
  
  /* Move video around by reading its left/top and altering it */
          case 'left':
            v.style.left = (parseInt(v.style.left,10) - 5) + 'px';
          break;
          case 'right':
            v.style.left = (parseInt(v.style.left,10) + 5) + 'px';
          break;
          case 'up':
            v.style.top = (parseInt(v.style.top,10) - 5) + 'px';
          break;
          case 'down':
            v.style.top = (parseInt(v.style.top,10) + 5) + 'px';
          break;
  
  /* Reset all to default */
          case 'reset':
            zoom = 1;
            rotate = 0;
            v.style.top = 0 + 'px';
            v.style.left = 0 + 'px';
            v.style[prop]='rotate('+rotate+'deg) scale('+zoom+')';
          break;
        }        
  
        e.preventDefault();
      }
    },false);
  };
  </script>
<!-- END: Contents of file: _via_file_annotator.js-->
<!-- START: Contents of file: _via_temporal_segmenter.js-->
<script>
/**
 * @class
 * @classdesc Marks time segments containing subtitle text of a {@link https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement|HTMLMediaElement}
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 9 Oct. 2020
 * @fires _via_temporal_segmenter#segment_add
 * @fires _via_temporal_segmenter#segment_del
 * @fires _via_temporal_segmenter#segment_edit
 * @param {Element} container HTML container element like <div>
 * @param {HTMLMediaElement} media_element HTML video of audio
 */

'use strict';

function _via_temporal_segmenter(file_annotator, container, vid, groupby_aid, data, media_element) {
  this._ID = '_via_temporal_segmenter_';
  this.fa = file_annotator;
  this.c = container;
  this.vid = vid;
  this.groupby_aid = groupby_aid;
  this.d = data;
  this.m = media_element;

  this.group = {};
  this.gid_list = [];
  this.SUBTITLE_GID = '__video_subtitle__';
  this.selected_gindex = -1;
  this.selected_mindex = -1;
  this.edge_show_time = -1;

  // spatial mid
  this.smid = {};

  this.DRAW_LINE_WIDTH = 2;
  this.EDGE_UPDATE_TIME_DELTA = 1/50;  // in sec
  this.TEMPORAL_SEG_MOVE_OFFSET = 1;   // in sec
  this.DEFAULT_TEMPORAL_SEG_LEN = 1;   // in sec
  this.TEMPORAL_SEG_RADIUS = 1;        // in units of char width
  this.GTIMELINE_HEIGHT = 12;          // units of char width
  this.GTIMELINE_ZOOM_OFFSET = 4;      // in pixels
  this.DEFAULT_WIDTH_PER_SEC = 8;      // units of char width
  this.GID_COL_WIDTH = 15;             // units of char width
  this.METADATA_CONTAINER_HEIGHT = 22; // units of char width
  this.METADATA_EDGE_TOL = 0.1;
  this.TEMPORAL_SEG_EDGE_SNAP_TOL = 0.01 //0.15; // in sec.
  this.GTIMELINE_REGION_MARKER_MOUSE_TOL = 0.1; // in sec.

  this.PLAYBACK_MODE = { NORMAL:'1', REVIEW_SEGMENT:'2', REVIEW_GAP:'3' };
  this.current_playback_mode = this.PLAYBACK_MODE.NORMAL;

  this.metadata_move_is_ongoing = false;
  this.metadata_resize_is_ongoing = false;
  this.timeline_move_is_ongoing = false;
  this.gtimeline_drag_ongoing = false;
  this.metadata_resize_edge_index = -1;
  this.metadata_ongoing_update_x = [0, 0];
  this.metadata_move_start_x = 0;
  this.metadata_move_dx = 0;
  this.metadata_last_added_mid = '';
  this.tmetadata_last_mousedown_x = -1;

  this.show_audio = false;             // experimental, hence disabled by default
  this.audio_analyser_active = false;

  // start automatic rendering of selected gid when user interaction is ongoing (i.e. mousedown, movemove)
  // and stop when user interaction finishes (ie. mouseup)
  this.auto_render_tmetadata_selected_gid = false;

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  _via_event.call( this );
  this.d.on_event('attribute_update', this._ID, this._on_event_attribute_update.bind(this));
  this.d.on_event('metadata_update_bulk', this._ID, this._on_event_metadata_update_bulk.bind(this));
  this.d.on_event('metadata_add_bulk', this._ID, this._on_event_metadata_add_bulk.bind(this));

  if ( ! this.m instanceof HTMLMediaElement ) {
    throw 'media element must be an instance of HTMLMediaElement!';
  }

  // colour
  this.COLOR_LIST = ["#E69F00", "#56B4E9", "#009E73", "#D55E00", "#CC79A7", "#F0E442"];
  this.NCOLOR = this.COLOR_LIST.length;

  this.current_playback_mode = this.PLAYBACK_MODE.NORMAL;

  this._init(this.groupby_aid);
}

_via_temporal_segmenter.prototype._init = function(groupby_aid) {
  try {
    this.fid = this.d.store.view[this.vid].fid_list[0];
    this.file = this.d.store.file[this.fid];

    this._group_init(groupby_aid);

    this.c.innerHTML = '';
    this._init_canvas_settings();
    this._tmetadata_init();

    // trigger the update of animation frames
    this._redraw_all();
    this._redraw_timeline();
  } catch(err) {
    console.log(err);
  }
}

_via_temporal_segmenter.prototype._init_canvas_settings = function() {
  var canvas = document.createElement('canvas');
  var ctx = canvas.getContext('2d', {alpha:false});
  ctx.font = '10px Sans';
  this.char_width = ctx.measureText('M').width;
  this.padx = 2*this.char_width;
  this.pady = this.char_width;
  this.lineh = Math.floor(this.char_width);
  this.linehn = []; // contains multiples of line_height for future ref.
  for ( var i = 0; i < 40; ++i ) {
    this.linehn[i] = i * this.lineh;
  }
  this.linehb2 = Math.floor(this.char_width/2);
}

//
// All animation frame routines
//
_via_temporal_segmenter.prototype._redraw_all = function() {
  window.requestAnimationFrame(this._redraw_all.bind(this));
  var tnow = this.m.currentTime;
  //console.log('tnow=' + tnow + ', this.tmetadata_gtimeline_tstart=' + this.tmetadata_gtimeline_tstart + ', this.tmetadata_gtimeline_tend=' + this.tmetadata_gtimeline_tend);
  var t_last_paused = this.m.last_paused_time;
  this._update_playback_rate(tnow);

  if ( tnow < this.tmetadata_gtimeline_tstart ||
       tnow > this.tmetadata_gtimeline_tend
     ) {
    if ( ! this.m.paused ) {
      var new_tstart = Math.floor(tnow);
      this._tmetadata_boundary_update(new_tstart)
      this._tmetadata_group_gid_draw_all();
      this._tmetadata_gtimeline_draw();
    } else {
      //this.m.currentTime = this.tmetadata_gtimeline_tstart;
      var new_tstart = Math.floor(tnow);
      this._tmetadata_boundary_update(new_tstart)
      this._tmetadata_group_gid_draw_all();
      this._tmetadata_gtimeline_draw();
    }
  }

  // lock playback in the selected temporal segment
  if ( this.selected_mindex !== -1 ) {
    if ( ! this.m.paused ) {
      var t = this.d.store.metadata[this.selected_mid].z;
      if ( tnow > t[1] ) {
        this.m.currentTime = t[0];
      }
      if ( tnow < t[0] ) {
        this.m.currentTime = t[0];
      }
    }
  }

  //this._redraw_timeline(); // this is not required

  // draw marker to show current time in group timeline and group metadata
  this._tmetadata_draw_currenttime_mark(tnow, this.fa.last_paused_time);

  if(this.show_audio) {
    this._tmetadata_gtimeline_draw_audio();
  }
}

_via_temporal_segmenter.prototype._update_playback_rate = function(t) {
  //console.log(this.current_playback_mode + ':' + t)
  if ( this.current_playback_mode !== this.PLAYBACK_MODE.NORMAL ) {
    var mindex = this._tmetadata_group_gid_metadata_at_time(t);
    if ( mindex !== -1 ) {
      if ( this.current_playback_mode === this.PLAYBACK_MODE.REVIEW_SEGMENT ) {
        this._toolbar_playback_rate_set(1);
      } else {
        this._toolbar_playback_rate_set(10);
      }
    } else {
      if ( this.current_playback_mode === this.PLAYBACK_MODE.REVIEW_GAP ) {
        this._toolbar_playback_rate_set(1);
      } else {
        this._toolbar_playback_rate_set(10);
      }
    }
  } else {
    //this._toolbar_playback_rate_set(1);
  }
}

_via_temporal_segmenter.prototype._redraw_timeline = function() {
  // draw group timeline
  this._tmetadata_gtimeline_draw();
}

//
// Metadata Panel
//
_via_temporal_segmenter.prototype._tmetadata_init = function() {
  this.tmetadata_container = document.createElement('div');
  this.tmetadata_container.setAttribute('class', 'tmetadata_container');

  // group timeline container
  var gheader_container = document.createElement('div');
  gheader_container.setAttribute('class', 'gheader_container');
  var gheader_grid = document.createElement('div');
  gheader_grid.setAttribute('class', 'onecolgrid');

  this.gtimeline_container = document.createElement('div');
  this.gtimeline_container.setAttribute('class', 'gtimeline_container');
  gheader_grid.appendChild(this.gtimeline_container);

  gheader_container.appendChild(gheader_grid);
  this.tmetadata_container.appendChild(gheader_container);
  this.c.appendChild(this.tmetadata_container);

  // initialise the gtimeline (timeline for temporal segmentation, requires width of container)
  this.timeline_container_width = this.gtimeline_container.clientWidth;
  this.timeline_container_height = this.gtimeline_container.clientHeight;
  this.tmetadata_timelinew = this.timeline_container_width - Math.floor(2 * this.padx);
  this.tmetadata_width_per_sec = this.linehn[this.DEFAULT_WIDTH_PER_SEC];
  this._tmetadata_boundary_update(0); // determine the boundary of gtimeline

  this._tmetadata_gtimeline_init(); // initialize gtimeline canvas
  this.gtimeline_container.appendChild(this.gtimeline);

  this.gmetadata_container = document.createElement('div');
  this.gmetadata_container.setAttribute('class', 'gmetadata_container');

  var gtimeline_container_maxheight = this.fa.va.gtimeline_container_height - this.METADATA_CONTAINER_HEIGHT + 5; // 5 is offset obtained using visual inspection
  this.gmetadata_container.setAttribute('style', 'max-height:' + gtimeline_container_maxheight + 'ch;');

  this.gmetadata_grid = document.createElement('div');
  this.gmetadata_grid.setAttribute('class', 'onecolgrid');
  this._tmetadata_gmetadata_update();
  this.gmetadata_container.appendChild(this.gmetadata_grid);
  this.tmetadata_container.appendChild(this.gmetadata_container);
  // Note: this.tmetadata_container has already been added to parent container

  if ( this.gid_list.length ) {
    this._tmetadata_group_gid_sel(0);
  }

  // move boundary so that first subtitle is visible
  if(this.group[this.selected_gid].length) {
    var mid0 = this.group[this.selected_gid][0];
    var t0 = this.d.store.metadata[mid0].z[0];
    var offset = 0;
    if(t0 > 2.0) {
      offset = -2.0;
    }
    this._tmetadata_boundary_move(offset, t0);
  }

  // Finally, draw all the temporal segments associated with all gid
  this._tmetadata_group_gid_draw_all();
}

_via_temporal_segmenter.prototype._tmetadata_audio_init = function() {
  try {
    this.audioctx = new (window.AudioContext || window.webkitAudioContext)();
    this.analyser = this.audioctx.createAnalyser();
    this.audiosrc = this.audioctx.createMediaElementSource(this.m);
    this.audiosrc.connect(this.analyser);
    this.analyser.connect(this.audioctx.destination)

    this.analyser.fftSize = 32;
    this.audio_data = new Float32Array(this.analyser.frequencyBinCount);
    this.audio_analyser_active = true;
  } catch(ex) {
    this.audio_analyser_active = false;
  }
}

_via_temporal_segmenter.prototype._tmetadata_gmetadata_update = function() {
  this.gmetadata_grid.innerHTML = '';

  // initialise the gmetadata (temporal segment corresponding to each group)
  this.gcanvas = {}; // contains a list of canvas for each group
  this.gctx = {};    // contains the corresponding drawing context
  var gindex, gid;
  for ( gindex in this.gid_list ) {
    gid = this.gid_list[gindex];

    // column containing temporal segments for this value timeline-id
    this._tmetadata_group_gid_init(gid);
    var gid_metadata_container = document.createElement('div');
    gid_metadata_container.appendChild(this.gcanvas[gid]);
    this.gmetadata_grid.appendChild(gid_metadata_container);
  }
}

_via_temporal_segmenter.prototype._tmetadata_gid_list_reorder = function(gindex_now, gindex_new) {
  var new_loc_gid = this.gid_list[gindex_new];
  this.gid_list[gindex_new] = this.gid_list[gindex_now];
  this.gid_list[gindex_now] = new_loc_gid;
  this._tmetadata_gmetadata_update();
}

_via_temporal_segmenter.prototype._tmetadata_onchange_groupby_aid = function(e) {
  this.group_aname_select.blur(); // remove selection of dropdown
  var new_groupby_aid = e.target.options[e.target.selectedIndex].value;
  this._group_init( new_groupby_aid );
  this._tmetadata_gmetadata_update();
  this._tmetadata_boundary_update(this.tmetadata_gtimeline_tstart)
  this._tmetadata_group_gid_sel(0);
  this._tmetadata_gtimeline_draw();
}

_via_temporal_segmenter.prototype._tmetadata_boundary_move = function(offset, from) {
  if(typeof(from) === 'undefined') {
    var from = this.tmetadata_gtimeline_tstart;
  }

  var new_start = Math.floor(from + offset);;
  if ( new_start >= 0 &&
       new_start < this.m.duration
     ) {
    this._tmetadata_boundary_update(new_start);
    if ( this.m.currentTime < this.tmetadata_gtimeline_tstart ) {
      this.m.currentTime = this.tmetadata_gtimeline_tstart;
    } else {
      if ( this.m.currentTime > this.tmetadata_gtimeline_tend ) {
        this.m.currentTime = this.tmetadata_gtimeline_tend;
      }
    }
  } else {
    _via_util_msg_show('Cannot move beyond the video timeline boundary! offset=' + offset + ', from=' + from);
  }
}

_via_temporal_segmenter.prototype._tmetadata_boundary_update = function(tstart) {
  this.tmetadata_gtimeline_tstart = tstart;
  this.tmetadata_gtimeline_xstart = this.padx;

  var t = this.tmetadata_gtimeline_tstart;
  var tx = this.tmetadata_gtimeline_xstart;
  var endx = tx + this.tmetadata_timelinew;
  this.tmetadata_gtimeline_mark_x = [];
  this.tmetadata_gtimeline_mark_time_str = [];
  while ( tx <= endx && t <= this.m.duration ) {
    this.tmetadata_gtimeline_mark_x.push(tx);
    this.tmetadata_gtimeline_mark_time_str.push( this._time2str(t) );

    t = t + 1;
    tx = tx + this.tmetadata_width_per_sec;
  }
  if ( t >= this.m.duration ) {
    this.tmetadata_gtimeline_tend = this.m.duration;
  } else {
    this.tmetadata_gtimeline_tend = t - 1;
  }
  this.tmetadata_gtimeline_xend = this.tmetadata_gtimeline_xstart + (this.tmetadata_gtimeline_tend - this.tmetadata_gtimeline_tstart) * this.tmetadata_width_per_sec;

  // asynchronously pull out the metadata in the current group timeline boundary
  this.tmetadata_gtimeline_mid = {};
  this._tmetadata_boundary_fetch_all_mid();
  //setTimeout( this._tmetadata_boundary_fetch_all_mid.bind(this), 0);
}

_via_temporal_segmenter.prototype._tmetadata_boundary_fetch_all_mid = function() {
  // gather all temporal mid
  for ( var gindex in this.gid_list ) {
    this._tmetadata_boundary_fetch_gid_mid( this.gid_list[gindex] );
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_draw_all = function() {
  for ( var gindex in this.gid_list ) {
    this._tmetadata_group_gid_draw( this.gid_list[gindex] );
  }
}

_via_temporal_segmenter.prototype._tmetadata_boundary_fetch_gid_mid = function(gid) {
  this.tmetadata_gtimeline_mid[gid] = [];
  var mid_list = [];
  var mindex, mid, t0, t1;
  for ( mindex in this.group[gid] ) {
    mid = this.group[gid][mindex];
    if ( this.d.store.metadata[mid].z.length === 2 &&
         this.d.store.metadata[mid].xy.length === 0
       ) {
      t0 = this.d.store.metadata[mid].z[0];
      t1 = this.d.store.metadata[mid].z[1];

      if ( (t0 >= this.tmetadata_gtimeline_tstart &&
            t0 <= this.tmetadata_gtimeline_tend) ||
           (t1 >= this.tmetadata_gtimeline_tstart &&
            t1 <= this.tmetadata_gtimeline_tend) ||
           (t0 <= this.tmetadata_gtimeline_tstart &&
            t1 >= this.tmetadata_gtimeline_tend)
         ) {
        this.tmetadata_gtimeline_mid[gid].push(mid);
      }
    }
  }
  this.tmetadata_gtimeline_mid[gid].sort( this._compare_mid_by_time.bind(this) );
}

//
// group timeline (common to all group-id and shown at top)
//
_via_temporal_segmenter.prototype._tmetadata_gtimeline_init = function() {
  this.gtimeline = document.createElement('canvas');
  this.gtimeline.setAttribute('class', 'gtimeline');
  this.gtimeline.addEventListener('mousedown', this._tmetadata_gtimeline_mousedown.bind(this));
  this.gtimeline.addEventListener('mouseup', this._tmetadata_gtimeline_mouseup.bind(this));
  this.gtimeline.addEventListener('mousemove', this._tmetadata_gtimeline_mousemove.bind(this));
  this.gtimeline.addEventListener('mouseout', this._tmetadata_gtimeline_mouseout.bind(this));

  this.gtimeline.width = this.timeline_container_width;
  this.gtimeline.height = this.linehn[this.GTIMELINE_HEIGHT];
  this.gtimelinectx = this.gtimeline.getContext('2d', {alpha:false});

  this.gtimeline.addEventListener('wheel', this._tmetadata_gtimeline_wheel_listener.bind(this));
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_wheel_listener = function(e) {
  if ( e.shiftKey ) {
    // zoom temporal segment
    if (e.deltaY < 0) {
      this._tmetadata_gtimeline_zoomin();
    } else {
      this._tmetadata_gtimeline_zoomout();
    }
  } else {
    var offset = this.TEMPORAL_SEG_MOVE_OFFSET;
    // pan temporal segment horizontally
    if (e.deltaY < 0) {
      if( (this.m.currentTime + offset) > this.m.duration) {
        offset = this.m.duration - this.m.currentTime;
      }
      this._tmetadata_boundary_move(offset);
    } else {
      if( (this.m.currentTime - offset) < 0.0) {
        offset = this.m.currentTime;
      }
      this._tmetadata_boundary_move(-offset);
    }
  }
  this._tmetadata_gtimeline_draw();
  this._tmetadata_group_gid_draw_all();
  e.preventDefault();
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_zoomin = function() {
  var wps = this.tmetadata_width_per_sec + this.GTIMELINE_ZOOM_OFFSET;
  if ( wps < this.gtimeline.width ) {
    this.tmetadata_width_per_sec = wps;
    this._tmetadata_boundary_update(this.tmetadata_gtimeline_tstart);
    this._redraw_timeline();
    this._redraw_all();
  }
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_zoomout = function() {
  var wps = this.tmetadata_width_per_sec - this.GTIMELINE_ZOOM_OFFSET;
  if ( wps > 1 ) {
    this.tmetadata_width_per_sec = wps;
    this._tmetadata_boundary_update(this.tmetadata_gtimeline_tstart);
    this._redraw_timeline();
    this._redraw_all();
  }
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_clear = function() {
  this.gtimelinectx.fillStyle = '#ffffff';
  this.gtimelinectx.fillRect(0, 0, this.gtimeline.width, this.gtimeline.height);
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_draw = function() {
  this._tmetadata_gtimeline_clear();

  // draw line
  this.gtimelinectx.strokeStyle = '#707070';
  this.gtimelinectx.fillStyle = '#707070';
  this.gtimelinectx.lineWidth = this.DRAW_LINE_WIDTH;
  this.gtimelinectx.beginPath();
  this.gtimelinectx.moveTo(this.tmetadata_gtimeline_xstart, this.linehn[3]);
  this.gtimelinectx.lineTo(this.tmetadata_gtimeline_xend, this.linehn[3]);
  this.gtimelinectx.stroke();

  // draw arrows at the end to indicate that more timeline is available
  if(Math.abs(this.tmetadata_gtimeline_tstart - 0.0) > 0.001) {
    // left arrow
    this.gtimelinectx.beginPath();
    this.gtimelinectx.moveTo(this.tmetadata_gtimeline_xstart, this.linehn[3]);
    this.gtimelinectx.lineTo(1, this.linehn[3]);
    this.gtimelinectx.lineTo(this.linehb2, this.linehn[3] - this.linehb2);
    this.gtimelinectx.lineTo(this.linehb2, this.linehn[3] + this.linehb2);
    this.gtimelinectx.lineTo(1, this.linehn[3]);
    this.gtimelinectx.stroke();
    this.gtimelinectx.fill();
  }
  if(Math.abs(this.tmetadata_gtimeline_tend - this.m.duration) > 0.001) {
    // right arrow
    this.gtimelinectx.beginPath();
    this.gtimelinectx.moveTo(this.tmetadata_gtimeline_xend, this.linehn[3]);
    this.gtimelinectx.lineTo(this.timeline_container_width - 1, this.linehn[3]);
    this.gtimelinectx.lineTo(this.timeline_container_width - this.linehb2 - 1, this.linehn[3] - this.linehb2);
    this.gtimelinectx.lineTo(this.timeline_container_width - this.linehb2 - 1, this.linehn[3] + this.linehb2);
    this.gtimelinectx.lineTo(this.timeline_container_width - 1, this.linehn[3]);
    this.gtimelinectx.stroke();
    this.gtimelinectx.fill();
  }

  if ( this.tmetadata_gtimeline_mark_x.length ) {
    // draw tick labels
    this.gtimelinectx.fillStyle = '#666666';
    this.gtimelinectx.font = '11px Sans';
    var last_mark_x = this.tmetadata_gtimeline_mark_x[0];
    var tick_width = this.gtimelinectx.measureText(this.tmetadata_gtimeline_mark_time_str[0]).width;
    var dx;
    this.gtimelinectx.beginPath();
    for ( var i = 0; i < this.tmetadata_gtimeline_mark_x.length; ++i ) {
      dx = this.tmetadata_gtimeline_mark_x[i] - last_mark_x;
      if ( i === 0 || dx > tick_width ) {
        // draw tick
        this.gtimelinectx.moveTo(this.tmetadata_gtimeline_mark_x[i], this.linehn[3]);
        this.gtimelinectx.lineTo(this.tmetadata_gtimeline_mark_x[i], this.linehn[4]);

        // draw label
        this.gtimelinectx.fillText(this.tmetadata_gtimeline_mark_time_str[i],
                                   this.tmetadata_gtimeline_mark_x[i], this.linehn[5] );
        last_mark_x = this.tmetadata_gtimeline_mark_x[i];
      } else {
        // avoid crowding of labels
        continue;
      }
    }
    // draw mark at the end
    this.gtimelinectx.moveTo(this.tmetadata_gtimeline_xend, this.linehn[3]);
    this.gtimelinectx.lineTo(this.tmetadata_gtimeline_xend, this.linehn[4]);

    this.gtimelinectx.stroke();
  }

  // the remaining vertical space (at the bottom) is used to draw audio channel amplitude
  // drawing of audio visualization is triggered by _tmetadata_init() which in
  // turn continually triggers the _tmetadata_gtimeline_draw_audio() method
  // in _redraw_all()
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_draw_audio = function() {
  if(!this.m.paused && this.audio_analyser_active) {
    var x = this._tmetadata_gtimeline_time2canvas(this.m.currentTime);
    this.analyser.getFloatTimeDomainData(this.audio_data);
    var avg = 0.0;
    for(var i=0; i<this.audio_data.length; ++i) {
      avg += Math.abs(this.audio_data[i]);
    }
    avg = avg / this.audio_data.length;

    var max_height = (this.linehn[20] - this.linehn[4]);
    var y = Math.round( avg * max_height );
    this.gtimelinectx.fillStyle = '#4d4d4d';
    this.gtimelinectx.lineWidth = this.DRAW_LINE_WIDTH;
    this.gtimelinectx.fillRect(x, Math.max(this.linehn[10], this.linehn[16] - y), 2, 2*y);
  }
}

_via_temporal_segmenter.prototype._tmetadata_draw_currenttime_mark = function(tnow, t_last_paused) {
  // clear previous mark
  this.gtimelinectx.fillStyle = '#ffffff';
  this.gtimelinectx.fillRect(this.tmetadata_gtimeline_xstart - 1, 0, this.tmetadata_timelinew, this.linehn[3] - 1);
  this.gtimelinectx.fillRect(this.tmetadata_gtimeline_xstart - 1, this.linehn[5] + 1, this.tmetadata_timelinew, this.linehn[12]);
  if ( tnow >= this.tmetadata_gtimeline_tstart &&
       tnow <= this.tmetadata_gtimeline_tend ) {
    // draw marker for video time corresponding to last paused time
    this._tmetadata_draw_time_mark(t_last_paused, this.gtimelinectx, '#cccccc', false);
    // draw marker for video time corresponding to current video frame
    this._tmetadata_draw_time_mark(tnow, this.gtimelinectx, 'black', true);
  }
}

_via_temporal_segmenter.prototype._tmetadata_draw_time_mark = function(t, ctx, color, showtime) {
  // draw vertical line video time
  var markx = this._tmetadata_gtimeline_time2canvas(t);
  this.gtimelinectx.strokeStyle = color;
  this.gtimelinectx.beginPath();
  this.gtimelinectx.moveTo(markx, 0);
  this.gtimelinectx.lineTo(markx, this.linehn[3]);
  this.gtimelinectx.moveTo(markx, this.linehn[5] + 1);
  this.gtimelinectx.lineTo(markx, this.gtimeline.height);
  this.gtimelinectx.stroke();

  if(showtime) {
    // draw current time : HH:MM:SS
    this.gtimelinectx.font = '24px Sans';
    this.gtimelinectx.fillStyle = color;
    var hhmmss = this._time2hhmmss(t);
    var hhmmss_width = this.gtimelinectx.measureText(hhmmss).width;
    var ms = this._time2ms(t);
    var ms_width = this.gtimelinectx.measureText(ms).width;

    var x_hhmmss = markx + this.linehn[1];
    var x_ms = x_hhmmss + hhmmss_width + 2;
    var total_width = hhmmss_width + ms_width + 2;
    if( (markx + total_width) > this.tmetadata_gtimeline_xend) {
      x_hhmmss = markx - total_width - this.linehn[1];
      x_ms = x_hhmmss + hhmmss_width + 2;
    }
    this.gtimelinectx.fillText(hhmmss, x_hhmmss, this.linehn[3] - this.linehb2 - 2);
    this.gtimelinectx.font = '12px Sans';
    this.gtimelinectx.fillText(ms, x_ms, this.linehn[3] - this.linehb2 - 2);
  }
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_canvas2time = function(x) {
  var T = this.tmetadata_gtimeline_tend - this.tmetadata_gtimeline_tstart;
  var W = this.tmetadata_gtimeline_xend - this.tmetadata_gtimeline_xstart;
  var dx = x - this.padx;
  return this.tmetadata_gtimeline_tstart + ((T * dx) / W);
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_time2canvas = function(t) {
  var canvas_x;
  if ( t < this.tmetadata_gtimeline_tstart ||
       t > this.tmetadata_gtimeline_tend ) {
    // clamp to canvas boundary
    if ( t < this.tmetadata_gtimeline_tstart ) {
      canvas_x = this.tmetadata_gtimeline_xstart;
    } else {
      canvas_x = this.tmetadata_gtimeline_xend;
    }
  } else {
    var sec = Math.floor(t);
    var sec_mark_index = sec - this.tmetadata_gtimeline_tstart;
    var ms = t - sec;
    var ms_x = Math.ceil(ms * this.tmetadata_width_per_sec);
    canvas_x = this.tmetadata_gtimeline_mark_x[sec_mark_index] + ms_x;
  }
  return canvas_x;
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_mousemove= function(e) {
  if(this.gtimeline_drag_ongoing) {
    var t = this._tmetadata_gtimeline_canvas2time(e.offsetX);
    this.m.currentTime = t;
  }
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_mousedown = function(e) {
  this.gtimeline_drag_ongoing = true;
  var t = this._tmetadata_gtimeline_canvas2time(e.offsetX);
  this.m.currentTime = t;
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_mouseup = function(e) {
  this.gtimeline_drag_ongoing = false;
  _via_util_msg_show('Press <span class="key">a</span> to add a new temporal segment at current time.');
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_mouseout = function(e) {
  this.gtimeline_drag_ongoing = false;
}

_via_temporal_segmenter.prototype._tmetadata_gtimeline_is_on_smark = function(t) {
  var smark_time;
  for ( var smark_time_str in this.smid ) {
    smark_time = parseFloat(smark_time_str);
    if ( Math.abs(smark_time - t) <= this.GTIMELINE_REGION_MARKER_MOUSE_TOL ) {
      return smark_time_str;
    }
  }
  return '';
}

//
// metadata for a given group-id
//
_via_temporal_segmenter.prototype._tmetadata_group_update_gid = function(e) {
  var old_gid = e.target.dataset.gid;
  var new_gid = e.target.value.trim();
  var mindex, mid;
  var av_update_list = [];
  for ( mindex in this.group[old_gid] ) {
    mid = this.group[old_gid][mindex]
    av_update_list.push( {'mid':mid,
                          'aid':this.groupby_aid,
                          'avalue':new_gid,
                         } );
  }

  this.d.metadata_update_av_bulk(this.vid, av_update_list).then( function(ok) {
    this.group[new_gid] = this.group[old_gid];
    delete this.group[old_gid];
    var gindex = this.gid_list.indexOf(old_gid);
    this.gid_list[gindex] = new_gid;

    this._tmetadata_gmetadata_update();
    delete this.tmetadata_gtimeline_mid[old_gid];
    this._tmetadata_boundary_fetch_gid_mid(new_gid);
    this._tmetadata_group_gid_draw(new_gid);

    // update selection to new_gid
    if ( this.selected_gid === old_gid ) {
      var new_gindex = this.gid_list.indexOf(new_gid);
      this._tmetadata_group_gid_sel(new_gindex);
    }
  }.bind(this), function(err) {
    console.warn('_via_data.metadata_update_av_bulk() failed');
  }.bind(this));
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_init = function(gid) {
  this.gcanvas[gid] = document.createElement('canvas');
  this.gcanvas[gid].setAttribute('data-gid', gid);
  this.gcanvas[gid].setAttribute('data-gindex', this.gid_list.indexOf(gid));
  this.gcanvas[gid].width = this.timeline_container_width;
  this.gcanvas[gid].height = this.linehn[12];
  this.gctx[gid] = this.gcanvas[gid].getContext('2d', {alpha:false});

  this.gcanvas[gid].addEventListener('mousemove', this._tmetadata_group_gid_mousemove.bind(this));
  this.gcanvas[gid].addEventListener('mousedown', this._tmetadata_group_gid_mousedown.bind(this));
  this.gcanvas[gid].addEventListener('mouseup', this._tmetadata_group_gid_mouseup.bind(this));
  this.gcanvas[gid].addEventListener('wheel', this._tmetadata_gtimeline_wheel_listener.bind(this));

  this._tmetadata_group_gid_draw(gid);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_clear = function(gid) {
  this.gctx[gid].fillStyle = '#ffffff';
  this.gctx[gid].fillRect(0, 0, this.gcanvas[gid].width, this.gcanvas[gid].height);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_draw = function(gid, debug) {
  /*
  if(typeof(debug) === 'undefined') {
    console.log('WARNING: _tmetadata_group_gid_draw() was not invoked by requestAnimationFrame()');
  }
  */

  this._tmetadata_group_gid_clear(gid);
  this._tmetadata_group_gid_draw_boundary(gid);
  this._tmetadata_group_gid_draw_metadata(gid);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_draw_boundary = function(gid) {
  this.gctx[gid].strokeStyle = '#000000';
  this.gctx[gid].fillStyle = '#000000';
  this.gctx[gid].lineWidth = this.DRAW_LINE_WIDTH;

  // draw boundary marker
  this.gctx[gid].fillRect(1, 1, this.tmetadata_gtimeline_xstart - 2, this.linehn[12] - 1);
  this.gctx[gid].fillRect(this.tmetadata_gtimeline_xstart + this.tmetadata_timelinew,
                          1, this.padx - 1, this.linehn[12] - 1);

  this.gctx[gid].fillStyle = '#ffffff';
  if(Math.abs(this.tmetadata_gtimeline_tstart - 0.0) > 0.001) {
    // draw arrows to indicate that more timeline is available
    var x0 = this.linehb2;
    this.gctx[gid].beginPath();
    for(var dy = this.linehn[1]; dy < this.linehn[12]; dy = dy + this.linehn[2]) {
      this.gctx[gid].moveTo(x0 + 2, dy);
      this.gctx[gid].lineTo(x0 + this.linehb2 + 2, - this.linehb2 + dy);
      this.gctx[gid].lineTo(x0 + this.linehb2 + 2, this.linehb2 + dy);
      this.gctx[gid].lineTo(x0 + 2, dy);
    }
    this.gctx[gid].fill();
  }

  if(Math.abs(this.tmetadata_gtimeline_tend - this.m.duration) > 0.001) {
    // draw arrows to indicate that more timeline is available
    var x0 = this.tmetadata_gtimeline_xstart + this.tmetadata_timelinew + this.linehn[1] + this.linehb2;
    this.gctx[gid].beginPath();
    for(var dy = this.linehn[1]; dy < this.linehn[12]; dy = dy + this.linehn[2]) {
      this.gctx[gid].moveTo(x0 - 2, dy);
      this.gctx[gid].lineTo(x0 - this.linehb2 - 2, -this.linehb2 + dy);
      this.gctx[gid].lineTo(x0 - this.linehb2 - 2, this.linehb2 + dy);
      this.gctx[gid].lineTo(x0 - 2, dy);
    }
    this.gctx[gid].fill();
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_mark_selected = function() {
  var gid = this.selected_gid;
  var mid = this.selected_mid;
  var t0, t1, x0, x1;
  t0 = this.d.store.metadata[mid].z[0];
  t1 = this.d.store.metadata[mid].z[1];
  x0 = this._tmetadata_gtimeline_time2canvas(t0);
  x1 = this._tmetadata_gtimeline_time2canvas(t1);

  // draw arrow extending to the edges of temporal segment
  this.gctx[gid].fillStyle = '#808080';
  this.gctx[gid].strokeStyle = '#808080';

  this.gctx[gid].lineWidth = this.DRAW_LINE_WIDTH;
  this.gctx[gid].beginPath();
  this.gctx[gid].moveTo(x0 + 2, this.linehn[2]);
  this.gctx[gid].lineTo(x0 + this.linehb2 + 2, this.linehn[2] - this.linehb2);
  this.gctx[gid].lineTo(x0 + this.linehb2 + 2, this.linehn[2] + this.linehb2);
  this.gctx[gid].lineTo(x0 + 2, this.linehn[2]);
  this.gctx[gid].lineTo(x1 - 1, this.linehn[2]);
  this.gctx[gid].lineTo(x1 - this.linehb2 - 1, this.linehn[2] - this.linehb2);
  this.gctx[gid].lineTo(x1 - this.linehb2 - 1, this.linehn[2] + this.linehb2);
  this.gctx[gid].lineTo(x1 - 1, this.linehn[2]);
  this.gctx[gid].stroke();
  this.gctx[gid].fill();

  // draw edge time if an edge is being updated
  if ( this.edge_show_time !== -1 ) {
    this.gctx[gid].font = '10px Sans';
    this.gctx[gid].fillStyle = '#000000';

    var time_str = this.d.store.metadata[this.selected_mid].z[this.edge_show_time].toFixed(3);
    if ( this.edge_show_time === 0 ) {
      this.gctx[gid].fillText(time_str, x0 + this.char_width, this.linehn[1]);
    } else {
      var twidth = this.gctx[gid].measureText(time_str).width;
      this.gctx[gid].fillText(time_str, x1 - twidth, this.linehn[1]);
    }
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_draw_metadata = function(gid) {
  if ( this.tmetadata_gtimeline_mid.hasOwnProperty(gid) ) {
    for ( var mindex in this.tmetadata_gtimeline_mid[gid] ) {
      var mid = this.tmetadata_gtimeline_mid[gid][mindex];
      if(mid !== this.selected_mid) {
        this._tmetadata_group_gid_draw_mid(gid, mid);
      }
    }
    // draw selected region again (so that it appears on top)
    if ( this.selected_gid === gid &&
         this.selected_mindex !== -1
       ) {
      this._tmetadata_group_gid_draw_mid(gid, this.selected_mid);
      this._tmetadata_group_gid_mark_selected();
    }
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_draw_mid = function(gid, mid) {
  var t0, t1, x0, x1;
  t0 = this.d.store.metadata[mid].z[0];
  t1 = this.d.store.metadata[mid].z[1];
  x0 = this._tmetadata_gtimeline_time2canvas(t0);
  x1 = this._tmetadata_gtimeline_time2canvas(t1);

  // draw metadata block
  if ( gid === this.selected_gid &&
       mid === this.selected_mid ) {
    this.gctx[gid].fillStyle = '#4d4d4d';
    if ( this.metadata_resize_is_ongoing || this.metadata_move_is_ongoing ) {
      if ( this.metadata_resize_is_ongoing ) {
        x0 = this.metadata_ongoing_update_x[0];
        x1 = this.metadata_ongoing_update_x[1];
      } else {
        x0 = this.metadata_ongoing_update_x[0] + this.metadata_move_dx;
        x1 = this.metadata_ongoing_update_x[1] + this.metadata_move_dx;
      }
    }
  } else {
    var gindex = this.gid_list.indexOf(gid);
    var mindex = this.tmetadata_gtimeline_mid[gid].indexOf(mid);
    var bcolor = this.COLOR_LIST[ mindex % this.NCOLOR ];
    this.gctx[gid].fillStyle = bcolor;
  }

  var metadata_block_width = x1 - x0;
  var r = this.TEMPORAL_SEG_RADIUS * this.char_width;

  if(metadata_block_width < 2*r) {
    // draw a simple marker
    this.gctx[gid].fillRect(x0, this.linehn[1] + 1, x1 - x0, this.linehn[12] - 1);
    return;
  }

  // draw rounded rect
  this.gctx[gid].beginPath();
  this.gctx[gid].moveTo(x0 + r, this.linehn[1] + 1); // top line
  this.gctx[gid].lineTo(x1 - r, this.linehn[1] + 1);
  this.gctx[gid].arcTo(x1, this.linehn[1] + 1, x1, this.linehn[1] + 1 + r, r); // top-right curve
  this.gctx[gid].lineTo(x1, this.linehn[12] - 1 - r);
  this.gctx[gid].arcTo(x1, this.linehn[12] - 1, x1 - r, this.linehn[12] - 1, r); // bottom-right curve
  this.gctx[gid].lineTo(x0 + r, this.linehn[12] - 1);
  this.gctx[gid].arcTo(x0, this.linehn[12] - 1, x0, this.linehn[12] - 1 - r, r); // bottom-left curve
  this.gctx[gid].lineTo(x0, this.linehn[1] - r);
  this.gctx[gid].lineTo(x0 + r, this.linehn[1] + 1);
  this.gctx[gid].fill();

  if(metadata_block_width < 50) {
    return;
  }

  // draw the subtitle text
  this.gctx[gid].font = '12px Sans';
  if ( gid === this.selected_gid &&
       mid === this.selected_mid ) {
    this.gctx[gid].fillStyle = 'white';
  } else {
    this.gctx[gid].fillStyle = 'black';
  }

  var lineheight = 16;
  var subtitle = this.d.store.metadata[mid]['av'][this.groupby_aid];
  var words = subtitle.split(' ');
  var line = '';
  var y = this.linehn[4];

  for(var i = 0; i < words.length; i++) {
    var testLine = line + words[i] + ' ';
    var metrics = this.gctx[gid].measureText(testLine);
    var testWidth = metrics.width;
    if (testWidth > (metadata_block_width - this.char_width)  && i > 0) {
      this.gctx[gid].fillText(line, x0 + this.char_width, y);
      line = words[i] + ' ';
      y += lineheight;
      if(y >= this.linehn[12]) {
        break; // no more vertical space left to draw
      }
    } else {
      line = testLine;
    }
  }
  if(y < this.linehn[12]) {
    this.gctx[gid].fillText(line, x0 + this.char_width, y);
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel = function(gindex) {
  var old_selected_gindex = this.selected_gindex;

  this.selected_gindex = gindex;
  this.selected_gid = this.gid_list[this.selected_gindex];
  this.selected_mindex = -1;
  this.selected_mid = '';

  this.edge_show_time = -1;
  this._tmetadata_group_gid_draw(this.selected_gid);
  this.gcanvas[this.selected_gid].scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});

  // update old selection
  if ( old_selected_gindex !== -1 ) {
    if ( this.gid_list.hasOwnProperty(old_selected_gindex) ) {
      var old_selected_gid = this.gid_list[old_selected_gindex];
      this._tmetadata_group_gid_draw(old_selected_gid);
    }
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel_metadata = function(mindex, emit_event) {
  if(typeof(emit_event) === 'undefined') {
    var emit_event = true;
  }

  var old_selected_mindex = this.selected_mindex;
  this.selected_mindex = mindex;
  this.selected_mid = this.tmetadata_gtimeline_mid[this.selected_gid][mindex];
  if(this.metadata_resize_is_ongoing) {
    var edge_index = this.metadata_resize_edge_index;
    this.m.currentTime = this.d.store.metadata[this.selected_mid].z[edge_index];
  } else {
    this.m.currentTime = this.d.store.metadata[this.selected_mid].z[0];
  }
  //this._tmetadata_group_gid_draw(this.selected_gid);
  _via_util_msg_show('Metadata selected. ' +
                     'Use <span class="key">l</span> or <span class="key">r</span> to expand and ' +
                     '<span class="key">L</span> or <span class="key">R</span> to reduce segment. ' +
                     'Press <span class="key">&larr;</span>&nbsp;<span class="key">&rarr;</span> to move (combine with <span class="key">Shift</span> to merge segments), ' +
                     '<span class="key">Backspace</span> to delete and ' +
                     '<span class="key">Esc</span> to unselect.', true);
  if(emit_event) {
    this.emit_event('metadata_select', { 'mid':this.selected_mid });
  }
}

_via_temporal_segmenter.prototype._tmetadata_sel_metadata_edge_snap_nbd = function(zi) {
  var nbd_zi = [+Infinity, -1]; // [edge_distance, edge_time]
  for(var mindex = 0; mindex < this.tmetadata_gtimeline_mid[this.selected_gid].length; ++mindex) {
    if(mindex !== this.selected_mindex) {
      var mid = this.tmetadata_gtimeline_mid[this.selected_gid][mindex];
      var dt0 = Math.abs(this.d.store.metadata[mid].z[0] - zi);
      var dt1 = Math.abs(this.d.store.metadata[mid].z[1] - zi);
      var dt = Math.min(dt0, dt1);
      if(dt < nbd_zi[0]) {
        nbd_zi[0] = dt;
        if(dt0 < dt1) {
          nbd_zi[1] = this.d.store.metadata[mid].z[0];
        } else {
          nbd_zi[1] = this.d.store.metadata[mid].z[1];
        }
      }
    }
  }

  // check if the edge is closer to time markers in video timeline (start and end times are marked by default)
  var timeline_marks = [0.0, this.fa.last_paused_time, this.m.duration];
  for(var i in timeline_marks) {
    var zmark = timeline_marks[i];
    var dt = Math.abs(zmark - zi);
    if(dt < nbd_zi[0]) {
      nbd_zi[0] = dt;
      nbd_zi[1] = zmark;
    }
  }
  return nbd_zi;
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_remove_mid_sel = function(mindex) {
  var unselected_mid = this.selected_mid;
  this.selected_mindex = -1;
  this.selected_mid = '';
  this.edge_show_time = -1;
  //this._tmetadata_group_gid_draw(this.selected_gid);

  _via_util_msg_show('Use <span class="key">a</span> to add a new temporal segment', true);

  this.emit_event('metadata_unselect', { 'mid':unselected_mid });
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel_metadata_at_time = function() {
  var t = this.m.currentTime;
  var mindex = this._tmetadata_group_gid_metadata_at_time(t);
  if ( mindex !== -1 ) {
    this._tmetadata_group_gid_sel_metadata(mindex);
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_metadata_at_time = function(t) {
  var mindex, mid;
  for ( mindex in this.tmetadata_gtimeline_mid[this.selected_gid] ) {
    mid = this.tmetadata_gtimeline_mid[this.selected_gid][mindex];
    if ( t >= this.d.store.metadata[mid].z[0] &&
         t <= this.d.store.metadata[mid].z[1]
       ) {
      return parseInt(mindex);
    }
  }
  return -1;
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel_next_metadata = function() {
  var sgid = this.gid_list[this.selected_gindex];
  if ( this.selected_mindex === -1 ) {
    if ( this.tmetadata_gtimeline_mid.hasOwnProperty(sgid) ) {
      if ( this.tmetadata_gtimeline_mid[sgid].length ) {
        // select first mid
        this._tmetadata_group_gid_sel_metadata(0);
      }
    }
  } else {
    var next_mindex = this.selected_mindex + 1;
    if ( next_mindex >= this.tmetadata_gtimeline_mid[sgid].length ) {
      next_mindex = 0;
    }
    this._tmetadata_group_gid_sel_metadata(next_mindex);
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_sel_prev_metadata = function() {
  var sgid = this.gid_list[this.selected_gindex];
  if ( this.selected_mindex === -1 ) {
    if ( this.tmetadata_gtimeline_mid.hasOwnProperty(sgid) ) {
      if ( this.tmetadata_gtimeline_mid[sgid].length ) {
        this._tmetadata_group_gid_sel_metadata(this.tmetadata_gtimeline_mid[sgid].length - 1);
      }
    }
  } else {
    var prev_mindex = this.selected_mindex - 1;
    if ( prev_mindex < 0 ) {
      prev_mindex =  this.tmetadata_gtimeline_mid[sgid].length - 1;
    }
    this._tmetadata_group_gid_sel_metadata(prev_mindex);
  }
}

_via_temporal_segmenter.prototype._tmetadata_mid_update_edge = function(eindex, dz) {
  this.edge_show_time = eindex;
  // to ensure only 3 decimal values are stored for time
  var new_value = this.d.store.metadata[this.selected_mid].z[eindex] + dz;
  new_value = _via_util_float_to_fixed(new_value, 3);

  // consistency check
  if ( eindex === 0 ) {
    if ( new_value >= this.d.store.metadata[this.selected_mid].z[1] ) {
      _via_util_msg_show('Cannot update left edge!');
      return;
    }
  } else {
    if ( new_value <= this.d.store.metadata[this.selected_mid].z[0] ) {
      _via_util_msg_show('Cannot update right edge!');
      return;
    }
  }
  if ( new_value < 0.0 || new_value > this.m.duration ) {
    _via_util_msg_show('Cannot update edge beyond the boundary!');
    return;
  }

  this.d.metadata_update_zi(this.file.fid,
                            this.selected_mid,
                            eindex,
                            new_value
                           );
  this.m.currentTime = new_value;
  this.emit_event('metadata_update', {'mid':this.selected_mid, 'eindex':eindex})
}

_via_temporal_segmenter.prototype._tmetadata_mid_move = function(dt) {
  var n = this.d.store.metadata[this.selected_mid].z.length;
  var newz = this.d.store.metadata[this.selected_mid].z.slice();
  for ( var i = 0; i < n; ++i ) {
    newz[i] = parseFloat((parseFloat(newz[i]) + dt).toFixed(3));
    if ( newz[i] < 0 || newz[i] > this.m.duration ) {
      _via_util_msg_show('Cannot move temporal segment beyond the boundary!');
      return;
    }
  }
  this.d.metadata_update_z(this.vid, this.selected_mid, newz).then( function(ok) {
    this.m.currentTime = this.d.store.metadata[this.selected_mid].z[0];

    // the move operation may have changed the sequential order of mid
    this._tmetadata_boundary_fetch_gid_mid(this.selected_gid);

    // check if we need to shift timeline to show the recently moved metadata
    if ( newz[0] <= this.tmetadata_gtimeline_tstart ||
         newz[1] >= this.tmetadata_gtimeline_tend ) {
      var new_tstart = this.tmetadata_gtimeline_tstart - 1;
      if ( newz[1] >= this.tmetadata_gtimeline_tend ) {
        new_tstart = this.tmetadata_gtimeline_tstart + 1;
      }
      if ( new_tstart >= 0 ) {
        this._tmetadata_boundary_update(new_tstart)
        this._tmetadata_gtimeline_draw();
      }
    } else {
      //this._tmetadata_group_gid_draw(this.selected_gid);
    }
    this.emit_event('metadata_update', {'mid':this.selected_mid, 'eindex':-1});
  }.bind(this));
}

_via_temporal_segmenter.prototype._tmetadata_mid_del_sel = function(mid) {
  this._tmetadata_mid_del(this.selected_mid);
  this._tmetadata_group_gid_remove_mid_sel();
  _via_util_msg_show('Temporal segment deleted.');
}

_via_temporal_segmenter.prototype._tmetadata_get_mindex = function(mid) {
  return this.tmetadata_gtimeline_mid[this.selected_gid].indexOf(mid);
}

_via_temporal_segmenter.prototype._tmetadata_mid_del = function(mid) {
  var mindex = this.tmetadata_gtimeline_mid[this.selected_gid].indexOf(mid);
  if ( mindex !== -1 ) {
    this.tmetadata_gtimeline_mid[this.selected_gid].splice(mindex, 1);

    this._group_gid_del_mid(this.selected_gid, mid);
    this._tmetadata_group_gid_draw(this.selected_gid);
    this.d.metadata_delete(this.vid, mid);
    this.emit_event('metadata_delete', {'mid':this.selected_mid, 'eindex':-1});
  }
}

_via_temporal_segmenter.prototype._tmetadata_mid_split_sel = function() {
  this._tmetadata_mid_split(this.selected_mid);
  _via_util_msg_show('Temporal segment split into two.');
}

_via_temporal_segmenter.prototype._tmetadata_mid_split = function(mid) {
  var mindex = this.tmetadata_gtimeline_mid[this.selected_gid].indexOf(mid);
  if ( mindex !== -1 ) {
    var tnow = this.m.currentTime;
    if(tnow < this.d.store.metadata[mid].z[0] ||
       tnow > this.d.store.metadata[mid].z[1]) {
      _via_util_msg_show('To perform split operation, you must position current playback time within the boundary of selected temporal segment.');
      return;

    }
    var new_right_edge_t = _via_util_float_to_fixed(tnow, 3);

    var new_z = [new_right_edge_t, this.d.store.metadata[mid].z[1] ];
    var new_av = this.d.store.metadata[mid].av; // duplicate subtitle
    this.d.metadata_add(this.vid, new_z, [], new_av).then( function(ok) {
      this.d.metadata_update_zi(this.file.fid, mid, 1, new_right_edge_t);
      this.metadata_last_added_mid = ok.mid;
      this._tmetadata_group_gid_draw(this.selected_gid);
      this.emit_event('metadata_add', {'mid':ok.mid, 'eindex':-1});
    }.bind(this), function(err) {
      _via_util_msg_show('Failed to add metadata!');
      console.log(err);
    }.bind(this));
  }
}

_via_temporal_segmenter.prototype._tmetadata_mid_update_last_added_end_edge_to_time = function(t) {
  if ( this.d.store.metadata.hasOwnProperty(this.metadata_last_added_mid) ) {
    var z_now = this.d.store.metadata[this.metadata_last_added_mid].z;
    var update_edge_index;
    if ( t > z_now[1] ) {
      update_edge_index = 1;
    } else {
      if ( t < z_now[0] ) {
        update_edge_index = 0;
      } else {
        var dt0 = Math.abs(z_now[0] - t);
        var dt1 = Math.abs(z_now[1] - t);
        if ( dt0 < dt1 ) {
          update_edge_index = 0;
        } else {
          update_edge_index = 1;
        }
      }
    }

    // to avoid malformed entried
    this.d.metadata_update_zi(this.file.fid,
                              this.metadata_last_added_mid,
                              update_edge_index,
                              t
                             );
    this._tmetadata_boundary_fetch_gid_mid(this.selected_gid);
    this._tmetadata_group_gid_draw(this.selected_gid);
  }
}

_via_temporal_segmenter.prototype._tmetadata_mid_add_at_time = function(t) {
  var z = [ t ];
  if ( z[0] < 0 ) {
    z[0] = 0.0;
  }

  z[1] = z[0] + this.DEFAULT_TEMPORAL_SEG_LEN;
  if ( z[1] > this.m.duration ) {
    z[1] = this.m.duration;
  }

  z = _via_util_float_arr_to_fixed(z, 3);
  // avoid adding same overlapping segments
  if ( this.d.store.metadata.hasOwnProperty(this.metadata_last_added_mid) ) {
    var z0 = this.d.store.metadata[this.metadata_last_added_mid].z;
    if ( z0[0] === z[0] && z0[1] === z[1] ) {
      _via_util_msg_show('A temporal segment of same size already exists.');
      return;
    }
  }
  var xy = [];
  var metadata = {};
  metadata[ this.groupby_aid ] = "";
  this.d.metadata_add(this.vid, z, xy, metadata).then( function(ok) {
    this.metadata_last_added_mid = ok.mid;
    this._tmetadata_group_gid_draw(this.selected_gid);
    this.emit_event('metadata_add', {'mid':ok.mid, 'eindex':-1});
  }.bind(this), function(err) {
    _via_util_msg_show('Failed to add metadata!');
    console.log(err);
  }.bind(this));
}

_via_temporal_segmenter.prototype._tmetadata_mid_merge = function(eindex) {
  var merge_mid;
  if ( eindex === 0 ) {
    var left_mindex = parseInt(this.selected_mindex) - 1;
    if ( left_mindex >= 0 ) {
      merge_mid = this.tmetadata_gtimeline_mid[this.selected_gid][left_mindex];
    }
  } else {
    var right_mindex = parseInt(this.selected_mindex) + 1;
    if (right_mindex < this.tmetadata_gtimeline_mid[this.selected_gid].length ) {
      merge_mid = this.tmetadata_gtimeline_mid[this.selected_gid][right_mindex];
    }
  }

  if ( typeof(merge_mid) !== 'undefined' ) {
    var new_z = this.d.store.metadata[this.selected_mid].z;
    if ( new_z[0] > this.d.store.metadata[merge_mid].z[0] ) {
      new_z[0] = this.d.store.metadata[merge_mid].z[0];
    }
    if ( new_z[1] < this.d.store.metadata[merge_mid].z[1] ) {
      new_z[1] = this.d.store.metadata[merge_mid].z[1];
    }

    var new_av = {};
    Object.assign(new_av, this.d.store.metadata[this.selected_mid]['av']);
    for(var key in this.d.store.metadata[merge_mid]['av']) {
      if(key in new_av) {
        var old_val1 = new_av[key];
        var old_val2 = this.d.store.metadata[merge_mid]['av'][key];
        if ( eindex === 0 ) {
          new_av[key] = old_val2 + ' ' + old_val1;
        } else {
          new_av[key] = old_val1 + ' ' + old_val2;
        }
      } else {
        new_av[key] = this.d.store.metadata[merge_mid]['av'][key];
      }
    }
    this._tmetadata_mid_del(merge_mid);
    // while selected mid remains consistent, mindex changes due to deletion
    this.selected_mindex = this.tmetadata_gtimeline_mid[this.selected_gid].indexOf(this.selected_mid);
    this.d.metadata_update(this.file.fid, this.selected_mid, new_z, [], new_av);
    this._tmetadata_group_gid_draw(this.selected_gid);
    if ( eindex === 0 ) {
      this.m.currentTime = new_z[0];
    } else {
      this.m.currentTime = new_z[1];
    }
    this.emit_event('metadata_update', {'mid':this.selected_mid, 'eindex':-1});
    _via_util_msg_show('Temporal segments merged.');
  } else {
    _via_util_msg_show('Merge is not possible without temporal segments in the neighbourhood');
  }
}

_via_temporal_segmenter.prototype._tmetadata_mid_change_gid = function(from_gindex,
                                                                       to_gindex) {
  var from_gid = this.gid_list[from_gindex];
  var to_gid = this.gid_list[to_gindex];
  var mid_to_move = this.tmetadata_gtimeline_mid[from_gid][this.selected_mindex];
  var mindex_to_move = this.selected_mindex;

  // update metadata
  this.d.store.metadata[mid_to_move].av[this.groupby_aid] = to_gid;

  this._tmetadata_group_gid_remove_mid_sel(mindex_to_move);
  this.tmetadata_gtimeline_mid[from_gid].splice(mindex_to_move, 1);
  var from_group_mindex = this.group[from_gid].indexOf(mid_to_move);
  this.group[from_gid].splice(from_group_mindex, 1);
  this.group[to_gid].push(mid_to_move);

  this.tmetadata_gtimeline_mid[to_gid].push(mid_to_move);
  this.tmetadata_gtimeline_mid[to_gid].sort( this._compare_mid_by_time.bind(this) );
  var moved_mindex = this.tmetadata_gtimeline_mid[to_gid].indexOf(mid_to_move);

  this._tmetadata_group_gid_sel(to_gindex);
  this._tmetadata_group_gid_sel_metadata(moved_mindex);
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_is_at_boundary_marker = function(x) {
  if( (x < (this.tmetadata_gtimeline_xstart - 2)) || (x > (this.tmetadata_gtimeline_xstart + this.tmetadata_timelinew + 2)) ) {
    if( x < (this.tmetadata_gtimeline_xstart - 2)) {
      return 1;
    } else {
      return 2;
    }
  } else {
    return 0;
  }
}

_via_temporal_segmenter.prototype._tmetadata_selected_gid_render = function(e) {
  if(this.auto_render_tmetadata_selected_gid) {
    window.requestAnimationFrame(this._tmetadata_selected_gid_render.bind(this));
  }

  this._tmetadata_group_gid_draw(this.selected_gid, '_tmetadata_selected_gid_render');
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_mousedown = function(e) {
  e.preventDefault();

  // start rendering automatically when user interaction begins (e.g. mousedown)
  // this stops when user interaction stops (e.g. mouseup)
  this.auto_render_tmetadata_selected_gid = true;
  window.requestAnimationFrame(this._tmetadata_selected_gid_render.bind(this));

  this.tmetadata_last_mousedown_x = e.offsetX;
  var x = e.offsetX;
  var gid = e.target.dataset.gid;
  var gindex = e.target.dataset.gindex;
  var t = this._tmetadata_gtimeline_canvas2time(x);

  if ( gindex !== this.selected_gindex ) {
    // select this gid
    this._tmetadata_group_gid_sel(gindex);
  }

  if( this._tmetadata_group_gid_is_at_boundary_marker(x) ) {
    this.timeline_move_is_ongoing = true;
    return;
  }

  if(this.selected_mindex !== -1) {
    // a temporal segment is already selected,
    // move and resize operation can happen only on this temporal segment
    var edge_id = this._tmetadata_group_gid_is_on_edge_of_selection(gid, t);
    if(edge_id === -1) {
      // click was not on the edge of selected segment
      // it could be a move operation
      if ( t >= this.d.store.metadata[this.selected_mid].z[0] &&
           t <= this.d.store.metadata[this.selected_mid].z[1]
         ) {
        this.metadata_move_start_x = x;
        this.metadata_move_dx = 0;
        var z = this.d.store.metadata[this.selected_mid].z;
        this.metadata_ongoing_update_x = [ this._tmetadata_gtimeline_time2canvas(z[0]),
                                           this._tmetadata_gtimeline_time2canvas(z[1])
                                         ];
        this.metadata_move_is_ongoing = true;
      } else {
        // user clicked on a different region
        var new_mindex = this._tmetadata_group_gid_get_mindex_at_time(gid, t);
        if(new_mindex === -1) {
          // clicked on empty region, so remove selection
          this._tmetadata_group_gid_remove_mid_sel(this.selected_mindex);
        } else {
          // remove selection of existing segment and select a new segment
          this._tmetadata_group_gid_sel_metadata(new_mindex);
        }
      }
    } else {
      // an edge of selected segment was clicked
      this.metadata_resize_edge_index = edge_id;
      var z = this.d.store.metadata[this.selected_mid].z;
      this.metadata_ongoing_update_x = [ this._tmetadata_gtimeline_time2canvas(z[0]),
                                         this._tmetadata_gtimeline_time2canvas(z[1])
                                       ];
      this.metadata_resize_is_ongoing = true;
    }
  } else {
    // if click was over an existing temporal segment, select that segment
    // if click was over an empty area, removed selection of an existing segment (if exists)
    var new_mindex = this._tmetadata_group_gid_get_mindex_at_time(gid, t);
    if(new_mindex !== -1) {
      // perform selection
      this._tmetadata_group_gid_sel_metadata(new_mindex);
    }
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_mousemove = function(e) {
  e.preventDefault();
  var x = e.offsetX;
  var gid = e.target.dataset.gid;
  var t = this._tmetadata_gtimeline_canvas2time(x);
  if ( this.metadata_resize_is_ongoing ) {
    var nbd_zi = this._tmetadata_sel_metadata_edge_snap_nbd(t);
    if(nbd_zi[0] < this.TEMPORAL_SEG_EDGE_SNAP_TOL) {
      var x_nbd = this._tmetadata_gtimeline_time2canvas(nbd_zi[1]);
      this.metadata_ongoing_update_x[ this.metadata_resize_edge_index ] = x_nbd;
      this.m.currentTime = nbd_zi[1];
    } else {
      this.metadata_ongoing_update_x[ this.metadata_resize_edge_index ] = x;
      this.m.currentTime = t;
    }
    return;
  }

  if ( this.metadata_move_is_ongoing ) {
    // what lies in the neighbourhood of the edges of the metadata that is being moved?
    var dx = x - this.metadata_move_start_x;
    var new_x_list = [ this.metadata_ongoing_update_x[0] + dx,
                       this.metadata_ongoing_update_x[1] + dx];
    var did_snap_happen = false;
    for(var i in new_x_list) {
      var xi = new_x_list[i];
      var zi = this._tmetadata_gtimeline_canvas2time(xi);
      var nbd_zi = this._tmetadata_sel_metadata_edge_snap_nbd(zi);
      if(nbd_zi[0] < this.TEMPORAL_SEG_EDGE_SNAP_TOL) {
        did_snap_happen = true;
        var x_nbd = this._tmetadata_gtimeline_time2canvas(nbd_zi[1]);
        this.metadata_move_dx = x_nbd - this.metadata_ongoing_update_x[i];
        this.m.currentTime = nbd_zi[1];
        break;
      }
    }
    if(!did_snap_happen) {
      this.metadata_move_dx = x - this.metadata_move_start_x;
      var new_time = this._tmetadata_gtimeline_canvas2time(this.metadata_ongoing_update_x[0] + this.metadata_move_dx);
      this.m.currentTime = new_time;
    }
    return;
  }

  if(this.selected_mindex !== -1 &&
     this._tmetadata_group_gid_is_on_edge_of_selection(gid, t) !== -1) {
    this.gcanvas[gid].style.cursor = 'ew-resize';
  } else {
    this.gcanvas[gid].style.cursor = 'default';
  }

  var mindex = this._tmetadata_group_gid_get_mindex_at_time(gid, t);
  if(mindex !== -1) {
    if(this.selected_mindex === mindex) {
      this.gcanvas[gid].style.cursor = 'grab';
    }
  }
  if( this._tmetadata_group_gid_is_at_boundary_marker(x) ) {
    this.gcanvas[gid].style.cursor = 'pointer';
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_mouseup = function(e) {
  e.preventDefault();
  this.auto_render_tmetadata_selected_gid = false;

  var x = e.offsetX;
  var t = this._tmetadata_gtimeline_canvas2time(e.offsetX);
  if ( this.metadata_resize_is_ongoing ) {
    var dz = t - this.d.store.metadata[this.selected_mid].z[this.metadata_resize_edge_index];
    var nbd_zi = this._tmetadata_sel_metadata_edge_snap_nbd(t);
    if(nbd_zi[0] < this.TEMPORAL_SEG_EDGE_SNAP_TOL) {
      var x_nbd = this._tmetadata_gtimeline_time2canvas(nbd_zi[1]);
      dz = nbd_zi[1] - this.d.store.metadata[this.selected_mid].z[this.metadata_resize_edge_index];
    }
    this._tmetadata_mid_update_edge(this.metadata_resize_edge_index, dz);
    this._tmetadata_group_gid_draw(this.selected_gid);

    this.metadata_resize_is_ongoing = false;
    this.metadata_resize_edge_index = -1;
    this.metadata_ongoing_update_x = [0, 0];
    return;
  }

  if ( this.metadata_move_is_ongoing ) {
    var dx = x - this.metadata_move_start_x;
    var new_x_list = [ this.metadata_ongoing_update_x[0] + dx,
                       this.metadata_ongoing_update_x[1] + dx ];
    for(var i in new_x_list) {
      var xi = new_x_list[i];
      var zi = this._tmetadata_gtimeline_canvas2time(xi);
      var nbd_zi = this._tmetadata_sel_metadata_edge_snap_nbd(zi);
      if(nbd_zi[0] < this.TEMPORAL_SEG_EDGE_SNAP_TOL) {
        var x_nbd = this._tmetadata_gtimeline_time2canvas(nbd_zi[1]);
        dx = x_nbd - this.metadata_ongoing_update_x[i];
        break;
      }
    }

    if ( Math.abs(dx) > this.DRAW_LINE_WIDTH ) {
      var dt = dx / this.tmetadata_width_per_sec;
      this._tmetadata_mid_move(dt);
    } else {
      // remove selection
      this._tmetadata_group_gid_remove_mid_sel(this.selected_mindex);
    }
    this.metadata_move_is_ongoing = false;
    this.metadata_ongoing_update_x = [0, 0];
    this._tmetadata_group_gid_draw(this.selected_gid);
    return;
  }

  if(this.timeline_move_is_ongoing) {
    var offset;
    var boundary_type = this._tmetadata_group_gid_is_at_boundary_marker(x);
    if(boundary_type === 1) {
      // move to left
      offset = -1;
    } else {
      offset = 1;
    }
    this.timeline_move_is_ongoing = false;
    this._tmetadata_boundary_move(offset);
    this._tmetadata_gtimeline_draw();
    this._tmetadata_group_gid_draw_all();
    return;
  }
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_is_on_edge_of_selection = function(gid, t) {
  var mid = this.tmetadata_gtimeline_mid[gid][this.selected_mindex];
  if ( Math.abs(t - this.d.store.metadata[mid].z[0]) < this.METADATA_EDGE_TOL ) {
    return 0;
  } else {
    if ( Math.abs(t - this.d.store.metadata[mid].z[1]) < this.METADATA_EDGE_TOL ) {
      return 1;
    }
  }
  return -1;
}

_via_temporal_segmenter.prototype._tmetadata_group_gid_get_mindex_at_time = function(gid, t) {
  var mindex, mid;
  for ( mindex in this.tmetadata_gtimeline_mid[gid] ) {
    mid = this.tmetadata_gtimeline_mid[gid][mindex];
    if ( t >= this.d.store.metadata[mid].z[0] &&
         t <= this.d.store.metadata[mid].z[1]
       ) {
      return parseInt(mindex);
    }
  }
  return -1;
}

//
// keyboard input handler
//
_via_temporal_segmenter.prototype._on_event_keydown = function(e) {
  var fid = this.file.fid;

  // play/pause
  if ( e.key === ' ' ) {
    e.preventDefault();
    if( this.show_audio && !this.audio_analyser_active) {
      this._tmetadata_audio_init();
    }
    if ( this.m.paused ) {
      this.m.play();
      if(this.selected_mindex === -1) {
        _via_util_msg_show('Playing ...');
      } else {
        _via_util_msg_show('Playing video within selected temporal segment. Press <span class="key">Esc</span> to remove selection and unlock playback.', true);
      }
    } else {
      this.m.pause();
      _via_util_msg_show('Paused. Press <span class="key">a</span> to add a temporal segment, ' +
                         '<span class="key">Tab</span> to select temporal segment, ' +
                         '<span class="key">Esc</span> to remove selection.', true);
    }
  }

  // jump 1,...,9 seconds forward or backward
  if ( ['1','2','3','4','5','6','7','8','9'].includes( e.key ) ) {
    if ( e.altKey ) {
      return; // Alt + Num is used to navigated browser tabs
    }
    e.preventDefault();
    var t = this.m.currentTime;
    if ( e.ctrlKey ) {
      t += parseInt(e.key);
    } else {
      t -= parseInt(e.key);
    }
    // clamp
    t = Math.max(0, Math.min(t, this.m.duration));
    this.m.pause();
    this.m.currentTime = t;
    return;
  }

  if ( e.key === 'n' || e.key === 'N' || e.key === 'p' || e.key === 'P') {
    e.preventDefault();
    if ( ! this.m.paused ) {
      return;
    }

    var t = this.m.currentTime;
    var delt = this.EDGE_UPDATE_TIME_DELTA;
    if ( e.key === 'N' || e.key === 'P' ) {
      delt = delt * 5;
    }
    if ( e.key === 'n' || e.key === 'N') {
      t += delt;
    } else {
      t -= delt;
    }
    // clamp
    t = Math.max(0, Math.min(t, this.m.duration));
    this.m.currentTime = t;
  }

  if ( e.key === 's' || e.key === 'S' ) {
    e.preventDefault();
    this.m.pause();
    if ( e.key === 's' ) {
      if ( this.selected_mindex !== -1 ) {
        this.m.currentTime = this.d.store.metadata[this.selected_mid].z[0];
      } else {
        this.m.currentTime = this.tmetadata_gtimeline_tstart;
      }
    } else {
      this.m.currentTime = 0;
    }
    return;
  }

  if ( e.key === 'e' || e.key === 'E' ) {
    e.preventDefault();
    this.m.pause();
    if ( e.key === 'e' ) {
      if ( this.selected_mindex !== -1 ) {
        this.m.currentTime = this.d.store.metadata[this.selected_mid].z[1];
      } else {
        this.m.currentTime = this.tmetadata_gtimeline_tend;
      }
    } else {
      this.m.currentTime = this.m.duration - 1;
    }
    return;
  }

  // change playback rate
  if ( e.key === '0' ) {
    e.preventDefault();
    this.m.playbackRate = 1;
    return;
  }
  if ( e.key === '+' ) {
    if ( ! e.ctrlKey ) {
      e.preventDefault();
      this.m.playbackRate = this.m.playbackRate + 0.1;
    }
    return;
  }
  if ( e.key === '-' ) {
    if ( ! e.ctrlKey ) {
      e.preventDefault();
      if ( this.m.playbackRate > 0.1 ) {
        this.m.playbackRate = this.m.playbackRate - 0.1;
      }
    }
    return;
  }

  if ( (e.key === 'a' || e.key === 'A') && ! e.ctrlKey ) {
    e.preventDefault();
    var t = this.m.currentTime;
    if ( e.key === 'a' ) {
      this._tmetadata_mid_add_at_time(t);
    } else {
      if ( e.key === 'A' && e.shiftKey ) {
        this._tmetadata_mid_update_last_added_end_edge_to_time(t);
      }
    }
    this._tmetadata_group_gid_draw(this.selected_gid);
    return;
  }

  if ( e.key === 'Backspace' ) {
    e.preventDefault();
    if ( this.selected_mindex !== -1 ) {
      var user_confirmed = window.confirm("Confirm that you want to delete the selected temporal segment");
      if(user_confirmed) {
        this._tmetadata_mid_del_sel();
        this._tmetadata_group_gid_draw(this.selected_gid);
      } else {
        _via_util_msg_show('Discarded temporal segment delete operation');
      }
    }
    return;
  }

  if ( e.key === 'm' ) {
    e.preventDefault();
    if ( this.m.muted ) {
      this.m.muted = false;
    } else {
      this.m.muted = true;
    }
    return;
  }

  if ( e.key === 'l' || e.key === 'L') {
    e.preventDefault();
    if ( this.selected_mindex !== -1 ) {
      // resize left edge of selected temporal segment
      var delta = this.EDGE_UPDATE_TIME_DELTA;
      if ( e.ctrlKey ) {
        delta = 1;
      }
      if ( e.key === 'l' ) {
        this._tmetadata_mid_update_edge(0, -delta);
      } else {
        this._tmetadata_mid_update_edge(0, delta);
      }
    } else {
      if ( e.key === 'l' ) {
        this.m.currentTime = this.m.currentTime - this.EDGE_UPDATE_TIME_DELTA;
      } else {
        this.m.currentTime = this.m.currentTime - 2*this.EDGE_UPDATE_TIME_DELTA;
      }
    }
    this._tmetadata_group_gid_draw(this.selected_gid);
    return;
  }

  if ( e.key === 'r' || e.key === 'R') {
    e.preventDefault();
    if ( this.selected_mindex !== -1 ) {
      // resize left edge of selected temporal segment
      var delta = this.EDGE_UPDATE_TIME_DELTA;
      if ( e.ctrlKey ) {
        delta = 1;
      }

      if ( e.key === 'r' ) {
        this._tmetadata_mid_update_edge(1, delta);
      } else {
        this._tmetadata_mid_update_edge(1, -delta);
      }
    } else {
      if ( e.key === 'r' ) {
        this.m.currentTime = this.m.currentTime + this.EDGE_UPDATE_TIME_DELTA;
      } else {
        this.m.currentTime = this.m.currentTime + 2*this.EDGE_UPDATE_TIME_DELTA;
      }
    }
    this._tmetadata_group_gid_draw(this.selected_gid);
    return;
  }

  // cancel ongoing action or event
  if ( e.key === 'Escape' ) {
    e.preventDefault();
    this._tmetadata_group_gid_remove_mid_sel();
    this._tmetadata_group_gid_draw(this.selected_gid);
    return;
  }

  // select temporal segments
  if ( e.key === 'Tab' ) {
    e.preventDefault();

    if ( e.shiftKey ) {
      this._tmetadata_group_gid_sel_prev_metadata();
    } else {
      this._tmetadata_group_gid_sel_next_metadata();
    }
    this._tmetadata_group_gid_draw(this.selected_gid);
    return;
  }

  if ( e.key === 'Enter' ) {
    e.preventDefault();
    this.m.pause();
    this._tmetadata_group_gid_sel_metadata_at_time();
    this._tmetadata_group_gid_draw(this.selected_gid);
    return;
  }

  if ( e.key === 'ArrowDown' || e.key === 'ArrowUp' ) {
    e.preventDefault();
  }

  if ( e.key === 'ArrowLeft' || e.key === 'ArrowRight' ) {
    e.preventDefault();
    if ( this.selected_mindex !== -1 ) {
      if ( e.shiftKey ) {
        // merge current region with left or right metadata
        if ( e.key === 'ArrowLeft' ) {
          this._tmetadata_mid_merge(0);
        } else {
          this._tmetadata_mid_merge(1);
        }
      } else {
        // move selected temporal segment
        var delta = this.EDGE_UPDATE_TIME_DELTA;
        if ( e.ctrlKey ) {
          delta = 1.0;
        }
        if ( e.key === 'ArrowLeft' ) {
          this._tmetadata_mid_move(-delta);
        } else {
          this._tmetadata_mid_move(delta);
        }
      }
    } else {
      // move temporal seg. timeline
      var tstart_new;
      if ( e.key === 'ArrowLeft' ) {
        if ( e.shiftKey ) {
          this._tmetadata_boundary_move(-60*this.TEMPORAL_SEG_MOVE_OFFSET);
        } else {
          this._tmetadata_boundary_move(-this.TEMPORAL_SEG_MOVE_OFFSET);
        }
      } else {
        if ( e.shiftKey ) {
          this._tmetadata_boundary_move(60*this.TEMPORAL_SEG_MOVE_OFFSET);
        } else {
          this._tmetadata_boundary_move(this.TEMPORAL_SEG_MOVE_OFFSET);
        }
      }
    }
    this._tmetadata_group_gid_draw(this.selected_gid);
    return;
  }

  if ( e.key === 'x' ) {
    if(this.selected_mindex === -1) {
      _via_util_msg_show('First select the temporal segment that you wish to split into two');
      return;
    }
    this._tmetadata_mid_split_sel();
    return;
  }

  if ( e.key === 'F2' ) {
    e.preventDefault();
    _via_util_show_info_page('keyboard_shortcuts');
    return;
  }
}

//
// group by
//

_via_temporal_segmenter.prototype._group_init = function(aid) {
  this.group = {};
  this.group[this.SUBTITLE_GID] = [];
  this.groupby_aid = aid;

  var mid, avalue;
  for ( var mindex in this.d.cache.mid_list[this.vid] ) {
    mid = this.d.cache.mid_list[this.vid][mindex];
    if ( this.d.store.metadata[mid].z.length >= 2 &&
         this.d.store.metadata[mid].xy.length === 0
       ) {
      if ( this.d.store.metadata[mid].av.hasOwnProperty(this.groupby_aid) ) {
        this.group[this.SUBTITLE_GID].push(mid);
      }
    }
  }

  // add possible values for the group variable
  this.gid_list = [ this.SUBTITLE_GID ];

  // sort each group elements based on time
  var gid;
  for ( gid in this.group ) {
    this.group[gid].sort( this._compare_mid_by_time.bind(this) );
  }
}

_via_temporal_segmenter.prototype._compare_gid = function(gid1_str, gid2_str) {
  var gid1 = parseInt(gid1_str);
  var gid2 = parseInt(gid2_str);
  if(isNaN(gid1) || isNaN(gid2)) {
    // gid are not numbers and therefore sort them as string
    if(gid1_str < gid2_str) {
      return -1;
    } else {
      return 1;
    }
  } else {
    // gid are numbers and therefore sort them numerically
    if(gid1 < gid2) {
      return -1;
    } else {
      return 1;
    }
  }
}

_via_temporal_segmenter.prototype._compare_mid_by_time = function(mid1, mid2) {
  var t00 = this.d.store.metadata[mid1].z[0];
  var t10 = this.d.store.metadata[mid2].z[0];
  var t01 = this.d.store.metadata[mid1].z[1];
  var t11 = this.d.store.metadata[mid2].z[1];

  if ( typeof(t00) === 'string' ||
       typeof(t01) === 'string' ) {
    t00 = parseFloat(t00);
    t01 = parseFloat(t01);
    t10 = parseFloat(t10);
    t11 = parseFloat(t11);
  }

  if ( (t00 === t10) && ( t01 === t11 ) ) {
    return 0;
  }

  if ( ( t00 === t10 ) || ( t01 === t11 ) ) {
    var a,b;
    if ( ( t00 === t10 ) ) {
      // same start time
      a = t01;
      b = t11;
    } else {
      // same end time
      a = t00;
      b = t10;
    }
    if ( a < b ) {
      return -1;
    } else {
      return 1;
    }
  } else {
    if ( (t00 < t10) || ( t01 < t11 ) ) {
      return -1;
    } else {
      return 1;
    }
  }
}

_via_temporal_segmenter.prototype._group_gid_add_mid = function(gid, new_mid) {
  // find the best location
  var i, mindex, mid;
  for ( mindex in this.group[gid] ) {
    mid = this.group[gid][mindex];
    if ( this.d.store.metadata[new_mid].z[0] < this.d.store.metadata[mid].z[0] ) {
      this.group[gid].splice(mindex, 0, new_mid); // insert at correct location
      return;
    }
  }

  // if the insertion was not possible, simply push at the end
  this.group[gid].push(new_mid);
  this._tmetadata_group_gid_draw(gid);
}

_via_temporal_segmenter.prototype._group_gid_del_mid = function(gid, mid) {
  var mindex = this.group[gid].indexOf(mid);
  if ( mindex !== -1 ) {
    this.group[gid].splice(mindex, 1);
  }
  this._tmetadata_group_gid_draw(gid);
}

_via_temporal_segmenter.prototype._group_del_gid = function(gid_list) {
  return new Promise( function(ok_callback, err_callback) {
    try {
      var del_mid_list = [];
      var gid;
      for ( var i in gid_list ) {
        gid = gid_list[i];
        for ( var mindex in this.group[gid] ) {
          del_mid_list.push(this.group[gid][mindex]);
        }
        delete this.group[gid];
        delete this.tmetadata_gtimeline_mid[gid];
        var gindex = this.gid_list.indexOf(gid);
        this.gid_list.splice(gindex, 1);
        delete this.gctx[gid];
        delete this.gcanvas[gid];
      }
      ok_callback(del_mid_list);
    }
    catch(ex) {
      err_callback(ex);
    }
  }.bind(this));
}

_via_temporal_segmenter.prototype._group_add_gid = function(gid) {
  if ( this.group.hasOwnProperty(gid) ) {
    _via_util_msg_show(this.d.attribute_store[this.groupby_aid].aname +
                       ' [' + gid + '] already exists!');
  } else {
    this.group[gid] = [];
    this.gid_list.push(gid);
    this.metadata_tbody.appendChild( this._tmetadata_group_gid_html(gid) );
    this.new_group_id_input.value = ''; // clear input field
    _via_util_msg_show('Add ' + this.d.attribute_store[this.groupby_aid].aname +
                       ' [' + gid + ']');
  }
}

//
// Utility functions
//
_via_temporal_segmenter.prototype._time2str = function(t) {
  var hh = Math.floor(t / 3600);
  var mm = Math.floor( (t - hh * 3600) / 60 );
  var ss = Math.round( t - hh*3600 - mm*60 );
  if ( hh < 10 ) {
    hh = '0' + hh;
  }
  if ( mm < 10 ) {
    mm = '0' + mm;
  }
  if ( ss < 10 ) {
    ss = '0' + ss;
  }
  return hh + ':' + mm + ':' + ss;
}

_via_temporal_segmenter.prototype._time2strms = function(t) {
  var hh = Math.floor(t / 3600);
  var mm = Math.floor( (t - hh * 3600) / 60 );
  var ss = Math.floor( t - hh*3600 - mm*60 );
  var ms = Math.floor( (t - Math.floor(t) ) * 1000 );
  if ( hh < 10 ) {
    hh = '0' + hh;
  }
  if ( mm < 10 ) {
    mm = '0' + mm;
  }
  if ( ss < 10 ) {
    ss = '0' + ss;
  }
  if ( ms < 100 ) {
    ms = '0' + ms;
  }
  return hh + ':' + mm + ':' + ss + '.' + ms;
}

_via_temporal_segmenter.prototype._time2hhmmss = function(t) {
  var hh = Math.floor(t / 3600);
  var mm = Math.floor( (t - hh * 3600) / 60 );
  var ss = Math.floor( t - hh*3600 - mm*60 );
  if ( hh < 10 ) {
    hh = '0' + hh.toString();
  }
  if ( mm < 10 ) {
    mm = '0' + mm.toString();
  }
  if ( ss < 10 ) {
    ss = '0' + ss.toString();
  }
  return hh + ':' + mm + ':' + ss;
}

_via_temporal_segmenter.prototype._time2ms = function(t) {
  var ms = Math.floor( (t - Math.floor(t) ) * 1000 );
  if ( ms < 100 ) {
    if(ms < 10) {
      ms = '00' + ms.toString();
    } else {
      ms = '0' + ms.toString();
    }
  }
  return ms;
}

_via_temporal_segmenter.prototype._time2ssms = function(t) {
  var hh = Math.floor(t / 3600);
  var mm = Math.floor( (t - hh * 3600) / 60 );
  var ss = Math.floor( t - hh*3600 - mm*60 );
  var ms = Math.floor( (t - Math.floor(t) ) * 1000 );
  return ss + ':' + ms;
}

_via_temporal_segmenter.prototype._vtimeline_playbackrate2str = function(t) {
  return this.m.playbackRate + 'X';
}

//
// external events
//
_via_temporal_segmenter.prototype._on_event_metadata_del = function(vid, mid) {
  _via_util_msg_show('Metadata deleted');
}

_via_temporal_segmenter.prototype._on_event_metadata_add = function(vid, mid) {
  if ( this.vid === vid &&
       this.d.store.metadata[mid].z.length === 2 &&
       this.d.store.metadata[mid].xy.length === 0
     ) {
    this._group_gid_add_mid(this.selected_gid, mid); // add at correct location
    this._tmetadata_boundary_fetch_gid_mid(this.selected_gid);
    _via_util_msg_show('Metadata added');
  }
}

_via_temporal_segmenter.prototype._on_event_metadata_update = function(vid, mid) {
  _via_util_msg_show('Metadata updated');
}

//
// external events
//
_via_temporal_segmenter.prototype._on_event_attribute_update = function(data, event_payload) {
  var aid = event_payload.aid;
  if ( this.groupby_aid === aid ) {
    _via_util_msg_show('Attribute [' + this.d.store['attribute'][aid]['aname'] + '] updated.');
    this._init();
  }
}

_via_temporal_segmenter.prototype._on_event_metadata_update_bulk = function(data, event_payload) {
  if ( this.vid === event_payload.vid ) {
    _via_util_msg_show('Updated ' + event_payload.mid_list.length + ' metadata');
  }
}

_via_temporal_segmenter.prototype._on_event_metadata_add_bulk = function(data, event_payload) {
  _via_util_msg_show('Added ' + event_payload.mid_list.length + ' metadata');
  this._init(this.groupby_aid);
  this.emit_event('metadata_add', { 'mid_list':event_payload['mid_list'] });
}
</script>
<!-- END: Contents of file: _via_temporal_segmenter.js-->
<!-- START: Contents of file: _via_view_annotator.js-->
<script>
/**
 * Builds user interface and control handlers to allow
 * subtitle annotation of a video or audio file.

 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 9 Oct. 2020
 *
 */

'use strict';

const _VIA_VIEW_MODE = {'UNKNOWN':0,
                        'IMAGE1':1, 'IMAGE2':2, 'IMAGEK':3,
                        'VIDEO1':101, 'VIDEO2':102, 'VIDEOK':103,
                        'AUDIO1':201, 'AUDIO2':202, 'AUDIOK':203,
                        'AV_SUBTITLE':301,
                       };
const _VIA_PAGE = {
  'ABOUT':'page_about',
  'SHORTCUT':'page_shortcut',
  'START_INFO':'page_start_info',
};

function _via_view_annotator(data, container, data_RH=null, data_LH=null) {
  this._ID = '_via_view_annotator_';
  this.d = data;
  this.d_RH = data_RH;
  this.d_LH = data_LH;
  this.c = container;
  this.file_annotator = [];
  this.view_mode = _VIA_VIEW_MODE.UNKNOWN;

  // constants
  this.GTIMELINE_ROW_DEFAULT_COUNT = '4';
  this.GTIMELINE_ROW_HEIGHT_MAP = { '1':21, '2':24, '3':28, '4':32, '5':37, '6':41, '7':45,'8':49,'9':53,'10':57,'12':65,'14':73,'16':80 };

  // state variables
  this.region_draw_shape = _VIA_RSHAPE.RECTANGLE;
  this.creg_label_aid = '1';

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  _via_event.call( this );

  this.d.on_event('metadata_add', this._ID, this._on_event_metadata_add.bind(this));
  this.d.on_event('metadata_update', this._ID, this._on_event_metadata_update.bind(this));
  if (this.d_LH != null) {
    this.d_LH.on_event('metadata_add', this._ID, this._on_event_metadata_add.bind(this));
    this.d_LH.on_event('metadata_update', this._ID, this._on_event_metadata_update.bind(this));
    this.d_RH.on_event('metadata_add', this._ID, this._on_event_metadata_add.bind(this));
    this.d_RH.on_event('metadata_update', this._ID, this._on_event_metadata_update.bind(this));
  }

  this._init();
}

_via_view_annotator.prototype._init = function() {
  this._view_clear_all_file_annotator();
  this._show_start_info();

  if ( ! this.d.store.config.ui.hasOwnProperty('spatial_region_label_attribute_id') ) {
    this.d.store.config.ui['spatial_region_label_attribute_id'] = '';
  }
}

_via_view_annotator.prototype._zoom_toggle = function() {
  for(var i = 0; i < this.file_annotator.length; ++i) {
    for(var j = 0; j < this.file_annotator[i].length; ++j) {
      this.file_annotator[i][j]._zoom_toggle.bind(this.file_annotator[i][j])();
    }
  }
}

_via_view_annotator.prototype._show_start_info = function() {
  this.c.setAttribute('style', 'grid-template-rows:1fr;')
  var via_page = document.createElement('div');
  via_page.setAttribute('id', 'via_start_info');
  via_page.innerHTML = document.getElementById('via_start_info_content').innerHTML;
  this.c.innerHTML = '';
  this.c.appendChild(via_page);
}

_via_view_annotator.prototype.view_show = function(vid) {
  this._view_clear_all_file_annotator();
  this.vid = vid;
  this._view_init(vid);
  this.emit_event( 'view_show', { 'vid':this.vid } );
}

_via_view_annotator.prototype._view_init = function(vid) {
  var file_count = this.d.store.view[vid].fid_list.length;
  if( file_count === 1 &&
      (this._view_has_only_video(vid) || this._view_has_only_audio(vid))
    ) {
      this._view_annotate_single_audio_or_video_subtitle(vid);
  } else {
    console.warn('View mode not supported yet!');
    _via_util_msg_show('Subtitle editor only supports annotation of single video or audio');
  }
}

_via_view_annotator.prototype._view_annotate_single_audio_or_video_subtitle = function(vid) {
  this.group_aid_candidate_list = [];
  if ( this.d.cache.attribute_group.hasOwnProperty('FILE1_Z2_XY0') ) {
    for ( var aindex in this.d.cache.attribute_group['FILE1_Z2_XY0'] ) {
      this.group_aid_candidate_list.push( this.d.cache.attribute_group['FILE1_Z2_XY0'][aindex] );
    }
  }
  if(this.group_aid_candidate_list.length) {
    this.groupby_aid = this.group_aid_candidate_list[0];
    this.view_mode = _VIA_VIEW_MODE.AV_SUBTITLE;
  } else {
    this.c.innerHTML = '<p>You must define an attribute with anchor "Temporal Segment in Video or Audio" in order to define temporal segments in this file. Click&nbsp;<svg class="svg_icon" viewbox="0 0 24 24"><use xlink:href="#micon_insertcomment"></use></svg>&nbsp;button to define such attributes using attribute editor.</p><p>After defining the attribute, <span class="text_button" onclick="via.va.view_show(via.va.vid);">reload this file</span></p>.';
    this.view_mode = _VIA_VIEW_MODE.UNKNOWN;
    return;
  }

  this.c.innerHTML = '';
  // for viewing content of a view and definition of metadata.{xy, z, av} for the view
  this.view_content_container = document.createElement('div');
  this.view_content_container.setAttribute('class', 'view_content_container');

  // for definition of metadata.{z, v} for a view
  this.view_metadata_container = document.createElement('div');
  this.view_metadata_container.setAttribute('class', 'view_metadata_container');

  if(this.d.store['config']['ui'].hasOwnProperty('gtimeline_container_height')) {
    // fix for pixel height stored by projects created using via-3.0.7
    var via307_fix = { '17':'1','20':'2','24':'3','28':'4','33':'5','37':'6','41':'7','45':'8','49':'9','53':'10','61':'12','69':'14','76':'16','85':'18' };
    if(this.d.store['config']['ui']['gtimeline_container_height'] in via307_fix) {
      this.d.store['config']['ui']['gtimeline_visible_row_count'] = via307_fix[ this.d.store['config']['ui']['gtimeline_container_height'] ];
    }
    delete this.d.store['config']['ui']['gtimeline_container_height'];
  }
  if( !this.d.store['config']['ui'].hasOwnProperty('gtimeline_visible_row_count')) {
    this.d.store['config']['ui']['gtimeline_visible_row_count'] = this.GTIMELINE_ROW_DEFAULT_COUNT;
  }

  var gtimeline_visible_row_count = this.d.store['config']['ui']['gtimeline_visible_row_count'];
  this.gtimeline_container_height = this.GTIMELINE_ROW_HEIGHT_MAP[gtimeline_visible_row_count];
  this.c.setAttribute('style', 'grid-template-rows:1fr ' + this.gtimeline_container_height + 'ch;')
  this.c.appendChild(this.view_content_container);
  this.c.appendChild(this.view_metadata_container);
  this.view_metadata_container.style.display = 'block';

  // occupy the full container with single image
  this.file_annotator = [];
  this.file_container = [];
  this.view_content_container.innerHTML = '';
  this.view_metadata_container.innerHTML = '';
  this._view_split_content_container(this.view_content_container, this.file_container, 1, 2);

  this.file_annotator[0] = [];
  var fid0 = this.d.store.view[vid].fid_list[0];
  var vid0 = this.d.view_get_file_vid( fid0 );
  this.file_annotator[0][0] = new _via_file_annotator(this, this.d, vid0, '', this.file_container[0][1]);

  this.file_annotator[0][0]._file_load().then( function(ok) {
    this.view_metadata_container.innerHTML = '';

    // setup view metadata editor
    this.temporal_segmenter_container = document.createElement('div');
    this.temporal_segmenter_container.classList.add('temporal_segmenter_container');
    this.view_metadata_container.appendChild(this.temporal_segmenter_container);
    this.temporal_segmenter = new _via_temporal_segmenter(this.file_annotator[0][0],
                                                          this.temporal_segmenter_container,
                                                          vid0,
                                                          this.groupby_aid,
                                                          this.d,
                                                          this.file_annotator[0][0].file_html_element
                                                         );
    this.subtitle_editor_container = this.file_container[0][0];
    this.subtitle_editor_container.setAttribute('id', 'subtitle_editor');
    this.subtitle_editor_container.setAttribute('class', '');
    this.subtitle_editor = new _via_subtitle_editor(this.groupby_aid, this.d, this.temporal_segmenter, this.subtitle_editor_container, this.d_RH, this.d_LH);
  }.bind(this), function(err) {
    this.c.removeChild(this.view_metadata_container);
    this.c.setAttribute('style', 'grid-template-rows:1fr;')
  }.bind(this));
}

_via_view_annotator.prototype._view_has_only_video = function(vid) {
  var fid;
  for ( var vfindex in this.d.store.view[vid].fid_list ) {
    fid = this.d.store.view[vid].fid_list[vfindex];
    if ( this.d.store.file[fid].type !== _VIA_FILE_TYPE.VIDEO ) {
      return false;
    }
  }
  return true;
}

_via_view_annotator.prototype._view_has_only_audio = function(vid) {
  var fid;
  for ( var vfindex in this.d.store.view[vid].fid_list ) {
    fid = this.d.store.view[vid].fid_list[vfindex];
    if ( this.d.store.file[fid].type !== _VIA_FILE_TYPE.AUDIO ) {
      return false;
    }
  }
  return true;
}

//
// view container
//
_via_view_annotator.prototype._view_split_content_container = function(container, file_container, nrow, ncol) {
  for ( var i = 0; i < nrow; ++i ) {
    file_container[i] = [];
    for ( var j = 0; j < ncol; ++j ) {
      file_container[i][j] = document.createElement('div');
      file_container[i][j].setAttribute('class', 'file_container');
      file_container[i][j].setAttribute('data-i', i);
      file_container[i][j].setAttribute('data-j', j);
      container.appendChild(file_container[i][j]);
    }
  }
  container.setAttribute('style',
                         'grid-template-columns:repeat(' + ncol + ',1fr);' +
                         'grid-template-rows:repeat(' + nrow + ',1fr);' +
                         'grid-gap:0.5em;');
}

//
// cleanup
//
_via_view_annotator.prototype._view_clear_all_file_annotator = function() {
  // _via_file_annotator are attached as events listeners in _via_data
  // we must also remove these events listeners
  this.d.clear_events('metadata_add', this._ID);
  this.d.clear_events('metadata_update', this._ID);
  this.d.clear_events('metadata_delete_bulk', this._ID);
  this.d.clear_events('view_update', this._ID);

  // cleanup resources acquired by each of this.file_annotator[i][j]
  for ( var i = 0; i < this.file_annotator.length; ++i ) {
    for ( var j = 0; j < this.file_annotator[i].length; ++j ) {
      delete this.file_annotator[i][j];
    }
  }
}

//
// keyboard handler
//
_via_view_annotator.prototype._on_event_keydown = function(e) {
  this.temporal_segmenter._on_event_keydown(e);
}

//
// external events
//
_via_view_annotator.prototype._on_event_metadata_add = function(data, event_payload) {
  var vid = event_payload.vid;
  var mid = event_payload.mid;

  if ( typeof(this.temporal_segmenter) !== 'undefined' ) {
    this.temporal_segmenter._on_event_metadata_add(vid, mid);
  }
}

_via_view_annotator.prototype._on_event_metadata_update = function(data, event_payload) {
  var vid = event_payload.vid;
  var mid = event_payload.mid;

  if ( typeof(this.temporal_segmenter) !== 'undefined' ) {
    this.temporal_segmenter._on_event_metadata_update(vid, mid);
  }
}
</script>
<!-- END: Contents of file: _via_view_annotator.js-->
<!-- START: Contents of file: _via_subtitle_editor.js-->
<script>
/**
 * @class
 * @classdesc Subtitle editor for video and audio
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 21 Sep. 2020
 */
function _via_subtitle_editor(groupby_aid, data, temporal_segmenter, container, data_RH=null, data_LH=null) {
  this._ID = '_via_subtitle_editor';
  this.groupby_aid = groupby_aid;
  this.d  = data;
  this.d_RH  = data_RH;
  this.d_LH  = data_LH;
  this.ts = temporal_segmenter;
  this.c  = container;

  // state
  this.mid_list = [];
  this.subtitle_track_cue_list = [];
  this.selected_mindex = -1;

  // initialise event listeners
  this.ts.on_event('metadata_add', this._ID, this.on_event_metadata_add.bind(this));
  this.ts.on_event('metadata_delete', this._ID, this.on_event_metadata_del.bind(this));
  this.ts.on_event('metadata_select', this._ID, this._on_event_metadata_select.bind(this));
  this.ts.on_event('metadata_unselect', this._ID, this._on_event_metadata_unselect.bind(this));
  this.ts.on_event('metadata_update', this._ID, this._on_event_metadata_update.bind(this));

  this.init();
}

_via_subtitle_editor.prototype.init = function() {
  for (ix in [...Array(this.ts.m.textTracks.length).keys()]){
    this.ts.m.textTracks[ix].mode = 'disabled'
  }
  var subtitle_track = this.ts.m.addTextTrack('subtitles', 'English', 'en');
  subtitle_track.mode = 'showing';

  this.c.setAttribute('style', 'height:' + this.c.clientHeight + 'px');
  this.c.innerHTML = '';
  this.subtitle_table = document.createElement('table');

  var subtitle_head = document.createElement('thead');
  subtitle_head.innerHTML = '<tr><th>Start</td><th>End</th><th>Subtitle Text</th></tr>';

  this.subtitle_tbody = document.createElement('tbody');
  this.mid_list = Object.keys(this.d.store.metadata);
  this.mid_list.sort( this._compare_mid_by_time.bind(this) );
  var row_index = 1;


  for(var mindex in this.mid_list) {
    // debugger
    var mid = this.mid_list[mindex];
    this.tmp_mid = mid;
    var index = document.createElement('td');
    index.innerHTML = row_index;
    var row = document.createElement('tr');
    row.setAttribute('id', 'subtitle_mindex_' + mindex);
    row.addEventListener('click', this.on_click_row.bind(this, parseInt(mindex)));

    var stime = document.createElement('td');
    var start = _via_seconds_to_hh_mm_ss_ms(this.d.store.metadata[mid]['z'][0]);
    stime.innerHTML = '<span class="hhmmss">' + start[0] + ':' + start[1] + ':' + start[2] + '</span><span class="ms">' + start[3] + '</span>';
    var etime = document.createElement('td');
    var end = _via_seconds_to_hh_mm_ss_ms(this.d.store.metadata[mid]['z'][1]);
    etime.innerHTML = '<span class="hhmmss">' + end[0] + ':' + end[1] + ':' + end[2] + '</span><span class="ms">' + end[3] + '</span>';


    var subtitle = document.createElement('td');
    subtitle.setAttribute('id', 'subtitle');

    // show selected 
    var selected_gloss = document.createElement('td')
    selected_gloss.setAttribute('id', 'selected_gloss_' + mid);
    selected_gloss.setAttribute('width', '200px')
    selected_gloss.innerText = this.d.store.metadata[mid]['av'][this.groupby_aid];
    // selected_gloss.setAttribute('text', 'test')
    // selected_gloss.setAttribute('value', 'test')

    // editable dropdown
    var input = document.createElement('input');
    input.setAttribute('id', 'input_' + mid);
    input.setAttribute('list', 'browsers'+mindex);
    input.setAttribute('name', 'browser');
    input.setAttribute('type', 'text');
    input.setAttribute('data-mid', mid);

    input.addEventListener('click', this.onclick_subtitle_text.bind(this));
    input.addEventListener('change', this.onchange_subtitle_text.bind(this));
    var datalist = document.createElement('datalist');
    datalist.setAttribute('id', 'browsers'+mindex);

    // Top-5 Dropdown here
    // 
    // var select = document.createElement('select');
    // select.setAttribute('data-mid', mid);
    // select.addEventListener('click', this.onclick_subtitle_text.bind(this));
    // select.addEventListener('change', this.onchange_subtitle_text.bind(this));

    // var list_test = this.d.store.metadata[mid]['av'][this.groupby_aid];
    // var values_test = list_test.split(',');
    // for(var ix in values_test) { 
    //   var opt1 = document.createElement('option')
    //   opt1.setAttribute('value', values_test[ix]);  
    //   opt1.text = values_test[ix]
    //   select.appendChild(opt1);
    //   // datalist.appendChild(opt1);
    // }
    

    // Top-5
    if ('top5' in this.d.store.metadata[mid]){
      var top5_list = this.d.store.metadata[mid]['top5']["0"];
      var values_test = top5_list.split(',');
      for(var ix in values_test) { 
        var opt2 = document.createElement('option')
        opt2.setAttribute('value', values_test[ix]);  
        opt2.text = values_test[ix]
        datalist.appendChild(opt2);
      }
    }

    // All classes
    var class_list = this.d.classes
    for(var ix in class_list) {
      var opt2 = document.createElement('option')
      opt2.setAttribute('value', class_list[ix]);  
      opt2.text = class_list[ix]
      datalist.appendChild(opt2);
    }
    // subtitle.appendChild(select);
    input.appendChild(datalist)
    subtitle.appendChild(input);


    var RH_label = document.createElement('label');
    var checkbox_RH = document.createElement('input')
    checkbox_RH.setAttribute('type', 'checkbox');
    checkbox_RH.setAttribute('id', 'RH');
    checkbox_RH.setAttribute('value', 'RH');
    checkbox_RH.setAttribute('data-mid', mid);

    if (mid in this.d_RH.store.metadata){
      if ('checkbox' in this.d_RH.store.metadata[mid]){
        if (this.d_RH.store.metadata[mid].checkbox == true){
          checkbox_RH.setAttribute('checked', true);
        }
      }
    }
    checkbox_RH.addEventListener('click', this.onclick_subtitle_text.bind(this));
    checkbox_RH.addEventListener('change', this.onchange_checkbox_RH.bind(this));
    RH_label.innerHTML = 'RH';
    RH_label.appendChild(checkbox_RH)


    var LH_label = document.createElement('label');
    var checkbox_LH = document.createElement('input')
    checkbox_LH.setAttribute('type', 'checkbox');
    checkbox_LH.setAttribute('id', 'LH');
    checkbox_LH.setAttribute('value', 'LH');
    checkbox_LH.setAttribute('data-mid', mid);
    if ('checkbox_init' in this.d.store.metadata[mid]){
      if (mid in this.d_LH.store.metadata){
        if ('checkbox' in this.d_LH.store.metadata[mid]){
          if (this.d_LH.store.metadata[mid].checkbox == true){
            checkbox_LH.setAttribute('checked', true);
          }
        }
      }
    } else {
      this.init_checkbox_LH(mid)
      this.init_checkbox_RH(mid)
      checkbox_RH.setAttribute('checked', true);
      checkbox_LH.setAttribute('checked', true);
      this.d.store.metadata[mid]['checkbox_init'] = true;
    }

    checkbox_LH.addEventListener('click', this.onclick_subtitle_text.bind(this));
    checkbox_LH.addEventListener('change', this.onchange_checkbox_LH.bind(this));
    LH_label.innerHTML = 'LH';
    LH_label.appendChild(checkbox_LH)

    row.appendChild(index);
    row.appendChild(stime);
    row.appendChild(etime);
    row.appendChild(selected_gloss);
    row.appendChild(subtitle);
    row.appendChild(RH_label);
    row.appendChild(LH_label);
    this.subtitle_tbody.appendChild(row);
    row_index = row_index + 1;

    this.subtitle_track_cue_list[mindex] = new VTTCue(this.d.store.metadata[mid]['z'][0],
                                                      this.d.store.metadata[mid]['z'][1],
                                                      this.d.store.metadata[mid]['av'][this.groupby_aid]);

    subtitle_track.addCue(this.subtitle_track_cue_list[mindex]);
  }

  //this.subtitle_table.appendChild(subtitle_head);
  this.subtitle_table.appendChild(this.subtitle_tbody);
  this.c.appendChild(this.subtitle_table);
}

_via_subtitle_editor.prototype.onclick_subtitle_text = function(e) {
  // event.stopPropagation();
  if(e.target.parentNode.parentNode.classList.contains('sel_row')) {
    // remove selection
    // this.remove_subtitle_sel();
    // e.target.blur();
    // this.inform_temporal_segmenter_of_unselect();
  } else {
    var mid = e.target.dataset.mid;
    var mindex = this.mid_list.indexOf(mid);
    this.remove_subtitle_sel();
    this.subtitle_sel(mindex);
    this.inform_temporal_segmenter_of_select();
  }
}

_via_subtitle_editor.prototype.onchange_subtitle_text = function(e) {
  var mid = e.target.dataset.mid;
  var new_subtitle_text = e.target.value.trim();
  // show selcted in seperate text field
  var selected_gloss_element = document.getElementById('selected_gloss_' + mid);
  selected_gloss_element.innerText = new_subtitle_text
  var input_element = document.getElementById('input_' + mid);
  input_element.value = "";
  this.d.metadata_update_av(this.ts.vid, mid, this.groupby_aid, new_subtitle_text).then( function(ok) {
    // update subtitle track cue
    var mindex = this.mid_list.indexOf(mid);
    var cue = this.subtitle_track_cue_list[mindex];
    cue.text = this.d.store.metadata[mid]['av'][this.groupby_aid];

    // update temporal segmenter
    this.ts._tmetadata_group_gid_draw(this.ts.selected_gid);
  }.bind(this), function(err) {
    _via_util_msg_show('Failed to update subtitle text.');
  }.bind(this));
}

_via_subtitle_editor.prototype.init_checkbox_RH = function(mid) {
  var _this = this
  _this.d_RH.metadata_add_bulk([_this.d.store.metadata[mid]], true, [mid])
  _this.d_RH.store.metadata[mid].checkbox = true
}

_via_subtitle_editor.prototype.onchange_checkbox_RH = function(e) {
  // debugger;
  var mid = e.target.dataset.mid;
  if (e.target.checked) {
    console.log("Checkbox is checked..");
    this.d_RH.metadata_add_bulk([this.d.store.metadata[mid]], true, [mid])
    this.d_RH.store.metadata[mid].checkbox = true
  } else {
    console.log("Checkbox is not checked..");
    this.d_RH.metadata_delete(this.ts.vid, mid)
  }
}

_via_subtitle_editor.prototype.init_checkbox_LH = function(mid) {

  this.d_LH.metadata_add_bulk([this.d.store.metadata[mid]], true, [mid])
  this.d_LH.store.metadata[mid].checkbox = true

}
_via_subtitle_editor.prototype.onchange_checkbox_LH = function(e) {
  debugger;
  var mid = e.target.dataset.mid;
  if (e.target.checked) {
    console.log("Checkbox is checked..");
    this.d_LH.metadata_add_bulk([this.d.store.metadata[mid]], true, [mid])
    this.d_LH.store.metadata[mid].checkbox = true
  } else {
    console.log("Checkbox is not checked..");
    this.d_LH.metadata_delete(this.ts.vid, mid)
  }
}

_via_subtitle_editor.prototype.remove_subtitle_sel = function() {
  if(this.selected_mindex !== -1) {
    // remove existing selection
    var old_row = document.getElementById('subtitle_mindex_' + this.selected_mindex);
    old_row.classList.remove('sel_row');
    this.selected_mindex = -1;
  }
}

_via_subtitle_editor.prototype.subtitle_sel = function(mindex) {
  new Date()
  this.d.log.push(Date.now()+ ':  clicked:' + mindex )
  this.selected_mindex = mindex;
  var new_row = document.getElementById('subtitle_mindex_' + this.selected_mindex);
  new_row.classList.add('sel_row');
  var scrolltop = new_row.parentNode.parentNode.parentNode.scrollTop;
  var vheight = new_row.parentNode.parentNode.parentNode.clientHeight;
  var row_height = new_row.clientHeight;
  var rowtop = new_row.offsetTop;
  if( (rowtop + row_height) < scrolltop ||
      (rowtop + row_height) > (scrolltop + vheight) ) {
    new_row.scrollIntoView();
  }
}

_via_subtitle_editor.prototype.inform_temporal_segmenter_of_select = function() {
  var mid = this.mid_list[this.selected_mindex];
  var tstart = this.d.store.metadata[mid].z[0];
  var ts_mindex = this.ts._tmetadata_get_mindex(mid);
  if(ts_mindex === -1) {
    this.ts._tmetadata_boundary_move(0, tstart);
    this.ts._tmetadata_gtimeline_draw();
    this.ts._tmetadata_group_gid_draw_all();
    ts_mindex = this.ts._tmetadata_get_mindex(mid);
    this.ts._tmetadata_group_gid_sel_metadata(ts_mindex, false);
  } else {
    this.ts._tmetadata_group_gid_sel_metadata(ts_mindex, false);
  }
  this.ts._tmetadata_group_gid_draw_all();
}

_via_subtitle_editor.prototype.inform_temporal_segmenter_of_unselect = function() {
  this.ts._tmetadata_group_gid_remove_mid_sel();
  this.ts._tmetadata_group_gid_draw_all();
}

_via_subtitle_editor.prototype.on_click_row = function(mindex, e) {
  console.log('clicked ' + mindex + ', target=' + e.target.type)
  if(e.target.type === 'text') {
    return; // handled by onclick_subtitle_text()
  }

  if(mindex === this.selected_mindex) {
    this.remove_subtitle_sel();
    this.inform_temporal_segmenter_of_unselect();
  } else {
    this.remove_subtitle_sel();
    this.subtitle_sel(mindex);
    this.inform_temporal_segmenter_of_select();
  }
}

_via_subtitle_editor.prototype.on_event_metadata_add = function(data, event_payload) {
  this.init();
}

_via_subtitle_editor.prototype.on_event_metadata_del = function(data, event_payload) {
  this.init();
}

_via_subtitle_editor.prototype._on_event_metadata_select = function(data, event_payload) {
  var mid = event_payload.mid;
  var mindex = this.mid_list.indexOf(mid);
  this.remove_subtitle_sel();
  this.subtitle_sel(mindex);
}

_via_subtitle_editor.prototype._on_event_metadata_unselect = function(data, event_payload) {
  this.remove_subtitle_sel();
}

_via_subtitle_editor.prototype._on_event_metadata_update = function(data, event_payload) {
  var mid = event_payload.mid;
  var eindex = event_payload.eindex;
  var mindex = this.mid_list.indexOf(mid);

  // update subtitle list
  var row = document.getElementById('subtitle_mindex_' + mindex);
  var stime = document.createElement('td');
  var start = _via_seconds_to_hh_mm_ss_ms(this.d.store.metadata[mid]['z'][0]);
  row.childNodes[1].innerHTML = '<span class="hhmmss">' + start[0] + ':' + start[1] + ':' + start[2] + '</span><span class="ms">' + start[3] + '</span>';
  var etime = document.createElement('td');
  var end = _via_seconds_to_hh_mm_ss_ms(this.d.store.metadata[mid]['z'][1]);
  row.childNodes[2].innerHTML = '<span class="hhmmss">' + end[0] + ':' + end[1] + ':' + end[2] + '</span><span class="ms">' + end[3] + '</span>';
  row.childNodes[3].innerHTML = this.d.store.metadata[mid]['av'][this.groupby_aid];

  // update subtitle track cue
  var cue = this.subtitle_track_cue_list[mindex];
  cue.startTime = this.d.store.metadata[mid]['z'][0];
  cue.endTime = this.d.store.metadata[mid]['z'][1];
  cue.text = this.d.store.metadata[mid]['av'][this.groupby_aid];
}

_via_subtitle_editor.prototype._compare_mid_by_time = function(mid1, mid2) {
  var t00 = this.d.store.metadata[mid1].z[0];
  var t10 = this.d.store.metadata[mid2].z[0];
  var t01 = this.d.store.metadata[mid1].z[1];
  var t11 = this.d.store.metadata[mid2].z[1];

  if ( typeof(t00) === 'string' ||
       typeof(t01) === 'string' ) {
    t00 = parseFloat(t00);
    t01 = parseFloat(t01);
    t10 = parseFloat(t10);
    t11 = parseFloat(t11);
  }

  if ( (t00 === t10) && ( t01 === t11 ) ) {
    return 0;
  }

  if ( ( t00 === t10 ) || ( t01 === t11 ) ) {
    var a,b;
    if ( ( t00 === t10 ) ) {
      // same start time
      a = t01;
      b = t11;
    } else {
      // same end time
      a = t00;
      b = t10;
    }
    if ( a < b ) {
      return -1;
    } else {
      return 1;
    }
  } else {
    if ( (t00 < t10) || ( t01 < t11 ) ) {
      return -1;
    } else {
      return 1;
    }
  }
}</script>
<!-- END: Contents of file: _via_subtitle_editor.js-->

<!-- START: Contents of file: ../../src/js/_via_view_manager.js-->
<script>
/**
 *
 * @class
 * @classdesc View manager
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 5 Apr. 2019
 *
 */

'use strict';

function _via_view_manager(data, view_annotator, container, data_RH=null, data_LH=null) {
  this._ID = '_via_view_manager_';
  this.d = data;
  this.d_RH = data_RH;
  this.d_LH = data_LH;
  this.va = view_annotator;
  this.c = container;

  this.view_selector_vid_list = [];
  var is_view_filtered_by_regex = false;

  // registers on_event(), emit_event(), ... methods from
  // _via_event to let this module listen and emit events
  _via_event.call( this );

  this.d.on_event('project_loaded', this._ID, this._on_event_project_loaded.bind(this));
  this.d.on_event('project_updated', this._ID, this._on_event_project_updated.bind(this));
  this.d.on_event('view_bulk_add', this._ID, this._on_event_view_bulk_add.bind(this));
  this.d.on_event('view_del', this._ID, this._on_event_view_del.bind(this));
  this.va.on_event('view_show', this._ID, this._on_event_view_show.bind(this));
  this.va.on_event('view_next', this._ID, this._on_event_view_next.bind(this));
  this.va.on_event('view_prev', this._ID, this._on_event_view_prev.bind(this));

  this._init_ui_elements();
}

_via_view_manager.prototype._init = function() {
  this._init_ui_elements();
  this._view_selector_update();
}

_via_view_manager.prototype._init_ui_elements = function() {
  this.pname = document.createElement('input');
  this.pname.setAttribute('type', 'text');
  this.pname.setAttribute('id', 'via_project_name_input');
  this.pname.setAttribute('value', this.d.store.project.pname);
  this.pname.setAttribute('title', 'Project Name (click to update)');
  this.pname.addEventListener('change', this._on_pname_change.bind(this));

  this.view_selector = document.createElement('select');
  this.view_selector.setAttribute('class', 'view_selector');
  this.view_selector.setAttribute('title', 'Select a file for annotation');
  this.view_selector.addEventListener('change', this._on_view_selector_change.bind(this));

  this.view_filter_regex = document.createElement('input');
  this.view_filter_regex.setAttribute('type', 'text');
  this.view_filter_regex.setAttribute('class', 'view_filter_regex');
  this.view_filter_regex.setAttribute('title', 'Filter file list');
  this.view_filter_regex.setAttribute('placeholder', 'Search');
  this.view_filter_regex.addEventListener('input', this._on_view_filter_regex_change.bind(this));

  this.c.innerHTML = '';
  this.c.appendChild(this.pname);
  this.c.appendChild(this.view_selector);
  this.c.appendChild(this.view_filter_regex);
}

//
// UI elements change listeners
//
_via_view_manager.prototype._on_pname_change = function(e) {
  this.d.store.project.pname = e.target.value.trim();
}

_via_view_manager.prototype._on_view_selector_change = function(e) {
  var vid = e.target.options[e.target.selectedIndex].value;
  if ( vid !== this.va.vid ) {
    this.va.view_show(vid);
  }
}

_via_view_manager.prototype._on_next_view = function() {
  if ( this.view_selector.options.length ) {
    var vid = this.view_selector.options[this.view_selector.selectedIndex].value;
    var vindex = this.view_selector_vid_list.indexOf(vid);
    if ( vindex !== -1 ) {
      var next_vindex = vindex + 1;
      if ( next_vindex >= this.view_selector_vid_list.length ) {
        next_vindex = 0;
      }
      this.va.view_show( this.view_selector_vid_list[next_vindex] );
    } else {
      _via_util_msg_show('Cannot move to next view!');
    }
  }
}

_via_view_manager.prototype._on_prev_view = function() {
  if ( this.view_selector.options.length ) {
    var vid = this.view_selector.options[this.view_selector.selectedIndex].value;
    var vindex = this.view_selector_vid_list.indexOf(vid);
    if ( vindex !== -1 ) {
      var prev_vindex = vindex - 1;
      if ( prev_vindex < 0 ) {
        prev_vindex = this.view_selector_vid_list.length - 1;
      }
      this.va.view_show( this.view_selector_vid_list[prev_vindex] );
    } else {
      _via_util_msg_show('Cannot move to next view!');
    }
  }
}

_via_view_manager.prototype._on_event_view_show = function(data, event_payload) {
  var vid = event_payload.vid.toString();
  this.view_selector.selectedIndex = -1;

  // ensure that the view selector shows the view being displayed
  var n = this.view_selector.options.length;
  for ( var i = 0; i < n; ++i ) {
    if ( this.view_selector.options[i].value === vid ) {
      this.view_selector.selectedIndex = i;
      break;
    }
  }
}

_via_view_manager.prototype._on_event_view_next = function(data, event_payload) {
  this._on_next_view();
}

_via_view_manager.prototype._on_event_view_prev = function(data, event_payload) {
  this._on_prev_view();
}

_via_view_manager.prototype._on_event_project_loaded = function(data, event_payload) {
  this._init_ui_elements();
  this._view_selector_update();
  if ( this.d.store.project.vid_list.length ) {
    // show first view by default
    this.va.view_show( this.d.store.project.vid_list[0] );
  }
}

_via_view_manager.prototype._on_event_project_updated = function(data, event_payload) {
  var current_vid = this.va.vid;
  this._init_ui_elements();
  this._view_selector_update();
  if ( this.d.store.project.vid_list.length ) {
    if ( current_vid in this.d.store.project.vid_list ) {
      this.va.view_show( current_vid );
    } else {
      // show first view by default
      this.va.view_show( this.d.store.project.vid_list[0] );
    }
  }
}

//
// View Selector
//
_via_view_manager.prototype._view_selector_clear = function() {
  this.view_selector.innerHTML = '';
  this.view_selector_vid_list = [];
}

_via_view_manager.prototype._view_selector_option_html = function(vindex, vid) {
  var oi = document.createElement('option');
  oi.setAttribute('value', vid);

  var file_count = this.d.store.view[vid].fid_list.length;
  var view_name;
  if ( file_count === 1 ) {
    var fid = this.d.store.view[vid].fid_list[0];
    view_name = this.d.store.file[fid].fname;
    oi.innerHTML = '[' + (parseInt(vindex)+1) + '] ' + decodeURI(view_name);
  } else {
    var filelist = [];
    var fid;
    for ( var findex in this.d.store.view[vid].fid_list ) {
      fid = this.d.store.view[vid].fid_list[findex];
      filelist.push(this.d.store.file[fid].fname);
    }
    oi.innerHTML = '[' + (parseInt(vindex)+1) + '] ' + filelist.join(', ');
  }
  return oi;
}

_via_view_manager.prototype._view_selector_update = function() {
  if ( this.is_view_filtered_by_regex ) {
    this._view_selector_update_regex();
  } else {
    this._view_selector_update_showall();
  }
}

_via_view_manager.prototype._view_selector_update_regex = function(regex) {
  if ( regex === '' ||
       typeof(regex) === 'undefined'
     ) {
    this._view_selector_update_showall();
  } else {
    var existing_vid = '';
    if ( this.view_selector.options.length ) {
      if ( this.view_selector.selectedIndex !== -1 ) {
        existing_vid = this.view_selector.options[this.view_selector.selectedIndex].value;
      }
    }
    this._view_selector_clear();
    var vid, fid;
    for ( var vindex in this.d.store.project.vid_list ) {
      vid = this.d.store.project.vid_list[vindex];
      for ( var findex in this.d.store.view[vid].fid_list ) {
        fid = this.d.store.view[vid].fid_list[findex];
        if ( this.d.store.file[fid].fname.match(regex) !== null ) {
          this.view_selector.appendChild( this._view_selector_option_html(vindex, vid) );
          this.view_selector_vid_list.push(vid);
          break;
        }
      }
    }
    this.is_view_selector_regex_active = true;
    var existing_vid_index = this.view_selector_vid_list.indexOf(existing_vid);
    if ( existing_vid_index === -1 ) {
      if ( this.view_selector_vid_list.length ) {
        this.va.view_show( this.view_selector_vid_list[0] );
      }
    } else {
      this.view_selector.selectedIndex = existing_vid_index;
    }
  }
}

_via_view_manager.prototype._view_selector_update_showall = function() {
  var existing_selectedIndex = this.view_selector.selectedIndex;
  var existing_vid;
  if ( existing_selectedIndex !== -1 ) {
    existing_vid = this.view_selector.options[existing_selectedIndex].value;
  }
  this._view_selector_clear();

  var vid;
  for ( var vindex in this.d.store.project.vid_list ) {
    vid = this.d.store.project.vid_list[vindex];
    this.view_selector.appendChild( this._view_selector_option_html(vindex, vid) );
    this.view_selector_vid_list.push(vid);
  }
  this.is_view_filtered_by_regex = false;
  if ( existing_selectedIndex !== -1 ) {
    var existing_vid_index = this.view_selector_vid_list.indexOf(existing_vid);
    if ( existing_vid_index === -1 ) {
      this.view_selector.selectedIndex = -1;
    } else {
      this.view_selector.selectedIndex = existing_vid_index;
    }
  }
}

_via_view_manager.prototype._on_view_filter_regex_change = function() {
  var regex = this.view_filter_regex.value;
  this._view_selector_update_regex(regex);
}

_via_view_manager.prototype._file_add_from_filelist = function(filelist) {
  this.d.view_bulk_add_from_filelist(filelist).then( function(ok) {
    var filetype_summary = {};
    var fid, ftype_str;
    for ( var findex in ok.fid_list ) {
      fid = ok.fid_list[findex];
      ftype_str = _via_util_file_type_to_str( this.d.store.file[fid].type );
      if ( ! filetype_summary.hasOwnProperty(ftype_str) ) {
        filetype_summary[ftype_str] = 0;
      }
      filetype_summary[ftype_str] = filetype_summary[ftype_str] + 1;
    }
    _via_util_msg_show('Added ' + ok.fid_list.length + ' files. ' + JSON.stringify(filetype_summary));
  }.bind(this), function(err) {
    _via_util_msg_show('Failed to add files! [' + err + ']');
    console.warn(err);
  }.bind(this));
  this.d_RH.store.view = this.d.store.view
  this.d_LH.store.view = this.d.store.view
}

_via_view_manager.prototype._on_add_media_local = function() {
  _via_util_file_select_local(_VIA_FILE_SELECT_TYPE.IMAGE | _VIA_FILE_SELECT_TYPE.VIDEO | _VIA_FILE_SELECT_TYPE.AUDIO,
                              this._file_add_local.bind(this),
                              true);
}

_via_view_manager.prototype._file_add_local = function(e) {
  var files = e.target.files;
  var filelist = [];
  for ( var findex = 0; findex < files.length; ++findex ) {
    filelist.push({ 'fname':files[findex].name,
                    'type':_via_util_infer_file_type_from_filename(files[findex].name),
                    'loc':_VIA_FILE_LOC.LOCAL,
                    'src':files[findex],
                  });
  }
  this._file_add_from_filelist(filelist);
}

_via_view_manager.prototype._on_event_view_bulk_add = function(data, event_payload) {
  this._view_selector_update();
  this.d._cache_update();
  this.d_RH._cache_update();
  this.d_LH._cache_update();
  if ( event_payload.vid_list.length ) {
    this.va.view_show( event_payload.vid_list[0] );
  }
}

_via_view_manager.prototype._on_add_media_remote = function() {
  var url = window.prompt('Enter URL of an image, audio or video (e.g. http://www....)',
                          '');
  var filelist = [ {'fname':url,
                    'type':_via_util_infer_file_type_from_filename(url),
                    'loc':_VIA_FILE_LOC.URIHTTP,
                    'src':url,
                   }
                 ];

  this._file_add_from_filelist(filelist);
}

_via_view_manager.prototype._on_add_media_bulk = function() {
  _via_util_file_select_local(_VIA_FILE_SELECT_TYPE.TEXT,
                              this._on_add_media_bulk_file_selected.bind(this), false);
}

_via_view_manager.prototype._on_add_media_bulk_file_selected = function(e) {
  if ( e.target.files.length ) {
    _via_util_load_text_file(e.target.files[0], this._on_add_media_bulk_file_load.bind(this));
  }
}

_via_view_manager.prototype._on_add_media_bulk_file_load = function(file_data) {
  var url_list = file_data.split('\n');
  if ( url_list.length ) {
    var filelist = [];
    for ( var i = 0; i < url_list.length; ++i ) {
      if ( url_list[i] === '' ||
           url_list[i] === ' ' ||
           url_list[i] === '\n'
         ) {
        continue; // skip
      }
      filelist.push({ 'fname':url_list[i],
                      'type':_via_util_infer_file_type_from_filename(url_list[i]),
                      'loc':_via_util_infer_file_loc_from_filename(url_list[i]),
                      'src':url_list[i],
                    });
    }
    this._file_add_from_filelist(filelist);
  }
}

_via_view_manager.prototype._on_del_view = function() {
  this.d.view_del(this.va.vid).then( function(ok) {
    _via_util_msg_show('Deleted view ' + ( parseInt(ok.vindex) + 1));
  }.bind(this), function(err) {
    console.warn(err);
  }.bind(this));
}

_via_view_manager.prototype._on_event_view_del = function(data, event_payload) {
  this._view_selector_update();
  var vindex = event_payload.vindex;
  if ( this.d.store.project.vid_list.length ) {
    if ( vindex < this.d.store.project.vid_list.length ) {
      this.va.view_show( this.d.store.project.vid_list[vindex] );
    } else {
      this.va.view_show( this.d.store.project.vid_list[ this.d.store.project.vid_list.length - 1 ] );
    }
  } else {
    this.va._init();
  }
}
</script>
<!-- END: Contents of file: ../../src/js/_via_view_manager.js-->

<!-- START: Contents of file: ../../src/js/_via_editor.js-->
<script>
/**
 * @class
 * @classdesc Editor for metadata and attributes
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @since 14 Jan. 2019
 */
function _via_editor(data, view_annotator, container) {
  this._ID = '_via_editor';
  this.d  = data;
  this.va = view_annotator;
  this.c  = container;

  // initialise event listeners
  this.d.on_event('file_show', this._ID, this.on_event_file_show.bind(this));
  this.d.on_event('metadata_add', this._ID, this.on_event_metadata_add.bind(this));
  this.d.on_event('metadata_del', this._ID, this.on_event_metadata_del.bind(this));
  this.d.on_event('attribute_update', this._ID, this.on_event_attribute_update.bind(this));
  this.d.on_event('attribute_del', this._ID, this.on_event_attribute_del.bind(this));
  this.d.on_event('attribute_add', this._ID, this.on_event_attribute_add.bind(this));
}

_via_editor.prototype.TYPE = { 'METADATA':2, 'ATTRIBUTE':3 };


_via_editor.prototype.toggle = function() {
  if ( this.c.classList.contains('hide') ) {
    this.show();
  } else {
    this.hide();
  }
}

_via_editor.prototype.hide = function() {
  this.c.innerHTML = '';
  this.c.classList.add('hide');
}
_via_editor.prototype.show = function() {
  this.c.classList.remove('hide');

  // top line: editor content selector {metadata, attribute}
  this.editor_content_selector = document.createElement('div');
  this.editor_content_selector.setAttribute('class', 'editor_content_selector');
  var title = document.createElement('span');
  title.innerHTML = 'Show: ';
  this.edit_metadata_checkbox = document.createElement('input');
  this.edit_metadata_checkbox.setAttribute('name', 'metadata');
  this.edit_metadata_checkbox.setAttribute('type', 'checkbox');
  this.edit_metadata_checkbox.addEventListener('change', this.on_editor_content_select.bind(this));
  var edit_metadata_label = document.createElement('label');
  edit_metadata_label.innerHTML = 'Metadata';
  edit_metadata_label.setAttribute('for', 'metadata');
  edit_metadata_label.setAttribute('title', 'Metadata corresponds to values assigned by user for the attributes.');

  this.edit_attribute_checkbox = document.createElement('input');
  this.edit_attribute_checkbox.setAttribute('name', 'attribute');
  this.edit_attribute_checkbox.setAttribute('type', 'checkbox');
  this.edit_attribute_checkbox.addEventListener('change', this.on_editor_content_select.bind(this));
  var edit_attribute_label = document.createElement('label');
  edit_attribute_label.innerHTML = 'Attribute';
  edit_attribute_label.setAttribute('for', 'attribute');
  edit_attribute_label.setAttribute('title', 'Attribute corresponds to fields like name, color, etc. required to describe the region of interest');

  this.editor_content_selector.appendChild(title);
  this.editor_content_selector.appendChild(this.edit_attribute_checkbox);
  this.editor_content_selector.appendChild(edit_attribute_label);
  this.editor_content_selector.appendChild(this.edit_metadata_checkbox);
  this.editor_content_selector.appendChild(edit_metadata_label);

  // toolbar
  var toolbar = document.createElement('div');
  toolbar.setAttribute('class', 'toolbar');
  var close_button = document.createElement('button');
  close_button.setAttribute('class', 'text_button');
  close_button.innerHTML = '&times;';
  close_button.addEventListener('click', this.toggle.bind(this));
  toolbar.appendChild(close_button);

  // metadata
  this.metadata_container = document.createElement('div');
  this.metadata_container.setAttribute('id', 'metadata_container');
  this.metadata_container.setAttribute('class', 'metadata_container');
  this.metadata_view = document.createElement('table');
  var metadata_title = document.createElement('h2');
  metadata_title.innerHTML = 'Metadata';
  this.metadata_container.appendChild( metadata_title );
  this.metadata_container.appendChild( this.metadata_view );

  // attribute
  this.attribute_container = document.createElement('div');
  this.attribute_container.setAttribute('id', 'attribute_container');
  this.attribute_container.setAttribute('class', 'attribute_container');
  this.attribute_view = document.createElement('table');
  var attribute_title = document.createElement('h2');
  attribute_title.innerHTML = 'Attributes';

  this.attribute_container.appendChild( attribute_title );
  this.attribute_container.appendChild( this.get_attribute_name_entry_panel() );
  this.attribute_container.appendChild( this.attribute_view );

  this.content_container = document.createElement('div');
  this.content_container.setAttribute('class', 'content_container');
  this.content_container.appendChild(this.attribute_container);
  this.content_container.appendChild(this.metadata_container);

  // add everything to container
  this.c.appendChild(toolbar);
  //this.c.appendChild(this.editor_content_selector);
  this.c.appendChild(this.content_container);

  this.attributes_update();
  //this.metadata_update();

  // initial state of content
  this.edit_metadata_checkbox.checked = true;
  this.metadata_container.classList.add('hide');
  this.edit_attribute_checkbox.checked = true;
  this.attribute_container.classList.remove('hide');
}

//
// Editor content selector
//
_via_editor.prototype.on_editor_content_select = function(selector) {
  var element;
  switch(selector.target.name) {
  case 'metadata':
    element = this.metadata_container;
    break;
  case 'attribute':
    element = this.attribute_container;
    break;
  }

  if ( selector.target.checked ) {
    element.classList.remove('hide');
  } else {
    element.classList.add('hide');
  }
}

//
// metadata
//
_via_editor.prototype.metadata_clear = function() {
  this.metadata_view.innerHTML = '';
}

_via_editor.prototype.metadata_update = function() {
  this.metadata_clear();

  if ( this.va.vid ) {
    // fetch all metadata associated with this.va.vid
    this.d._cache_update_mid_list();
    var metadata_count = this.d.cache.mid_list[this.va.vid].length;
    console.log(metadata_count)
    if ( metadata_count ) {
      // add header
      this.metadata_view.appendChild( this.get_metadata_header() );

      // add each metadata
      var tbody = document.createElement('tbody');
      var metadata_index = 1;
      var mid;
      for ( var mindex in this.d.cache.mid_list[this.va.vid] ) {
        mid = this.d.cache.mid_list[this.va.vid][mindex];
        tbody.appendChild( this.metadata_get(mid, metadata_index) );
        metadata_index = metadata_index + 1;
      }
      this.metadata_view.appendChild(tbody);
    } else {
      this.metadata_view.innerHTML = '<tr><td>No metadata added yet!</td></tr>';
    }
  } else {
    this.metadata_view.innerHTML = '<tr><td><i>No metadata added yet!</i></td></tr>';
  }
}

_via_editor.prototype.metadata_get = function(mid, metadata_index) {
  var tr = document.createElement('tr');
  tr.setAttribute('data-mid', mid);

  // column: the action tools for metadata (like delete)
  var action_tools_container = document.createElement('td');
  this.get_metadata_action_tools(action_tools_container, mid);
  tr.appendChild( action_tools_container );

  // column: index of this metadata
  var metadata_index_container = document.createElement('td');
  metadata_index_container.innerHTML = metadata_index;
  metadata_index_container.setAttribute('title', mid);
  tr.appendChild(metadata_index_container);

  // column: z (temporal coordinate)
  var tcoordinate = document.createElement('td');
  tcoordinate.innerHTML = this.d.store.metadata[mid].z.join(', ');
  tr.appendChild(tcoordinate);

  // column: xy (spatial coordinate)
  var scoordinate = document.createElement('td');
  scoordinate.innerHTML = this.d.store.metadata[mid].xy.join(', ');
  tr.appendChild(scoordinate);

  // subsequent columns: what (i.e. the attributes for this metadata)
  for ( var aid in this.d.store.attribute ) {
    var td = document.createElement('td');
    td.appendChild( this.get_attribute_html_element(mid, aid) );
    tr.appendChild(td);
  }

  return tr;
}

_via_editor.prototype.get_metadata_action_tools = function(container, mid) {
  var del = _via_util_get_svg_button('micon_delete', 'Delete Metadata');
  del.setAttribute('data-mid', mid);
  del.addEventListener('click', this.metadata_del.bind(this));
  container.appendChild(del);

  /*
  var edit = _via_util_get_svg_button('micon_edit', 'Select Metadata for Editing');
  edit.setAttribute('data-fid', fid);
  edit.setAttribute('data-mid', mid);
  edit.addEventListener('click', this.metadata_edit.bind(this));
  container.appendChild(edit);
  */
}

_via_editor.prototype.get_metadata_header = function() {
  var tr = document.createElement('tr');
  tr.appendChild( this.html_element('th', '') );
  tr.appendChild( this.html_element('th', '#') );
  tr.appendChild( this.html_element('th', 'Temporal Coordinate') );
  tr.appendChild( this.html_element('th', 'Spatial Coordinate') );

  for ( var aid in this.d.store.attribute ) {
    tr.appendChild( this.html_element('th',
                                      this.d.store.attribute[aid].aname)
                  );
  }

  var thead = document.createElement('thead');
  thead.appendChild(tr);
  return thead;
}

_via_editor.prototype.html_element = function(name, text) {
  var e = document.createElement(name);
  e.innerHTML = text;
  return e;
}

//
// Metadata preview
//

_via_editor.prototype.jump_to_metadata = function(e) {
  var fid = e.target.dataset.fid;
  var mid = e.target.dataset.mid;
  var where_index = e.target.dataset.where_index;
  if ( this.d.metadata_store[fid][mid].where_target() === _VIA_WHERE_TARGET.SEGMENT &&
       this.d.metadata_store[fid][mid].where_target() === _VIA_WHERE_SHAPE.TIME
     ) {
    this.a.preload[fid].media_annotator.media.currentTime = this.d.metadata_store[fid][mid].where[where_index];
  }
}

//
// attribute
//
_via_editor.prototype.attribute_clear = function() {
  this.attribute_view.innerHTML = '';
}

_via_editor.prototype.attributes_update = function() {
  if ( this.c.classList.contains('hide') ) {
    return;
  }

  this.attribute_clear();

  if ( Object.keys(this.d.store.attribute).length ) {
    this.attribute_view.appendChild( this.get_attribute_header() );

    // add each metadata
    var tbody = document.createElement('tbody');
    for ( var aid in this.d.store.attribute ) {
      tbody.appendChild( this.get_attribute(aid) );
    }
    this.attribute_view.appendChild(tbody);
  }
}

_via_editor.prototype.get_attribute_header = function() {
  var tr = document.createElement('tr');
  tr.appendChild( this.html_element('th', '') );
  tr.appendChild( this.html_element('th', 'Id') );
  tr.appendChild( this.html_element('th', 'Name') );
  tr.appendChild( this.html_element('th', 'Anchor') );
  tr.appendChild( this.html_element('th', 'Input Type') );
  tr.appendChild( this.html_element('th', 'Description') );
  tr.appendChild( this.html_element('th', 'Options') );
  tr.appendChild( this.html_element('th', 'Default Value') );
  tr.appendChild( this.html_element('th', 'Preview') );

  var thead = document.createElement('thead');
  thead.appendChild(tr);
  return thead;
}

_via_editor.prototype.get_attribute = function(aid) {
  var tr = document.createElement('tr');
  tr.setAttribute('data-aid', aid);

  // column: the action tools for metadata (like delete)
  var action_tools_container = document.createElement('td');
  this.get_attribute_action_tools(action_tools_container, aid);
  tr.appendChild( action_tools_container );

  // column: aid (i.e. attribute id)
  tr.appendChild( this.html_element('td', aid) );

  // column: name
  var aname_container = document.createElement('td');
  var aname = document.createElement('input');
  aname.setAttribute('type', 'text');
  aname.setAttribute('data-aid', aid);
  aname.setAttribute('data-varname', 'aname');
  aname.setAttribute('value', this.d.store.attribute[aid].aname);
  aname.addEventListener('change', this.attribute_on_change.bind(this));
  aname_container.appendChild(aname);
  tr.appendChild(aname_container);

  // column: anchor
  var anchor_select = document.createElement('select');
  anchor_select.setAttribute('data-aid', aid);
  anchor_select.setAttribute('data-varname', 'anchor_id');
  anchor_select.setAttribute('style', 'width:12em;');
  anchor_select.addEventListener('change', this.attribute_on_change.bind(this));
  var option_selected = false;
  for ( var anchor_id in _VIA_ATTRIBUTE_ANCHOR ) {
    if ( _VIA_ATTRIBUTE_ANCHOR[anchor_id] !== '__FUTURE__' ) {
      var oi = document.createElement('option');
      oi.setAttribute('value', anchor_id);
      oi.innerHTML = _VIA_ATTRIBUTE_ANCHOR[anchor_id];

      if ( anchor_id === this.d.store.attribute[aid].anchor_id ) {
        oi.setAttribute('selected', '');
        option_selected = true;
      }
      anchor_select.appendChild(oi);
    }
  }
  var anchor = document.createElement('td');
  anchor.appendChild( anchor_select );
  tr.appendChild( anchor );
  if ( ! option_selected ) {
    anchor_select.selectedIndex = -1;
  }

  // column: input type
  var type_select = document.createElement('select');
  type_select.setAttribute('data-aid', aid);
  type_select.setAttribute('data-varname', 'type');
  type_select.addEventListener('change', this.attribute_update_type.bind(this));
  var type_str;
  for ( type_str in _VIA_ATTRIBUTE_TYPE ) {
    var oi = document.createElement('option');
    oi.setAttribute('value', _VIA_ATTRIBUTE_TYPE[type_str]);
    oi.innerHTML = type_str;

    if ( _VIA_ATTRIBUTE_TYPE[type_str] === this.d.store.attribute[aid].type ) {
      oi.setAttribute('selected', '');
    }
    type_select.appendChild(oi);
  }
  var type = document.createElement('td');
  type.appendChild( type_select );
  tr.appendChild( type );

  // column: description
  var desc_container = document.createElement('td');
  var desc = document.createElement('input');
  desc.setAttribute('type', 'text');
  desc.setAttribute('data-aid', aid);
  desc.setAttribute('data-varname', 'desc');
  desc.setAttribute('value', this.d.store.attribute[aid].desc);
  desc.addEventListener('change', this.attribute_on_change.bind(this));
  desc_container.appendChild(desc);
  tr.appendChild( desc_container );

  // column: options
  if ( this.d.store.attribute[aid].type === _VIA_ATTRIBUTE_TYPE.TEXT ) {
    // text has no defaults
    tr.appendChild( this.html_element('td', '-') );
  } else {
    var option_input = document.createElement('textarea');
    option_input.setAttribute('data-aid', aid);
    option_input.setAttribute('data-varname', 'options');
    option_input.setAttribute('placeholder', 'e.g. a,*b,c,d');
    option_input.setAttribute('title', 'Enter options as comma separated value with the default option prefixed using an *. For example: "a,*b,c"');
    option_input.addEventListener('change', this.attribute_on_change.bind(this));
    option_input.innerHTML = _via_util_obj_to_csv(this.d.store.attribute[aid].options,
                                                  this.d.store.attribute[aid].default_option_id);
    tr.appendChild( option_input );
  }

  // column: default value (only if other than TEXT)
  if ( this.d.store.attribute[aid].type === _VIA_ATTRIBUTE_TYPE.TEXT ) {
    // text has no defaults
    tr.appendChild( this.html_element('td', '-') );
  } else {
    var default_value = this.d.store.attribute[aid].options[ this.d.store.attribute[aid].default_option_id ];
    if ( typeof(default_value) === 'undefined' ) {
      tr.appendChild( this.html_element('td', 'Not Defined') );
    } else {
      tr.appendChild( this.html_element('td', default_value) );
    }
  }

  // column: preview of attribute
  var preview = document.createElement('td');
  preview.appendChild( this.get_attribute_html_element(aid) );
  tr.appendChild(preview);

  return tr;
}

_via_editor.prototype.get_attribute_html_element = function(aid) {
  var dval  = this.d.store.attribute[aid].default_option_id;
  var atype = this.d.store.attribute[aid].type;
  var el;

  switch(atype) {
  case _VIA_ATTRIBUTE_TYPE.TEXT:
    el = document.createElement('textarea');
    break;

  case _VIA_ATTRIBUTE_TYPE.SELECT:
    el = document.createElement('select');

    for ( var oid in this.d.store.attribute[aid].options ) {
      var oi = document.createElement('option');
      oi.setAttribute('value', oid);
      oi.innerHTML = this.d.store.attribute[aid].options[oid];
      if ( oid === this.d.store.attribute[aid].default_option_id ) {
        oi.setAttribute('selected', 'true');
      }
      el.appendChild(oi);
    }
    break;

  case _VIA_ATTRIBUTE_TYPE.RADIO:
    el = document.createElement('div');

    for ( var oid in this.d.store.attribute[aid].options ) {
      var radio = document.createElement('input');
      radio.setAttribute('type', 'radio');
      radio.setAttribute('value', oid);
      radio.setAttribute('data-aid', aid);
      radio.setAttribute('name', this.d.store.attribute[aid].aname);
      if ( oid === this.d.store.attribute[aid].default_option_id ) {
        radio.setAttribute('checked', 'true');
      }

      var label = document.createElement('label');
      label.innerHTML = this.d.store.attribute[aid].options[oid];

      var br = document.createElement('br');
      el.appendChild(radio);
      el.appendChild(label);
      el.appendChild(br);
    }
    break;

  case _VIA_ATTRIBUTE_TYPE.CHECKBOX:
    el = document.createElement('div');

    for ( var oid in this.d.store.attribute[aid].options ) {
      var checkbox = document.createElement('input');
      checkbox.setAttribute('type', 'checkbox');
      checkbox.setAttribute('value', oid);
      checkbox.setAttribute('data-aid', aid);
      checkbox.setAttribute('name', this.d.store.attribute[aid].aname);
      if ( oid === this.d.store.attribute[aid].default_option_id ) {
        checkbox.setAttribute('checked', 'true');
      }

      var label = document.createElement('label');
      label.innerHTML = this.d.store.attribute[aid].options[oid];

      var br = document.createElement('br');
      el.appendChild(checkbox);
      el.appendChild(label);
      el.appendChild(br);
    }
    break;

  default:
    console.log('attribute type ' + atype + ' not implemented yet!');
    var el = document.createElement('span');
    el.innerHTML = aval;
  }
  el.setAttribute('data-aid', aid);
  return el;
}

_via_editor.prototype.get_attribute_name_entry_panel = function() {
  var c = document.createElement('div');
  c.setAttribute('class', 'attribute_entry');

  this.new_attribute_name_input = document.createElement('input');
  this.new_attribute_name_input.setAttribute('type', 'text');
  this.new_attribute_name_input.setAttribute('placeholder', 'name of new attribute');
  c.appendChild(this.new_attribute_name_input);

  var add = document.createElement('button');
  add.setAttribute('class', 'text-button');
  add.innerHTML = 'Create';
  add.addEventListener('click', this.on_attribute_create.bind(this));
  c.appendChild(add);

  return c;
}

_via_editor.prototype.get_attribute_action_tools = function(container, aid) {
  var del = _via_util_get_svg_button('micon_delete', 'Delete Attribute');
  del.setAttribute('data-aid', aid);
  del.addEventListener('click', this.attribute_del.bind(this));
  container.appendChild(del);
}

_via_editor.prototype.update_attribute_for = function(aid) {
  var tbody = this.attribute_view.getElementsByTagName('tbody')[0];
  var n = tbody.childNodes.length;
  var i;
  for ( i = 0; i < n; ++i ) {
    if ( tbody.childNodes[i].dataset.aid === aid ) {
      var new_attribute = this.get_attribute(aid);
      tbody.replaceChild( new_attribute, tbody.childNodes[i] );
      break;
    }
  }
}

_via_editor.prototype.attribute_on_change = function(e) {
  var varname = e.target.dataset.varname;
  var vartype = e.target.type;
  var aid = e.target.dataset.aid;

  switch(vartype) {
  case 'text':
    this.d.store.attribute[aid][varname] = e.target.value;
    break;
  case 'textarea':
    if ( varname === 'options' ) {
      var options_csv = e.target.value;
      this.d.attribute_update_options_from_csv(aid, options_csv).then(function(ok) {
      }.bind(this));
    }
    break;
  case 'select':
  case 'select-one':
    if ( varname === 'anchor_id' ) {
      var new_anchor_id = e.target.options[e.target.selectedIndex].value;
      this.d.attribute_update_anchor_id(aid, new_anchor_id);
    }
    break;
  default:
    console.warn('Unknown varname=' + varname + ', vartype=' + vartype);
  }

  this.attributes_update();
}

//
// Listeners for data update events
//
_via_editor.prototype.metadata_del = function(e) {
  var fid = e.currentTarget.dataset.fid;
  var mid = e.currentTarget.dataset.mid;
  this.d.metadata_del(fid, mid).then( function(ok) {
    // we don't need to do anything when metadata delete is successful
  }.bind(this), function(err) {
    console.log(err)
  }.bind(this));
}

_via_editor.prototype.metadata_edit = function(e) {
  var fid = e.target.parentNode.dataset.fid;
  var mid = e.target.parentNode.dataset.mid;
  console.log('@todo: edit metadata: fid=' + fid + ', mid=' + mid);
}

_via_editor.prototype.on_attribute_create = function(e) {
  var new_attribute_name = this.new_attribute_name_input.value;
  this.d.attribute_add(new_attribute_name,
                       _VIA_DEFAULT_ATTRIBUTE_ANCHOR_ID,
                       _VIA_ATTRIBUTE_TYPE.TEXT).then( function(ok) {
    this.attributes_update();
    // attribute was added
  }.bind(this), function(err) {
    console.log(err);
  }.bind(this));
}

_via_editor.prototype.attribute_del = function(e) {
  var aid = e.currentTarget.dataset.aid;
  this.d.attribute_del(aid).then( function(ok) {
    // we don't need to do anything when attribute delete is successful
  }.bind(this), function(err) {
    console.log(err)
  }.bind(this));
}

_via_editor.prototype.attribute_update_options = function(e) {
  var aid = e.target.dataset.aid;
  var new_options_csv = e.target.value;
  this.d.attribute_update_options(aid, new_options_csv);
}

_via_editor.prototype.attribute_update_type = function(e) {
  var aid = e.target.dataset.aid;
  var new_type = parseInt(e.target.options[ e.target.selectedIndex ].value);
  this.d.attribute_update_type(aid, new_type);
}

_via_editor.prototype.on_event_attribute_update = function(data, event_payload) {
  this.attributes_update();
}

_via_editor.prototype.on_event_attribute_del = function(data, event_payload) {
  this.attributes_update();
}

_via_editor.prototype.on_event_attribute_add = function(data, event_payload) {
  this.attributes_update();
}

_via_editor.prototype.on_event_metadata_add = function(data, event_payload) {
  //this.metadata_update();
}

_via_editor.prototype.on_event_metadata_del = function(data, event_payload) {
  //this.metadata_update();
}

_via_editor.prototype.on_event_file_show = function(data, event_payload) {
  //this.metadata_update();
}
</script>
<!-- END: Contents of file: ../../src/js/_via_editor.js-->
<!-- START: Contents of file: _via.js-->
<script>
/**
 *
 * @class
 * @classdesc VIA
 * @author Abhishek Dutta <adutta@robots.ox.ac.uk>
 * @date 12 May 2019
 *
 */

'use strict'

function _via(via_container) {
  this._ID = '_via';

  console.log('Initializing VGG Image Annotator (VIA) version ' + _VIA_VERSION)
  this.via_container = via_container;

  this.d  = new _via_data();
  this.d_RH  = new _via_data();
  this.d_LH  = new _via_data();

  this.SUBTITLE_AID = '1';
  // add new attribute for subtitle
  this.d['store']['attribute'][this.SUBTITLE_AID] = {'aname':'subtitle', 'anchor_id':'FILE1_Z2_XY0', 'type':1, 'desc':'Subtitle text', 'options':{}, 'default_option_id':'' };

  var conf = { 'ENDPOINT': _VIA_REMOTE_STORE };
  this.s  = new _via_share(this.d, conf);

  if ( typeof(_VIA_DEBUG) === 'undefined' || _VIA_DEBUG === true ) {
    // ADD DEBUG CODE HERE (IF NEEDED)
  }

  //// define the html containers
  this.control_panel_container = document.createElement('div');
  this.control_panel_container.setAttribute('id', 'via_control_panel_container');
  this.via_container.appendChild(this.control_panel_container);

  this.view_container = document.createElement('div');
  this.view_container.setAttribute('id', 'view_container');
  this.via_container.appendChild(this.view_container);

  this.editor_container = document.createElement('div');
  this.editor_container.setAttribute('id', 'editor_container');
  this.editor_container.classList.add('hide');
  this.via_container.appendChild(this.editor_container);

  this.message_container = document.createElement('div');
  this.message_container.setAttribute('id', '_via_message_container');
  this.message_container.setAttribute('class', 'message_container');
  this.message_container.addEventListener('click', _via_util_msg_hide);
  this.message_panel = document.createElement('div');
  this.message_panel.setAttribute('id', '_via_message');
  this.message_container.appendChild(this.message_panel);
  this.via_container.appendChild(this.message_container);

  //// initialise content creators and managers
  this.ie = new _via_import_export(this.d, this.d_RH, this.d_LH);

  this.va = new _via_view_annotator(this.d, this.view_container, this.d_RH, this.d_LH);
  this.editor = new _via_editor(this.d, this.va, this.editor_container);

  this.view_manager_container = document.createElement('div');
  this.vm = new _via_view_manager(this.d, this.va, this.view_manager_container, this.d_RH, this.d_LH);
  this.vm._init();

  // control panel shows the view_manager_container
  this.cp = new _via_control_panel(this.control_panel_container, this);
  this.cp._set_region_shape('RECTANGLE');

  // event handlers for buttons in the control panel
  this.cp.on_event('region_shape', this._ID, function(data, event_payload) {
    this.va.set_region_draw_shape(event_payload.shape);
  }.bind(this));
  this.cp.on_event('editor_toggle', this._ID, function(data, event_payload) {
    this.editor.toggle();
  }.bind(this));

  // keyboard event handlers
  //this.via_container.focus()
  //this.via_container.addEventListener('keydown', this._keydown_handler.bind(this));
  window.addEventListener('keydown', this._keydown_handler.bind(this)); // @todo: should be attached only to VIA application container

  // update VIA version number
  var el = document.getElementById('via_page_container');
  var pages = el.getElementsByClassName('via_page');
  var n = pages.length;
  for ( var i = 0; i < n; ++i ) {
    if ( pages[i].dataset.pageid === 'page_about' ) {
      var content0 = pages[i].innerHTML;
      pages[i].innerHTML = content0.replace('__VIA_VERSION__', _VIA_VERSION);
    }
  }

  // load any external modules (e.g. demo) which should be defined as follows
  // function _via_load_submodules()
  if (typeof _via_load_submodules === 'function') {
    console.log('VIA submodule detected, invoking _via_load_submodules()');
    this._load_submodule = new Promise( function(ok_callback, err_callback) {
      try {
        _via_load_submodules.call(this);
      }
      catch(err) {
        console.warn('VIA submodule load failed: ' + err);
        err_callback(err);
      }
    }.bind(this));
  } else {
    // debug code (disabled for release)
    if ( typeof(_VIA_DEBUG) === 'undefined' || _VIA_DEBUG === true ) {
      //this.s.pull('c42560da-d42e-44f2-af9b-04e4e1be7867'); // load shared project
      /*
      var line_split_regex = new RegExp('\n|\r|\r\n', 'g');
      var webvtt_lines = _via_dp[0]['subtitle_vtt'].split(line_split_regex);
      var mid = 1;
      var vid = '1';
      for(var i=0; i<webvtt_lines.length; ++i) {
        if(webvtt_lines[i].includes(' --> ')) {
          var timestamp_tokens = webvtt_lines[i].split(' --> ');
          var starttime_sec = _via_hh_mm_ss_ms_to_seconds(timestamp_tokens[0]);
          var endtime_sec = _via_hh_mm_ss_ms_to_seconds(timestamp_tokens[1]);
          _via_dp[0]['store']['metadata'][mid] = { 'vid': vid,
                                                   'flg':0,
                                                   'z':[starttime_sec, endtime_sec],
                                                   'xy':[],
                                                   'av':{
                                                     '1':webvtt_lines[i+1].trim(),
                                                   }
                                                 };
          mid = mid + 1;
        }
      }
      this.d.project_load_json(_via_dp[0]['store']); // video subtitle editor
      */
    }
  }

  // ready
  _via_util_msg_show(_VIA_NAME + ' (' + _VIA_NAME_SHORT + ') ' + _VIA_VERSION + ' ready.');
}

_via.prototype._hook_on_browser_resize = function() {
  if ( typeof(this.va.vid) !== 'undefined' ) {
    this.va.view_show(this.va.vid);
  }
}

_via.prototype._keydown_handler = function(e) {
  // avoid handling events when text input field is in focus
  if ( e.target.type !== 'text' &&
       e.target.type !== 'textarea'
     ) {
    this.va._on_event_keydown(e);
  }
}
</script>
<!-- END: Contents of file: _via.js-->

    <!-- DEMO SCRIPT AUTOMATICALLY INSERTED BY VIA PACKER SCRIPT -->

    <script>
      var _VIA_DEBUG = false;
      var via_container = document.getElementById('via_container');
      var via = new _via(via_container);
      ////__ENABLED_BY_DEMO_PACK_SCRIPT___via_util_page_show('page_demo_instructions');
    </script>
  </body>
</html>
